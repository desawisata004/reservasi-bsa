<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2e7d32">
    <meta name="description" content="Sistem Reservasi Kemah Keluarga Bukit Sampalan Asri - Online">
    <title>Reservasi Kemah Keluarga - Bukit Sampalan Asri</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --accent-color: #ff9800;
            --light-color: #f1f8e9;
            --dark-color: #1b5e20;
            --danger-color: #f44336;
            --warning-color: #ffc107;
            --success-color: #4caf50;
            --gray-color: #757575;
            --online-color: #4caf50;
            --offline-color: #f44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles - Mobile Friendly */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            margin-right: 10px;
        }
        
        .header-content h1 {
            font-size: 1.3rem;
            margin-bottom: 3px;
            line-height: 1.2;
        }
        
        .header-content p {
            opacity: 0.9;
            font-size: 0.75rem;
            display: none;
        }
        
        .auth-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .auth-container span {
            margin-right: 8px;
            font-size: 0.85rem;
        }
        
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 36px;
            min-width: 36px;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Online Status Indicator */
        .online-status {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
            margin-right: 10px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
            background-color: var(--offline-color);
        }
        
        .status-dot.online {
            background-color: var(--online-color);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 8px;
            margin-left: 10px;
            min-height: 36px;
            min-width: 36px;
        }
        
        nav {
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            flex-wrap: wrap;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        
        nav a:hover, nav a.active {
            background-color: var(--dark-color);
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            margin: 15px 0;
            gap: 15px;
        }
        
        .content-section {
            flex: 1;
            min-width: 280px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
        }
        
        .section-title i {
            margin-right: 8px;
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .card {
            background-color: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-3px);
        }
        
        .card-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .card-value {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .card-label {
            color: var(--gray-color);
            font-size: 0.8rem;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px !important;
            transition: border 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 150px;
        }
        
        /* Button Styles */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 44px;
            min-width: 44px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--dark-color);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--primary-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
            min-height: 36px;
        }
        
        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            margin-bottom: 1rem;
            scrollbar-width: thin;
        }
        
        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            min-width: 600px;
        }
        
        .table th, .table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
            vertical-align: middle;
        }
        
        .table th {
            background-color: var(--light-color);
            color: var(--dark-color);
            font-weight: 600;
            white-space: nowrap;
        }
        
        .table tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Lapak Visualization */
        .lapak-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            gap: 6px;
            margin-top: 15px;
        }
        
        .lapak-item {
            height: 55px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 0.85rem;
            min-height: 44px;
            min-width: 44px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .lapak-item:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .lapak-item .lapak-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            display: none;
            z-index: 10;
        }
        
        .lapak-item:hover .lapak-tooltip {
            display: block;
        }
        
        .lapak-tersedia {
            background-color: var(--success-color);
        }
        
        .lapak-terpakai {
            background-color: var(--danger-color);
        }
        
        .lapak-dipilih {
            background-color: var(--warning-color);
            transform: scale(1.03);
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }
        
        .lapak-item:hover {
            transform: scale(1.03);
        }
        
        /* Real-time Updates Badge */
        .real-time-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 8px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        
        /* Footer */
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 15px 0;
            margin-top: 25px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .footer-section {
            margin-bottom: 15px;
        }
        
        .footer-section h3 {
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .copyright {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 15px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* Tabs Styles */
        .tabs-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--light-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 0.85rem;
            flex-shrink: 0;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tab:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Visualisasi Grid */
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        
        .grid-item {
            height: 40px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.7rem;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }
            
            .header-content p {
                display: block;
            }
            
            nav ul {
                flex-direction: column;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                gap: 3px;
                margin-top: 8px;
            }
            
            nav ul.active {
                max-height: 500px;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .lapak-container {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
            
            .lapak-item {
                height: 50px;
            }
            
            .online-status {
                font-size: 0.7rem;
            }
        }
        
        @media (max-width: 576px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .lapak-container {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }
            
            .lapak-item {
                height: 45px;
            }
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        .alert {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: #333;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        /* Status Indicators */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-tersedia {
            background-color: var(--success-color);
        }
        
        .status-terpakai {
            background-color: var(--danger-color);
        }
        
        .status-dipilih {
            background-color: var(--warning-color);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 15px;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--gray-color);
            padding: 5px;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Login Styles */
        .login-container {
            max-width: 350px;
            margin: 60px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .login-logo i {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .login-logo h2 {
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        /* Akomodasi Styles */
        .akomodasi-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .akomodasi-item {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            background-color: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .akomodasi-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .akomodasi-item.selected {
            border-color: var(--primary-color);
            background-color: var(--light-color);
        }
        
        /* Payment Method */
        .payment-option {
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-option:hover {
            border-color: var(--primary-color);
        }
        
        .payment-option.selected {
            border-color: var(--primary-color);
            background-color: var(--light-color);
        }
        
        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 350px;
        }
        
        .notification.success { background-color: var(--success-color); }
        .notification.error { background-color: var(--danger-color); }
        .notification.warning { background-color: var(--warning-color); }
        .notification.info { background-color: var(--primary-color); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Scroll to top button */
        .scroll-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 99;
            display: none;
        }
        
        .scroll-top:hover {
            background-color: var(--dark-color);
        }
    </style>
</head>
<body>
    <!-- Scroll to top button -->
    <div class="scroll-top" onclick="scrollToTop()">
        <i class="fas fa-chevron-up"></i>
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container"></div>
    
    <!-- Loading Screen -->
    <div id="loading-screen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center;">
        <div class="spinner"></div>
        <p style="margin-top: 15px; color: var(--primary-color);">Memuat sistem...</p>
    </div>
    
    <!-- Login Screen -->
    <div id="login-screen" class="login-container" style="display: none;">
        <div class="login-logo">
            <i class="fas fa-campground"></i>
            <h2>Bukit Sampalan Asri</h2>
            <p>Sistem Reservasi Online</p>
            <small class="real-time-badge"><i class="fas fa-sync-alt"></i> Real-time</small>
        </div>
        
        <form id="login-form">
            <div class="form-group">
                <label for="username"><i class="fas fa-user"></i> Username</label>
                <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
            </div>
            
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
            </div>
            
            <div class="alert alert-danger hidden" id="login-error">
                <i class="fas fa-exclamation-circle"></i> Username atau password salah!
            </div>
            
            <button type="button" class="btn btn-primary btn-block" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
            
            <div class="text-center mt-3">
                <small>Belum punya akun? Hubungi admin untuk dibuatkan</small>
            </div>
        </form>
    </div>

    <!-- Main App -->
    <div id="main-app" style="display: none;">
        <header>
            <div class="container">
                <div class="header-top">
                    <div class="logo-container">
                        <div class="logo">
                            <i class="fas fa-campground"></i>
                        </div>
                        <div class="header-content">
                            <h1>Bukit Sampalan Asri <span class="real-time-badge"><i class="fas fa-sync-alt"></i> Online</span></h1>
                            <p>Sistem Reservasi Kemah Keluarga</p>
                        </div>
                        <button class="menu-toggle" onclick="toggleMobileMenu()">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                    
                    <div class="auth-container">
                        <div class="online-status">
                            <div class="status-dot" id="status-dot"></div>
                            <span id="status-text">Offline</span>
                        </div>
                        <div class="user-profile">
                            <div class="user-avatar" id="user-avatar">
                                A
                            </div>
                            <div>
                                <span id="current-user"></span>
                                <div id="user-role" style="font-size: 0.75rem; opacity: 0.9;"></div>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout()" title="Logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="logout-text">Keluar</span>
                        </button>
                    </div>
                </div>
                
                <nav>
                    <ul id="main-nav">
                        <li><a href="#" class="active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" onclick="showSection('reservasi')"><i class="fas fa-calendar-plus"></i> Reservasi</a></li>
                        <li><a href="#" onclick="showSection('lapak')"><i class="fas fa-map-marked-alt"></i> Status Lapak</a></li>
                        <li><a href="#" onclick="showSection('invoice')"><i class="fas fa-file-invoice-dollar"></i> Invoice</a></li>
                        <li><a href="#" onclick="showSection('laporan')"><i class="fas fa-chart-bar"></i> Laporan</a></li>
                        <li><a href="#" onclick="showSection('pengaturan')" class="admin-only"><i class="fas fa-cog"></i> Pengaturan</a></li>
                        <li><a href="#" onclick="showSection('users')" class="admin-only"><i class="fas fa-users"></i> Pengguna</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Dashboard Monitoring</h2>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-campground"></i>
                        </div>
                        <div class="card-value" id="lapak-tersedia">0</div>
                        <div class="card-label">Lapak Tersedia</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-campground"></i>
                        </div>
                        <div class="card-value" id="lapak-terpakai">0</div>
                        <div class="card-label">Lapak Terpakai</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div class="card-value" id="glamping-terpakai">0</div>
                        <div class="card-label">Glamping Terpakai</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-value" id="pengunjung-hari-ini">0</div>
                        <div class="card-label">Pengunjung Hari Ini</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="card-value" id="omzet-harian">Rp 0</div>
                        <div class="card-label">Omzet Harian</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="card-value" id="reservasi-bulan-ini">0</div>
                        <div class="card-label">Reservasi Bulan Ini</div>
                    </div>
                </div>

                <div class="form-row mb-3">
                    <div class="form-group" style="flex: 1;">
                        <label for="filter-tanggal"><i class="fas fa-calendar-day"></i> Filter Status Tanggal</label>
                        <input type="date" id="filter-tanggal" class="form-control" onchange="updateDashboard()">
                    </div>
                </div>

                <div class="content-section">
                    <h3 class="section-title"><i class="fas fa-campground"></i> Status Lapak Tenda Hari Ini</h3>
                    <div class="lapak-container" id="lapak-status-container">
                        </div>
                    <div class="mt-3">
                        <span class="status-indicator status-tersedia"></span> Tersedia
                        <span class="status-indicator status-terpakai ml-3"></span> Terpakai
                    </div>
                </div>

                <div class="content-section mt-3">
                    <h3 class="section-title"><i class="fas fa-home"></i> Status Glamping Hari Ini</h3>
                    <div class="lapak-container" id="glamping-status-container">
                        </div>
                </div>
            </section>

            <!-- Reservasi Section -->
            <section id="reservasi-section" class="content-section hidden">
                <h2 class="section-title"><i class="fas fa-calendar-plus"></i> Form Reservasi Baru</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Sistem real-time - perubahan langsung terlihat oleh semua staff.
                </div>
                
                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" onclick="changeReservasiTab(this, 'tenda')"><i class="fas fa-campground"></i> Lapak Tenda</div>
                        <div class="tab" onclick="changeReservasiTab(this, 'glamping')"><i class="fas fa-home"></i> Glamping</div>
                    </div>
                </div>

                <div id="tab-tenda" class="tab-content active">
                    <form id="reservasi-tenda-form">
                        <h4 class="section-title"><i class="fas fa-user"></i> Data Pemesan</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nama-tenda">Nama Pemesan</label>
                                <input type="text" id="nama-tenda" class="form-control" placeholder="Nama lengkap" required>
                            </div>
                            <div class="form-group">
                                <label for="telepon-tenda">Nomor Telepon/WA</label>
                                <input type="tel" id="telepon-tenda" class="form-control" placeholder="+62 8xx xxxx xxxx" required>
                            </div>
                        </div>

                        <h4 class="section-title mt-3"><i class="fas fa-calendar-check"></i> Detail Reservasi</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tanggal-checkin-tenda">Tanggal Check-in</label>
                                <input type="date" id="tanggal-checkin-tenda" class="form-control" required onchange="updateLapakStatus()">
                            </div>
                            <div class="form-group">
                                <label for="tanggal-checkout-tenda">Tanggal Check-out</label>
                                <input type="date" id="tanggal-checkout-tenda" class="form-control" required onchange="hitungJumlahMalam('tenda')">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="jumlah-malam-tenda">Jumlah Malam</label>
                                <input type="number" id="jumlah-malam-tenda" class="form-control" value="1" min="1" required onchange="hitungTotalBiayaTenda()">
                            </div>
                            <div class="form-group">
                                <label for="jumlah-orang-tenda">Jumlah Orang/Rombongan</label>
                                <input type="number" id="jumlah-orang-tenda" class="form-control" value="1" min="1" required onchange="hitungTotalBiayaTenda()">
                            </div>
                        </div>
                        
                        <h4 class="section-title mt-3"><i class="fas fa-map-pin"></i> Pilih Lapak Tenda</h4>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Status lapak real-time dari semua staff.
                        </div>
                        <div class="lapak-container" id="lapak-pilih-container">
                            </div>

                        <h4 class="section-title mt-3"><i class="fas fa-money-check-alt"></i> Metode Pembayaran</h4>
                        <div class="form-group">
                            <label>Pilih Metode Pembayaran</label>
                            <div class="payment-option selected" onclick="selectPaymentMethod('lokasi', 'tenda')">
                                <i class="fas fa-money-bill-wave"></i> Bayar di Lokasi
                            </div>
                            <div class="payment-option" onclick="selectPaymentMethod('transfer', 'tenda')">
                                <i class="fas fa-credit-card"></i> DP Transfer Bank
                            </div>
                        </div>

                        <h4 class="section-title mt-3"><i class="fas fa-calculator"></i> Rincian Biaya</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td>Biaya Lapak</td>
                                        <td class="text-right" id="biaya-lapak-tenda">Rp 0</td>
                                    </tr>
                                    <tr>
                                        <td>Tiket Masuk</td>
                                        <td class="text-right" id="biaya-tiket-tenda">Rp 0</td>
                                    </tr>
                                    <tr>
                                        <td><strong>TOTAL BIAYA</strong></td>
                                        <td class="text-right"><strong id="total-biaya-tenda">Rp 0</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-primary btn-block" onclick="submitReservasi('tenda')">
                                <i class="fas fa-save"></i> Proses Reservasi
                            </button>
                        </div>
                    </form>
                </div>

                <div id="tab-glamping" class="tab-content">
                    <form id="reservasi-glamping-form">
                        <h4 class="section-title"><i class="fas fa-user"></i> Data Pemesan</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nama-glamping">Nama Pemesan</label>
                                <input type="text" id="nama-glamping" class="form-control" placeholder="Nama lengkap" required>
                            </div>
                            <div class="form-group">
                                <label for="telepon-glamping">Nomor Telepon/WA</label>
                                <input type="tel" id="telepon-glamping" class="form-control" placeholder="+62 8xx xxxx xxxx" required>
                            </div>
                        </div>

                        <h4 class="section-title mt-3"><i class="fas fa-calendar-check"></i> Detail Reservasi</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tanggal-checkin-glamping">Tanggal Check-in</label>
                                <input type="date" id="tanggal-checkin-glamping" class="form-control" required onchange="updateGlampingStatus()">
                            </div>
                            <div class="form-group">
                                <label for="tanggal-checkout-glamping">Tanggal Check-out</label>
                                <input type="date" id="tanggal-checkout-glamping" class="form-control" required onchange="hitungJumlahMalam('glamping')">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="jumlah-malam-glamping">Jumlah Malam</label>
                                <input type="number" id="jumlah-malam-glamping" class="form-control" value="1" min="1" required onchange="hitungTotalBiayaGlamping()">
                            </div>
                            <div class="form-group">
                                <label for="jumlah-orang-glamping">Jumlah Orang/Rombongan</label>
                                <input type="number" id="jumlah-orang-glamping" class="form-control" value="1" min="1" required onchange="hitungTotalBiayaGlamping()">
                            </div>
                        </div>

                        <h4 class="section-title mt-3"><i class="fas fa-map-pin"></i> Pilih Glamping</h4>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Status glamping real-time dari semua staff.
                        </div>
                        <div class="lapak-container" id="glamping-pilih-container">
                            </div>

                        <h4 class="section-title mt-3"><i class="fas fa-money-check-alt"></i> Metode Pembayaran</h4>
                        <div class="form-group">
                            <label>Pilih Metode Pembayaran</label>
                            <div class="payment-option selected" onclick="selectPaymentMethod('lokasi', 'glamping')">
                                <i class="fas fa-money-bill-wave"></i> Bayar di Lokasi
                            </div>
                            <div class="payment-option" onclick="selectPaymentMethod('transfer', 'glamping')">
                                <i class="fas fa-credit-card"></i> DP Transfer Bank
                            </div>
                        </div>
                        
                        <h4 class="section-title mt-3"><i class="fas fa-calculator"></i> Rincian Biaya</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td>Biaya Glamping</td>
                                        <td class="text-right" id="biaya-glamping">Rp 0</td>
                                    </tr>
                                    <tr>
                                        <td>Tiket Masuk</td>
                                        <td class="text-right" id="biaya-tiket-glamping">Rp 0</td>
                                    </tr>
                                    <tr>
                                        <td><strong>TOTAL BIAYA</strong></td>
                                        <td class="text-right"><strong id="total-biaya-glamping">Rp 0</strong></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary btn-block" onclick="submitReservasi('glamping')">
                                <i class="fas fa-save"></i> Proses Reservasi
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Lapak Section -->
            <section id="lapak-section" class="content-section hidden">
                <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Visualisasi Status Lapak/Glamping</h2>
                <div class="alert alert-info">
                    <i class="fas fa-sync-alt"></i> Data real-time dari semua staff.
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="tanggal-visualisasi"><i class="fas fa-calendar-day"></i> Filter Tanggal</label>
                        <input type="date" id="tanggal-visualisasi" class="form-control" onchange="updateLapakVisualization()">
                    </div>
                </div>

                <div class="tabs-container mt-3">
                    <div class="tabs">
                        <div class="tab active" onclick="changeVisualizationTab(this, 'lapak-tenda-vis')"><i class="fas fa-campground"></i> Lapak Tenda</div>
                        <div class="tab" onclick="changeVisualizationTab(this, 'glamping-vis')"><i class="fas fa-home"></i> Glamping</div>
                    </div>
                </div>

                <div id="lapak-tenda-vis" class="tab-content active">
                    <div class="visualization-grid" id="visualization-lapak">
                        </div>
                </div>

                <div id="glamping-vis" class="tab-content">
                    <div class="visualization-grid" id="visualization-glamping">
                        </div>
                </div>

                <div class="mt-3">
                    <span class="status-indicator status-tersedia"></span> Tersedia
                    <span class="status-indicator status-terpakai ml-3"></span> Terpakai
                </div>

                <h3 class="section-title mt-3"><i class="fas fa-list-alt"></i> Detail Reservasi Aktif</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Jenis</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Nama Pemesan</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="lapak-reservasi-list">
                            </tbody>
                    </table>
                </div>
            </section>

            <!-- Invoice Section -->
            <section id="invoice-section" class="content-section hidden">
                <h2 class="section-title"><i class="fas fa-file-invoice-dollar"></i> Daftar Invoice Reservasi</h2>
                <div class="alert alert-info">
                    <i class="fas fa-sync-alt"></i> Perubahan invoice real-time untuk semua staff.
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cari-invoice">Cari Invoice/Nama/Telepon</label>
                        <input type="text" id="cari-invoice" class="form-control" placeholder="Masukkan kata kunci..." oninput="cariInvoice()">
                    </div>
                    <div class="form-group">
                        <label for="filter-status">Filter Status</label>
                        <select id="filter-status" class="form-control" onchange="cariInvoice()">
                            <option value="">Semua Status</option>
                            <option value="pending">Pending</option>
                            <option value="dibayar">Dibayar</option>
                            <option value="aktif">Aktif</option>
                            <option value="selesai">Selesai</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive mt-3">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Nama Pemesan</th>
                                <th>Jenis</th>
                                <th>Total Biaya</th>
                                <th>Status</th>
                                <th>Tgl Reservasi</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-list">
                            </tbody>
                    </table>
                </div>
            </section>

            <!-- Laporan Section -->
            <section id="laporan-section" class="content-section hidden">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> Laporan dan Statistik</h2>
                
                <div class="form-group">
                    <label for="periode-laporan">Periode Laporan</label>
                    <select id="periode-laporan" class="form-control" onchange="toggleTanggalKustom()">
                        <option value="hari_ini">Hari Ini</option>
                        <option value="bulan_ini" selected>Bulan Ini</option>
                        <option value="bulan_lalu">Bulan Lalu</option>
                        <option value="tahun_ini">Tahun Ini</option>
                        <option value="kustom">Kustom</option>
                    </select>
                </div>

                <div class="form-row hidden" id="periode-kustom-inputs">
                    <div class="form-group">
                        <label for="tanggal-mulai">Tanggal Mulai</label>
                        <input type="date" id="tanggal-mulai" class="form-control">
                    </div>
                    <div class="form-group">
                        <label for="tanggal-selesai">Tanggal Selesai</label>
                        <input type="date" id="tanggal-selesai" class="form-control">
                    </div>
                </div>

                <div class="dashboard-cards mt-3">
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-file-invoice"></i></div>
                        <div class="card-value" id="laporan-total-reservasi">0</div>
                        <div class="card-label">Total Reservasi</div>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-campground"></i></div>
                        <div class="card-value" id="laporan-lapak-terjual">0</div>
                        <div class="card-label">Total Lapak Terjual</div>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-home"></i></div>
                        <div class="card-value" id="laporan-glamping-terjual">0</div>
                        <div class="card-label">Total Glamping Terjual</div>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-users"></i></div>
                        <div class="card-value" id="laporan-total-pengunjung">0</div>
                        <div class="card-label">Total Pengunjung</div>
                    </div>
                    <div class="card">
                        <div class="card-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="card-value" id="laporan-total-omzet">Rp 0</div>
                        <div class="card-label">Total Omzet</div>
                    </div>
                </div>

                <h3 class="section-title mt-3"><i class="fas fa-list-alt"></i> Detail Transaksi</h3>
                <div class="text-right mb-3">
                    <button class="btn btn-primary" onclick="generateLaporanPDF()">
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Tgl Reservasi</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Nama Pemesan</th>
                                <th>Jenis</th>
                                <th>Total Biaya</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="laporan-detail">
                            </tbody>
                    </table>
                </div>
            </section>

            <!-- Pengaturan Section -->
            <section id="pengaturan-section" class="content-section hidden admin-only">
                <h2 class="section-title"><i class="fas fa-cog"></i> Pengaturan Sistem</h2>
                <div class="alert alert-warning admin-only">
                    <i class="fas fa-exclamation-triangle"></i> Hanya dapat diakses oleh Admin.
                </div>

                <h3 class="section-title"><i class="fas fa-dollar-sign"></i> Pengaturan Harga</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="harga-tiket">Harga Tiket Masuk/Orang/Malam (Rp)</label>
                        <input type="number" id="harga-tiket" class="form-control" min="0" required>
                    </div>
                    <div class="form-group">
                        <label for="dp-percentage">Persentase DP (%)</label>
                        <input type="number" id="dp-percentage" class="form-control" min="0" max="100" required>
                    </div>
                </div>

                <h3 class="section-title mt-3"><i class="fas fa-university"></i> Informasi Bank</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nama-bank">Nama Bank</label>
                        <input type="text" id="nama-bank" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="nomor-rekening">Nomor Rekening</label>
                        <input type="text" id="nomor-rekening" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="an-rekening">Atas Nama Rekening</label>
                        <input type="text" id="an-rekening" class="form-control" required>
                    </div>
                </div>

                <button class="btn btn-primary btn-block mt-3" onclick="simpanPengaturan()">
                    <i class="fas fa-save"></i> Simpan Pengaturan
                </button>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="content-section hidden admin-only">
                <h2 class="section-title"><i class="fas fa-users"></i> Manajemen Pengguna</h2>
                
                <h3 class="section-title"><i class="fas fa-user-plus"></i> Tambah Pengguna Baru</h3>
                <form id="tambah-user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-nama">Nama Lengkap</label>
                            <input type="text" id="new-nama" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-username">Username</label>
                            <input type="text" id="new-username" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-password">Password</label>
                            <input type="password" id="new-password" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-role">Role</label>
                            <select id="new-role" class="form-control" required>
                                <option value="staff">Staff</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-secondary mt-2">
                        <i class="fas fa-user-plus"></i> Tambah Pengguna
                    </button>
                </form>

                <h3 class="section-title mt-3"><i class="fas fa-users-cog"></i> Daftar Pengguna</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="users-list">
                            </tbody>
                    </table>
                </div>
            </section>
        </div>

        <!-- MODAL INVOICE -->
        <div id="invoice-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-receipt"></i> Detail Invoice</h5>
                    <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
                </div>
                <div id="invoice-detail-content">
                    </div>
                <div class="modal-footer mt-3">
                    <button class="btn btn-secondary" onclick="printInvoiceToPDF()">
                        <i class="fas fa-print"></i> Cetak PDF
                    </button>
                    <button class="btn btn-danger" id="btn-batalkan-invoice" onclick="batalkanReservasi()">
                        <i class="fas fa-times-circle"></i> Batalkan
                    </button>
                    <button class="btn btn-success" id="btn-checkin-invoice" onclick="checkInReservasi()">
                        <i class="fas fa-sign-in-alt"></i> Check-in
                    </button>
                    <button class="btn btn-primary" id="btn-checkout-invoice" onclick="checkOutReservasi()">
                        <i class="fas fa-sign-out-alt"></i> Check-out
                    </button>
                    <button class="btn btn-warning" id="btn-update-pembayaran" onclick="updatePembayaran()">
                        <i class="fas fa-money-check-alt"></i> Update Bayar
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <div class="container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h3>Bukit Sampalan Asri</h3>
                        <p>Sistem Reservasi Online</p>
                        <p><i class="fas fa-sync-alt"></i> Real-time Database</p>
                    </div>
                    <div class="footer-section">
                        <h3>Status Sistem</h3>
                        <p id="system-status">Memuat...</p>
                        <p id="last-sync">Terakhir sinkron: -</p>
                    </div>
                    <div class="footer-section">
                        <h3>Versi</h3>
                        <p>Online v2.0</p>
                        <p>Powered by Firebase</p>
                    </div>
                </div>
                <div class="copyright">
                    &copy; 2025 Bukit Sampalan Asri. All rights reserved.
                </div>
            </div>
        </footer>
    </div>
    
    <script>
        // ===============================
        // FIREBASE CONFIGURATION
        // ===============================
        // HARAP GANTI DENGAN KONFIGURASI FIREBASE ANDA SENDIRI
        // Dapatkan dari Firebase Console  Project Settings  General
        const firebaseConfig = {
            apiKey: "AIzaSyALzmkMAaJEwZO04OMAZaaWfcLBjYU2GCM",
            authDomain: "reservasi-kemah-bsa.firebaseapp.com",
            databaseURL: "https://reservasi-kemah-bsa-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "reservasi-kemah-bsa",
            storageBucket: "reservasi-kemah-bsa.firebasestorage.app",
            messagingSenderId: "883193001958",
            appId: "1:883193001958:web:9aa40ce72e83e0ac32c827"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        // ===============================
        // GLOBAL VARIABLES
        // ===============================
        let currentUser = null;
        let appData = {
            reservasi: [],
            invoice: [],
            lapakTenda: [],
            glamping: [],
            pengaturan: {},
            users: []
        };
        
        let selectedLapak = [];
        let selectedGlamping = [];

        // ===============================
        // UTILITY FUNCTIONS
        // ===============================
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function formatDate(date) {
            const d = new Date(date);
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }
        
        function formatDateID(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('id-ID', options);
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div style="display: flex; align-items: center;">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                    <span style="margin-left: 10px;">${message}</span>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 5000);
        }

        function showLoading(message = 'Memuat...') {
            document.getElementById('loading-screen').style.display = 'flex';
            if (message) {
                document.querySelector('#loading-screen p').textContent = message;
            }
        }

        function hideLoading() {
            document.getElementById('loading-screen').style.display = 'none';
        }

        // ===============================
        // FIREBASE DATA FUNCTIONS
        // ===============================
        async function loadData() {
            try {
                showLoading('Memuat data dari server...');
                
                // Load all data from Firebase
                const snapshot = await database.ref('/').once('value');
                const data = snapshot.val();
                
                if (data) {
                    appData.reservasi = data.reservasi || [];
                    appData.invoice = data.invoice || [];
                    appData.lapakTenda = data.lapakTenda || [];
                    appData.glamping = data.glamping || [];
                    appData.pengaturan = data.pengaturan || {};
                    appData.users = data.users || [];
                }
                
                // Initialize default data if empty
                if (appData.lapakTenda.length === 0) {
                    await initializeDefaultData();
                }
                
                // Update system status
                updateSystemStatus('Data berhasil dimuat', true);
                hideLoading();
                
                return true;
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Gagal memuat data dari server', 'error');
                updateSystemStatus('Gagal memuat data', false);
                hideLoading();
                return false;
            }
        }

        async function initializeDefaultData() {
            // Default lapak tenda
            const defaultLapak = [];
            for (let i = 1; i <= 30; i++) {
                defaultLapak.push({
                    kode: 'L' + i.toString().padStart(2, '0'),
                    harga: 50000,
                    kapasitas: 4,
                    status: 'tersedia'
                });
            }
            
            // Default glamping
            const defaultGlamping = [
                { kode: 'G01', nama: 'Glamping Standard', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G02', nama: 'Glamping Standard', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G03', nama: 'Glamping Deluxe', harga: 200000, kapasitas: 6, status: 'tersedia' },
                { kode: 'G04', nama: 'Glamping Deluxe', harga: 200000, kapasitas: 6, status: 'tersedia' }
            ];
            
            // Default pengaturan
            const defaultPengaturan = {
                perusahaan: {
                    nama: "Bukit Sampalan Asri",
                    alamat: "Sukamaju, Cihaurbeuti, Ciamis",
                    hargaTiket: 15000,
                    namaBank: "Bank BRI",
                    norek: "4045-0100-1680-532",
                    anRekening: "SUNARYA",
                    noLayanan: "+62812-9639-2270",
                },
                dpPercentage: 50,
                jamCheckin: "14:00",
                jamCheckout: "12:00",
                minReservasiHari: 1,
                maxReservasiHari: 7
            };
            
            // Default users
            const defaultUsers = [
                { 
                    id: 1, 
                    nama: 'Admin Utama', 
                    username: 'admin', 
                    password: 'admin123', 
                    role: 'admin',
                    createdAt: new Date().toISOString()
                },
                { 
                    id: 2, 
                    nama: 'Staff Reservasi', 
                    username: 'staff', 
                    password: 'staff123', 
                    role: 'staff',
                    createdAt: new Date().toISOString()
                }
            ];
            
            // Save to Firebase
            await database.ref('/').set({
                lapakTenda: defaultLapak,
                glamping: defaultGlamping,
                pengaturan: defaultPengaturan,
                users: defaultUsers,
                reservasi: [],
                invoice: []
            });
            
            // Update local data
            appData.lapakTenda = defaultLapak;
            appData.glamping = defaultGlamping;
            appData.pengaturan = defaultPengaturan;
            appData.users = defaultUsers;
            
            showNotification('Data default berhasil diinisialisasi', 'success');
        }

        async function saveData(path, data) {
            try {
                await database.ref(path).set(data);
                return true;
            } catch (error) {
                console.error('Error saving data:', error);
                showNotification('Gagal menyimpan data', 'error');
                return false;
            }
        }

        // ===============================
        // AUTHENTICATION
        // ===============================
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');

            if (!username || !password) {
                errorElement.textContent = 'Harap isi username dan password!';
                errorElement.classList.remove('hidden');
                return;
            }

            try {
                showLoading('Memverifikasi...');
                
                // Find user in database
                const user = appData.users.find(u => u.username === username && u.password === password);
                
                if (user) {
                    // Create Firebase auth user (simplified - in production use Firebase Auth properly)
                    currentUser = user;
                    
                    // Hide login, show main app
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('main-app').style.display = 'block';
                    
                    // Initialize app
                    initializeApp();
                    showNotification(`Login berhasil! Selamat datang ${user.nama}`, 'success');
                    
                    // Update user status in Firebase
                    await database.ref(`users/${user.id}/lastLogin`).set(new Date().toISOString());
                    
                    // Setup real-time listeners
                    setupRealtimeListeners();
                    
                } else {
                    errorElement.textContent = 'Username atau password salah!';
                    errorElement.classList.remove('hidden');
                    showNotification('Login gagal', 'error');
                }
                
                hideLoading();
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Terjadi kesalahan saat login', 'error');
                hideLoading();
            }
        }

        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                currentUser = null;
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('login-form').reset();
                showNotification('Anda telah logout', 'info');
                
                // Remove real-time listeners
                removeRealtimeListeners();
            }
        }

        // ===============================
        // REAL-TIME LISTENERS
        // ===============================
        let listeners = [];

        function setupRealtimeListeners() {
            // Listen for reservations
            const reservasiRef = database.ref('reservasi');
            listeners.push(
                reservasiRef.on('value', (snapshot) => {
                    appData.reservasi = snapshot.val() || [];
                    if (!document.getElementById('dashboard-section').classList.contains('hidden')) {
                        updateDashboard();
                    }
                    if (!document.getElementById('lapak-section').classList.contains('hidden')) {
                        updateLapakVisualization();
                    }
                })
            );

            // Listen for invoices
            const invoiceRef = database.ref('invoice');
            listeners.push(
                invoiceRef.on('value', (snapshot) => {
                    appData.invoice = snapshot.val() || [];
                    if (!document.getElementById('invoice-section').classList.contains('hidden')) {
                        generateInvoiceList();
                    }
                    updateDashboard();
                })
            );

            // Listen for settings
            const settingsRef = database.ref('pengaturan');
            listeners.push(
                settingsRef.on('value', (snapshot) => {
                    appData.pengaturan = snapshot.val() || {};
                    updateSystemStatus('Data terbaru tersedia', true);
                    document.getElementById('last-sync').textContent = 
                        `Terakhir sinkron: ${new Date().toLocaleTimeString('id-ID')}`;
                })
            );

            // Update online status
            updateOnlineStatus(true);
        }

        function removeRealtimeListeners() {
            listeners.forEach(ref => ref());
            listeners = [];
            updateOnlineStatus(false);
        }

        function updateOnlineStatus(isOnline) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            if (isOnline) {
                dot.className = 'status-dot online';
                text.textContent = 'Online';
            } else {
                dot.className = 'status-dot';
                text.textContent = 'Offline';
            }
        }

        function updateSystemStatus(message, isGood = true) {
            const statusEl = document.getElementById('system-status');
            statusEl.textContent = message;
            statusEl.style.color = isGood ? 'var(--success-color)' : 'var(--danger-color)';
        }

        // ===============================
        // APP INITIALIZATION
        // ===============================
        function initializeApp() {
            if (!currentUser) return;

            // Set user info
            document.getElementById('current-user').textContent = currentUser.nama;
            document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'Admin' : 'Staff';
            document.getElementById('user-avatar').textContent = currentUser.nama.charAt(0).toUpperCase();
            document.getElementById('user-avatar').style.backgroundColor = 
                currentUser.role === 'admin' ? '#9c27b0' : '#2196f3';

            // Show/hide admin sections
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
            });

            // Set today's date
            const today = formatDate(new Date());
            document.getElementById('filter-tanggal').value = today;
            document.getElementById('tanggal-visualisasi').value = today;
            
            // Set default reservation dates
            const tomorrow = formatDate(new Date(Date.now() + 86400000));
            document.getElementById('tanggal-checkin-tenda').value = today;
            document.getElementById('tanggal-checkout-tenda').value = tomorrow;
            document.getElementById('tanggal-checkin-glamping').value = today;
            document.getElementById('tanggal-checkout-glamping').value = tomorrow;

            // Show dashboard
            showSection('dashboard');
            
            // Load pengaturan to form
            loadPengaturanToForm();
            
            // Update footer info
            updateFooterInfo();
        }

        function loadPengaturanToForm() {
            const p = appData.pengaturan.perusahaan || {};
            document.getElementById('harga-tiket').value = p.hargaTiket || 15000;
            document.getElementById('dp-percentage').value = appData.pengaturan.dpPercentage || 50;
            document.getElementById('nama-bank').value = p.namaBank || '';
            document.getElementById('nomor-rekening').value = p.norek || '';
            document.getElementById('an-rekening').value = p.anRekening || '';
        }

        function updateFooterInfo() {
            const p = appData.pengaturan.perusahaan || {};
            document.getElementById('system-status').textContent = 'Sistem online - real-time';
        }

        // ===============================
        // UI FUNCTIONS
        // ===============================
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionId + '-section').classList.remove('hidden');
            
            // Update active nav
            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            const activeNav = document.querySelector(`nav a[onclick="showSection('${sectionId}')"]`);
            if (activeNav) activeNav.classList.add('active');
            
            // Close mobile menu
            document.getElementById('main-nav').classList.remove('active');
            
            // Load section-specific data
            if (sectionId === 'dashboard') {
                updateDashboard();
            } else if (sectionId === 'reservasi') {
                updateLapakStatus();
                updateGlampingStatus();
            } else if (sectionId === 'lapak') {
                updateLapakVisualization();
            } else if (sectionId === 'invoice') {
                generateInvoiceList();
            } else if (sectionId === 'laporan') {
                filterLaporan();
            } else if (sectionId === 'users') {
                generateUsersList();
            }
        }

        function toggleMobileMenu() {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('active');
        }

        // ===============================
        // DASHBOARD FUNCTIONS
        // ===============================
        function updateDashboard() {
            const today = document.getElementById('filter-tanggal').value || formatDate(new Date());
            
            // Calculate statistics
            let lapakTerpakai = 0;
            let glampingTerpakai = 0;
            let pengunjungHariIni = 0;
            let omzetHarian = 0;
            let reservasiBulanIni = 0;
            
            // Count active reservations for selected date
            appData.reservasi.forEach(r => {
                if (r.tanggalCheckin <= today && r.tanggalCheckout > today && 
                    (r.status === 'aktif' || r.status === 'dibayar')) {
                    if (r.jenis === 'tenda') {
                        lapakTerpakai += r.lapak ? r.lapak.length : 0;
                    } else {
                        glampingTerpakai += r.glamping ? r.glamping.length : 0;
                    }
                    pengunjungHariIni += r.jumlahOrang || 0;
                }
            });
            
            // Count omzet for today
            appData.invoice.forEach(inv => {
                if (inv.tanggalReservasi === today && inv.status !== 'dibatalkan') {
                    omzetHarian += inv.totalBiaya || 0;
                }
            });
            
            // Count reservations this month
            const startOfMonth = formatDate(new Date(new Date().getFullYear(), new Date().getMonth(), 1));
            reservasiBulanIni = appData.reservasi.filter(r => 
                r.tanggalReservasi >= startOfMonth
            ).length;
            
            // Update dashboard cards
            document.getElementById('lapak-tersedia').textContent = 
                appData.lapakTenda.length - lapakTerpakai;
            document.getElementById('lapak-terpakai').textContent = lapakTerpakai;
            document.getElementById('glamping-terpakai').textContent = glampingTerpakai;
            document.getElementById('pengunjung-hari-ini').textContent = pengunjungHariIni;
            document.getElementById('omzet-harian').textContent = formatRupiah(omzetHarian);
            document.getElementById('reservasi-bulan-ini').textContent = reservasiBulanIni;
            
            // Update lapak status visualization
            updateLapakStatusVisualization(today);
        }

        function updateLapakStatusVisualization(date) {
            const lapakContainer = document.getElementById('lapak-status-container');
            const glampingContainer = document.getElementById('glamping-status-container');
            
            if (!lapakContainer || !glampingContainer) return;
            
            // Get reserved lapak for the date
            const reservedLapak = [];
            const reservedGlamping = [];
            
            appData.reservasi.forEach(r => {
                if (r.tanggalCheckin <= date && r.tanggalCheckout > date && 
                    (r.status === 'aktif' || r.status === 'dibayar')) {
                    if (r.jenis === 'tenda' && r.lapak) {
                        reservedLapak.push(...r.lapak);
                    } else if (r.glamping) {
                        reservedGlamping.push(...r.glamping);
                    }
                }
            });
            
            // Update lapak display
            lapakContainer.innerHTML = '';
            appData.lapakTenda.forEach(lapak => {
                const isReserved = reservedLapak.includes(lapak.kode);
                const item = document.createElement('div');
                item.className = `lapak-item ${isReserved ? 'lapak-terpakai' : 'lapak-tersedia'}`;
                item.textContent = lapak.kode;
                lapakContainer.appendChild(item);
            });
            
            // Update glamping display
            glampingContainer.innerHTML = '';
            appData.glamping.forEach(glamping => {
                const isReserved = reservedGlamping.includes(glamping.kode);
                const item = document.createElement('div');
                item.className = `lapak-item ${isReserved ? 'lapak-terpakai' : 'lapak-tersedia'}`;
                item.textContent = glamping.kode;
                glampingContainer.appendChild(item);
            });
        }

        // ===============================
        // RESERVATION FUNCTIONS
        // ===============================
        function changeReservasiTab(tabElement, target) {
            // Update tabs
            document.querySelectorAll('#reservasi-section .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#reservasi-section .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            tabElement.classList.add('active');
            document.getElementById(`tab-${target}`).classList.add('active');
            
            // Update status for selected type
            if (target === 'tenda') {
                updateLapakStatus();
            } else {
                updateGlampingStatus();
            }
        }

        function updateLapakStatus() {
            const date = document.getElementById('tanggal-checkin-tenda').value;
            const container = document.getElementById('lapak-pilih-container');
            
            if (!date || !container) return;
            
            // Get reserved lapak for the date
            const reservedLapak = [];
            appData.reservasi.forEach(r => {
                if (r.tanggalCheckin <= date && r.tanggalCheckout > date && 
                    (r.status === 'aktif' || r.status === 'dibayar') && r.jenis === 'tenda') {
                    if (r.lapak) {
                        reservedLapak.push(...r.lapak);
                    }
                }
            });
            
            // Clear and rebuild lapak selection
            container.innerHTML = '';
            selectedLapak = [];
            
            appData.lapakTenda.forEach(lapak => {
                const isReserved = reservedLapak.includes(lapak.kode);
                const isSelected = selectedLapak.includes(lapak.kode);
                
                const item = document.createElement('div');
                item.className = `lapak-item ${isReserved ? 'lapak-terpakai' : (isSelected ? 'lapak-dipilih' : 'lapak-tersedia')}`;
                item.textContent = lapak.kode;
                item.title = isReserved ? 'Sudah terpakai' : `Harga: ${formatRupiah(lapak.harga)}/malam`;
                
                if (!isReserved) {
                    item.onclick = () => toggleLapakSelection(lapak.kode);
                }
                
                container.appendChild(item);
            });
            
            hitungTotalBiayaTenda();
        }

        function updateGlampingStatus() {
            const date = document.getElementById('tanggal-checkin-glamping').value;
            const container = document.getElementById('glamping-pilih-container');
            
            if (!date || !container) return;
            
            // Get reserved glamping for the date
            const reservedGlamping = [];
            appData.reservasi.forEach(r => {
                if (r.tanggalCheckin <= date && r.tanggalCheckout > date && 
                    (r.status === 'aktif' || r.status === 'dibayar') && r.jenis === 'glamping') {
                    if (r.glamping) {
                        reservedGlamping.push(...r.glamping);
                    }
                }
            });
            
            // Clear and rebuild glamping selection
            container.innerHTML = '';
            selectedGlamping = [];
            
            appData.glamping.forEach(glamping => {
                const isReserved = reservedGlamping.includes(glamping.kode);
                const isSelected = selectedGlamping.includes(glamping.kode);
                
                const item = document.createElement('div');
                item.className = `lapak-item ${isReserved ? 'lapak-terpakai' : (isSelected ? 'lapak-dipilih' : 'lapak-tersedia')}`;
                item.textContent = glamping.kode;
                item.title = isReserved ? 'Sudah terpakai' : `${glamping.nama} - ${formatRupiah(glamping.harga)}/malam`;
                
                if (!isReserved) {
                    item.onclick = () => toggleGlampingSelection(glamping.kode);
                }
                
                container.appendChild(item);
            });
            
            hitungTotalBiayaGlamping();
        }

        function toggleLapakSelection(kode) {
            const index = selectedLapak.indexOf(kode);
            if (index === -1) {
                selectedLapak.push(kode);
            } else {
                selectedLapak.splice(index, 1);
            }
            updateLapakStatus();
        }

        function toggleGlampingSelection(kode) {
            const index = selectedGlamping.indexOf(kode);
            if (index === -1) {
                selectedGlamping.push(kode);
            } else {
                selectedGlamping.splice(index, 1);
            }
            updateGlampingStatus();
        }

        function hitungJumlahMalam(jenis) {
            const checkinId = `tanggal-checkin-${jenis}`;
            const checkoutId = `tanggal-checkout-${jenis}`;
            const malamId = `jumlah-malam-${jenis}`;
            
            const checkin = new Date(document.getElementById(checkinId).value);
            const checkout = new Date(document.getElementById(checkoutId).value);
            
            if (checkin && checkout && checkout > checkin) {
                const diffTime = checkout.getTime() - checkin.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                document.getElementById(malamId).value = diffDays;
            } else {
                document.getElementById(malamId).value = 1;
            }
            
            if (jenis === 'tenda') {
                hitungTotalBiayaTenda();
            } else {
                hitungTotalBiayaGlamping();
            }
        }

        function selectPaymentMethod(method, jenis) {
            const options = document.querySelectorAll(`#reservasi-${jenis}-form .payment-option`);
            options.forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.payment-option').classList.add('selected');
            
            if (jenis === 'tenda') {
                hitungTotalBiayaTenda();
            } else {
                hitungTotalBiayaGlamping();
            }
        }

        function hitungTotalBiayaTenda() {
            const jumlahMalam = parseInt(document.getElementById('jumlah-malam-tenda').value) || 1;
            const jumlahOrang = parseInt(document.getElementById('jumlah-orang-tenda').value) || 1;
            const hargaTiket = appData.pengaturan.perusahaan?.hargaTiket || 15000;
            
            // Calculate lapak cost
            let totalLapak = 0;
            selectedLapak.forEach(kode => {
                const lapak = appData.lapakTenda.find(l => l.kode === kode);
                if (lapak) {
                    totalLapak += lapak.harga * jumlahMalam;
                }
            });
            
            // Calculate ticket cost
            const totalTiket = jumlahOrang * jumlahMalam * hargaTiket;
            
            // Get DP percentage
            const dpPercentage = appData.pengaturan.dpPercentage || 50;
            const totalBiaya = totalLapak + totalTiket;
            const dp = totalBiaya * (dpPercentage / 100);
            
            // Update display
            document.getElementById('biaya-lapak-tenda').textContent = formatRupiah(totalLapak);
            document.getElementById('biaya-tiket-tenda').textContent = formatRupiah(totalTiket);
            document.getElementById('total-biaya-tenda').textContent = formatRupiah(totalBiaya);
        }

        function hitungTotalBiayaGlamping() {
            const jumlahMalam = parseInt(document.getElementById('jumlah-malam-glamping').value) || 1;
            const jumlahOrang = parseInt(document.getElementById('jumlah-orang-glamping').value) || 1;
            const hargaTiket = appData.pengaturan.perusahaan?.hargaTiket || 15000;
            
            // Calculate glamping cost
            let totalGlamping = 0;
            selectedGlamping.forEach(kode => {
                const glamping = appData.glamping.find(g => g.kode === kode);
                if (glamping) {
                    totalGlamping += glamping.harga * jumlahMalam;
                }
            });
            
            // Calculate ticket cost
            const totalTiket = jumlahOrang * jumlahMalam * hargaTiket;
            
            // Get DP percentage
            const dpPercentage = appData.pengaturan.dpPercentage || 50;
            const totalBiaya = totalGlamping + totalTiket;
            const dp = totalBiaya * (dpPercentage / 100);
            
            // Update display
            document.getElementById('biaya-glamping').textContent = formatRupiah(totalGlamping);
            document.getElementById('biaya-tiket-glamping').textContent = formatRupiah(totalTiket);
            document.getElementById('total-biaya-glamping').textContent = formatRupiah(totalBiaya);
        }

        async function submitReservasi(jenis) {
            // Validate form
            const namaField = `nama-${jenis}`;
            const teleponField = `telepon-${jenis}`;
            const tanggalCheckinField = `tanggal-checkin-${jenis}`;
            const tanggalCheckoutField = `tanggal-checkout-${jenis}`;
            
            const nama = document.getElementById(namaField).value.trim();
            const telepon = document.getElementById(teleponField).value.trim();
            const tanggalCheckin = document.getElementById(tanggalCheckinField).value;
            const tanggalCheckout = document.getElementById(tanggalCheckoutField).value;
            
            if (!nama || !telepon || !tanggalCheckin || !tanggalCheckout) {
                showNotification('Harap lengkapi semua field yang wajib diisi', 'warning');
                return;
            }
            
            if (jenis === 'tenda' && selectedLapak.length === 0) {
                showNotification('Harap pilih minimal 1 lapak tenda', 'warning');
                return;
            }
            
            if (jenis === 'glamping' && selectedGlamping.length === 0) {
                showNotification('Harap pilih minimal 1 glamping', 'warning');
                return;
            }
            
            try {
                showLoading('Menyimpan reservasi...');
                
                // Generate invoice number
                const now = new Date();
                const invoiceNumber = `INV-${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}-${Math.random().toString(36).substr(2, 5).toUpperCase()}`;
                
                // Calculate total cost
                const jumlahMalam = parseInt(document.getElementById(`jumlah-malam-${jenis}`).value) || 1;
                const jumlahOrang = parseInt(document.getElementById(`jumlah-orang-${jenis}`).value) || 1;
                const hargaTiket = appData.pengaturan.perusahaan?.hargaTiket || 15000;
                
                let totalBiaya = 0;
                if (jenis === 'tenda') {
                    selectedLapak.forEach(kode => {
                        const lapak = appData.lapakTenda.find(l => l.kode === kode);
                        if (lapak) totalBiaya += lapak.harga * jumlahMalam;
                    });
                } else {
                    selectedGlamping.forEach(kode => {
                        const glamping = appData.glamping.find(g => g.kode === kode);
                        if (glamping) totalBiaya += glamping.harga * jumlahMalam;
                    });
                }
                totalBiaya += jumlahOrang * jumlahMalam * hargaTiket;
                
                // Determine payment method and status
                const paymentMethod = document.querySelector(`#reservasi-${jenis}-form .payment-option.selected`).textContent.includes('Transfer') ? 'transfer' : 'lokasi';
                const dpPercentage = appData.pengaturan.dpPercentage || 50;
                const dp = paymentMethod === 'transfer' ? totalBiaya * (dpPercentage / 100) : 0;
                const status = paymentMethod === 'transfer' ? 'pending' : 'aktif';
                
                // Create reservation object
                const newReservasi = {
                    id: Date.now(),
                    invoice: invoiceNumber,
                    jenis: jenis,
                    tanggalReservasi: formatDate(new Date()),
                    tanggalCheckin: tanggalCheckin,
                    tanggalCheckout: tanggalCheckout,
                    jumlahMalam: jumlahMalam,
                    jumlahOrang: jumlahOrang,
                    lapak: jenis === 'tenda' ? selectedLapak : [],
                    glamping: jenis === 'glamping' ? selectedGlamping : [],
                    nama: nama,
                    telepon: telepon,
                    status: status,
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                // Create invoice object
                const newInvoice = {
                    id: Date.now(),
                    invoice: invoiceNumber,
                    jenis: jenis,
                    tanggalReservasi: formatDate(new Date()),
                    nama: nama,
                    telepon: telepon,
                    tanggalCheckin: tanggalCheckin,
                    tanggalCheckout: tanggalCheckout,
                    jumlahMalam: jumlahMalam,
                    jumlahOrang: jumlahOrang,
                    totalBiaya: totalBiaya,
                    dp: dp,
                    sisaPembayaran: totalBiaya - dp,
                    status: status,
                    paymentMethod: paymentMethod,
                    createdBy: currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                // Save to Firebase
                const reservasiRef = database.ref('reservasi');
                const invoiceRef = database.ref('invoice');
                
                const newReservasiKey = reservasiRef.push().key;
                const newInvoiceKey = invoiceRef.push().key;
                
                await database.ref(`reservasi/${newReservasiKey}`).set(newReservasi);
                await database.ref(`invoice/${newInvoiceKey}`).set(newInvoice);
                
                // Reset form
                document.getElementById(`reservasi-${jenis}-form`).reset();
                selectedLapak = [];
                selectedGlamping = [];
                
                // Update status displays
                updateLapakStatus();
                updateGlampingStatus();
                
                showNotification(`Reservasi ${invoiceNumber} berhasil dibuat!`, 'success');
                hideLoading();
                
                // Show invoice modal
                showInvoiceModal(invoiceNumber);
                
            } catch (error) {
                console.error('Error submitting reservation:', error);
                showNotification('Gagal menyimpan reservasi', 'error');
                hideLoading();
            }
        }

        // ===============================
        // INVOICE FUNCTIONS
        // ===============================
        function generateInvoiceList() {
            const tbody = document.getElementById('invoice-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const searchTerm = document.getElementById('cari-invoice').value.toLowerCase();
            const filterStatus = document.getElementById('filter-status').value;
            
            // Filter invoices
            let filteredInvoices = [...appData.invoice];
            
            if (searchTerm) {
                filteredInvoices = filteredInvoices.filter(inv => 
                    inv.invoice.toLowerCase().includes(searchTerm) ||
                    inv.nama.toLowerCase().includes(searchTerm) ||
                    inv.telepon.includes(searchTerm)
                );
            }
            
            if (filterStatus) {
                filteredInvoices = filteredInvoices.filter(inv => inv.status === filterStatus);
            }
            
            // Sort by date (newest first)
            filteredInvoices.sort((a, b) => new Date(b.tanggalReservasi) - new Date(a.tanggalReservasi));
            
            // Generate rows
            filteredInvoices.forEach(invoice => {
                const row = document.createElement('tr');
                
                let statusBadge = '';
                if (invoice.status === 'pending') {
                    statusBadge = '<span class="badge badge-warning">Pending</span>';
                } else if (invoice.status === 'dibayar') {
                    statusBadge = '<span class="badge badge-primary">Dibayar</span>';
                } else if (invoice.status === 'aktif') {
                    statusBadge = '<span class="badge badge-success">Aktif</span>';
                } else if (invoice.status === 'selesai') {
                    statusBadge = '<span class="badge badge-secondary">Selesai</span>';
                } else if (invoice.status === 'dibatalkan') {
                    statusBadge = '<span class="badge badge-danger">Dibatalkan</span>';
                }
                
                row.innerHTML = `
                    <td>${invoice.invoice}</td>
                    <td>${invoice.nama}</td>
                    <td>${invoice.jenis}</td>
                    <td>${formatRupiah(invoice.totalBiaya)}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDateID(invoice.tanggalReservasi)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="showInvoiceModal('${invoice.invoice}')">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function cariInvoice() {
            generateInvoiceList();
        }

        function showInvoiceModal(invoiceNumber) {
            const invoice = appData.invoice.find(inv => inv.invoice === invoiceNumber);
            if (!invoice) return;
            
            const reservasi = appData.reservasi.find(r => r.invoice === invoiceNumber);
            
            // Generate invoice HTML
            let invoiceHTML = `
                <div class="invoice">
                    <div class="invoice-header">
                        <h2>${appData.pengaturan.perusahaan?.nama || 'Bukit Sampalan Asri'}</h2>
                        <p>Invoice: <strong>${invoice.invoice}</strong></p>
                    </div>
                    
                    <div class="invoice-details">
                        <div class="form-row">
                            <div class="form-group">
                                <p><strong>Tanggal Reservasi:</strong> ${formatDateID(invoice.tanggalReservasi)}</p>
                                <p><strong>Nama Pemesan:</strong> ${invoice.nama}</p>
                                <p><strong>Telepon:</strong> ${invoice.telepon}</p>
                            </div>
                            <div class="form-group">
                                <p><strong>Check-in:</strong> ${formatDateID(invoice.tanggalCheckin)} ${appData.pengaturan.jamCheckin || '14:00'}</p>
                                <p><strong>Check-out:</strong> ${formatDateID(invoice.tanggalCheckout)} ${appData.pengaturan.jamCheckout || '12:00'}</p>
                                <p><strong>Jumlah Malam:</strong> ${invoice.jumlahMalam} malam</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="invoice-items">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Deskripsi</th>
                                    <th>Jumlah</th>
                                    <th>Harga</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>`;
            
            // Add items based on reservation type
            if (invoice.jenis === 'tenda' && reservasi?.lapak) {
                const lapakPrice = appData.lapakTenda.find(l => l.kode === reservasi.lapak[0])?.harga || 0;
                invoiceHTML += `
                    <tr>
                        <td>Lapak Tenda (${reservasi.lapak.join(', ')})</td>
                        <td>${invoice.jumlahMalam} malam</td>
                        <td>${formatRupiah(lapakPrice)}/malam</td>
                        <td>${formatRupiah(lapakPrice * reservasi.lapak.length * invoice.jumlahMalam)}</td>
                    </tr>`;
            } else if (reservasi?.glamping) {
                reservasi.glamping.forEach(kode => {
                    const glamping = appData.glamping.find(g => g.kode === kode);
                    if (glamping) {
                        invoiceHTML += `
                            <tr>
                                <td>${glamping.nama} (${kode})</td>
                                <td>${invoice.jumlahMalam} malam</td>
                                <td>${formatRupiah(glamping.harga)}/malam</td>
                                <td>${formatRupiah(glamping.harga * invoice.jumlahMalam)}</td>
                            </tr>`;
                    }
                });
            }
            
            // Add ticket cost
            const hargaTiket = appData.pengaturan.perusahaan?.hargaTiket || 15000;
            invoiceHTML += `
                <tr>
                    <td>Tiket Masuk (${invoice.jumlahOrang} orang)</td>
                    <td>${invoice.jumlahMalam} malam</td>
                    <td>${formatRupiah(hargaTiket)}/orang/malam</td>
                    <td>${formatRupiah(hargaTiket * invoice.jumlahOrang * invoice.jumlahMalam)}</td>
                </tr>
            `;
            
            // Add totals
            invoiceHTML += `
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>TOTAL BIAYA</strong></td>
                                    <td><strong>${formatRupiah(invoice.totalBiaya)}</strong></td>
                                </tr>`;
            
            if (invoice.paymentMethod === 'transfer') {
                invoiceHTML += `
                                <tr>
                                    <td colspan="3"><strong>DP (${appData.pengaturan.dpPercentage || 50}%)</strong></td>
                                    <td><strong>${formatRupiah(invoice.dp)}</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="3"><strong>SISA PEMBAYARAN</strong></td>
                                    <td><strong>${formatRupiah(invoice.sisaPembayaran)}</strong></td>
                                </tr>`;
            }
            
            invoiceHTML += `
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="invoice-status">
                        <p><strong>Status:</strong> ${invoice.status.toUpperCase()}</p>
                        <p><strong>Metode Pembayaran:</strong> ${invoice.paymentMethod === 'transfer' ? 'Transfer Bank' : 'Bayar di Lokasi'}</p>
                    </div>
                </div>
            `;
            
            // Set modal content
            document.getElementById('invoice-detail-content').innerHTML = invoiceHTML;
            
            // Show/hide buttons based on status
            const batalkanBtn = document.getElementById('btn-batalkan-invoice');
            const checkinBtn = document.getElementById('btn-checkin-invoice');
            const checkoutBtn = document.getElementById('btn-checkout-invoice');
            const updateBayarBtn = document.getElementById('btn-update-pembayaran');
            
            batalkanBtn.style.display = invoice.status === 'pending' || invoice.status === 'dibayar' ? 'block' : 'none';
            checkinBtn.style.display = invoice.status === 'dibayar' || invoice.status === 'pending' ? 'block' : 'none';
            checkoutBtn.style.display = invoice.status === 'aktif' ? 'block' : 'none';
            updateBayarBtn.style.display = invoice.status === 'pending' || invoice.status === 'dibayar' ? 'block' : 'none';
            
            // Show modal
            document.getElementById('invoice-modal').style.display = 'flex';
        }

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
        }

        async function updatePembayaran() {
            const invoiceNumber = document.querySelector('#invoice-detail-content .invoice-header strong').textContent;
            const invoice = appData.invoice.find(inv => inv.invoice === invoiceNumber);
            
            if (!invoice) return;
            
            if (confirm(`Update pembayaran untuk invoice ${invoiceNumber}?`)) {
                try {
                    showLoading('Memperbarui status pembayaran...');
                    
                    // Find invoice key in Firebase
                    const invoiceRef = database.ref('invoice');
                    const snapshot = await invoiceRef.once('value');
                    const invoices = snapshot.val();
                    
                    let invoiceKey = null;
                    for (const key in invoices) {
                        if (invoices[key].invoice === invoiceNumber) {
                            invoiceKey = key;
                            break;
                        }
                    }
                    
                    if (invoiceKey) {
                        // Update invoice status
                        await database.ref(`invoice/${invoiceKey}`).update({
                            status: 'dibayar',
                            sisaPembayaran: 0,
                            dp: invoice.totalBiaya
                        });
                        
                        // Update reservation status
                        const reservasiRef = database.ref('reservasi');
                        const reservasiSnapshot = await reservasiRef.once('value');
                        const reservasis = reservasiSnapshot.val();
                        
                        let reservasiKey = null;
                        for (const key in reservasis) {
                            if (reservasis[key].invoice === invoiceNumber) {
                                reservasiKey = key;
                                break;
                            }
                        }
                        
                        if (reservasiKey) {
                            await database.ref(`reservasi/${reservasiKey}`).update({
                                status: 'dibayar'
                            });
                        }
                        
                        showNotification('Status pembayaran berhasil diperbarui', 'success');
                        closeInvoiceModal();
                    }
                    
                    hideLoading();
                } catch (error) {
                    console.error('Error updating payment:', error);
                    showNotification('Gagal memperbarui status pembayaran', 'error');
                    hideLoading();
                }
            }
        }

        async function checkInReservasi() {
            const invoiceNumber = document.querySelector('#invoice-detail-content .invoice-header strong').textContent;
            
            if (confirm(`Konfirmasi check-in untuk invoice ${invoiceNumber}?`)) {
                try {
                    showLoading('Memproses check-in...');
                    
                    // Find and update in Firebase
                    const invoiceRef = database.ref('invoice');
                    const snapshot = await invoiceRef.once('value');
                    const invoices = snapshot.val();
                    
                    let invoiceKey = null;
                    for (const key in invoices) {
                        if (invoices[key].invoice === invoiceNumber) {
                            invoiceKey = key;
                            break;
                        }
                    }
                    
                    if (invoiceKey) {
                        await database.ref(`invoice/${invoiceKey}`).update({
                            status: 'aktif'
                        });
                        
                        // Update reservation
                        const reservasiRef = database.ref('reservasi');
                        const reservasiSnapshot = await reservasiRef.once('value');
                        const reservasis = reservasiSnapshot.val();
                        
                        let reservasiKey = null;
                        for (const key in reservasis) {
                            if (reservasis[key].invoice === invoiceNumber) {
                                reservasiKey = key;
                                break;
                            }
                        }
                        
                        if (reservasiKey) {
                            await database.ref(`reservasi/${reservasiKey}`).update({
                                status: 'aktif'
                            });
                        }
                        
                        showNotification('Check-in berhasil diproses', 'success');
                        closeInvoiceModal();
                    }
                    
                    hideLoading();
                } catch (error) {
                    console.error('Error checking in:', error);
                    showNotification('Gagal memproses check-in', 'error');
                    hideLoading();
                }
            }
        }

        async function checkOutReservasi() {
            const invoiceNumber = document.querySelector('#invoice-detail-content .invoice-header strong').textContent;
            
            if (confirm(`Konfirmasi check-out untuk invoice ${invoiceNumber}?`)) {
                try {
                    showLoading('Memproses check-out...');
                    
                    // Find and update in Firebase
                    const invoiceRef = database.ref('invoice');
                    const snapshot = await invoiceRef.once('value');
                    const invoices = snapshot.val();
                    
                    let invoiceKey = null;
                    for (const key in invoices) {
                        if (invoices[key].invoice === invoiceNumber) {
                            invoiceKey = key;
                            break;
                        }
                    }
                    
                    if (invoiceKey) {
                        await database.ref(`invoice/${invoiceKey}`).update({
                            status: 'selesai',
                            tanggalSelesai: formatDate(new Date())
                        });
                        
                        // Update reservation
                        const reservasiRef = database.ref('reservasi');
                        const reservasiSnapshot = await reservasiRef.once('value');
                        const reservasis = reservasiSnapshot.val();
                        
                        let reservasiKey = null;
                        for (const key in reservasis) {
                            if (reservasis[key].invoice === invoiceNumber) {
                                reservasiKey = key;
                                break;
                            }
                        }
                        
                        if (reservasiKey) {
                            await database.ref(`reservasi/${reservasiKey}`).update({
                                status: 'selesai'
                            });
                        }
                        
                        showNotification('Check-out berhasil diproses', 'success');
                        closeInvoiceModal();
                    }
                    
                    hideLoading();
                } catch (error) {
                    console.error('Error checking out:', error);
                    showNotification('Gagal memproses check-out', 'error');
                    hideLoading();
                }
            }
        }

        async function batalkanReservasi() {
            const invoiceNumber = document.querySelector('#invoice-detail-content .invoice-header strong').textContent;
            
            if (confirm(`Batalkan reservasi ${invoiceNumber}?`)) {
                try {
                    showLoading('Membatalkan reservasi...');
                    
                    // Find and update in Firebase
                    const invoiceRef = database.ref('invoice');
                    const snapshot = await invoiceRef.once('value');
                    const invoices = snapshot.val();
                    
                    let invoiceKey = null;
                    for (const key in invoices) {
                        if (invoices[key].invoice === invoiceNumber) {
                            invoiceKey = key;
                            break;
                        }
                    }
                    
                    if (invoiceKey) {
                        await database.ref(`invoice/${invoiceKey}`).update({
                            status: 'dibatalkan'
                        });
                        
                        // Update reservation
                        const reservasiRef = database.ref('reservasi');
                        const reservasiSnapshot = await reservasiRef.once('value');
                        const reservasis = reservasiSnapshot.val();
                        
                        let reservasiKey = null;
                        for (const key in reservasis) {
                            if (reservasis[key].invoice === invoiceNumber) {
                                reservasiKey = key;
                                break;
                            }
                        }
                        
                        if (reservasiKey) {
                            await database.ref(`reservasi/${reservasiKey}`).update({
                                status: 'dibatalkan'
                            });
                        }
                        
                        showNotification('Reservasi berhasil dibatalkan', 'success');
                        closeInvoiceModal();
                    }
                    
                    hideLoading();
                } catch (error) {
                    console.error('Error canceling reservation:', error);
                    showNotification('Gagal membatalkan reservasi', 'error');
                    hideLoading();
                }
            }
        }

        function printInvoiceToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get invoice content
            const invoiceHTML = document.getElementById('invoice-detail-content').innerHTML;
            
            // Simple PDF generation (you can enhance this)
            doc.text('Invoice', 10, 10);
            doc.save('invoice.pdf');
            
            showNotification('Invoice berhasil diunduh sebagai PDF', 'success');
        }

        // ===============================
        // LAPAK VISUALIZATION
        // ===============================
        function updateLapakVisualization() {
            const date = document.getElementById('tanggal-visualisasi').value || formatDate(new Date());
            
            // Update visualization grids
            updateVisualizationGrid('lapak-tenda-vis', appData.lapakTenda, date, 'tenda');
            updateVisualizationGrid('glamping-vis', appData.glamping, date, 'glamping');
            
            // Update reservation list
            updateReservationList(date);
        }

        function updateVisualizationGrid(containerId, items, date, jenis) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Get reserved items for the date
            const reservedItems = [];
            appData.reservasi.forEach(r => {
                if (r.tanggalCheckin <= date && r.tanggalCheckout > date && 
                    (r.status === 'aktif' || r.status === 'dibayar') && r.jenis === jenis) {
                    if (jenis === 'tenda' && r.lapak) {
                        reservedItems.push(...r.lapak);
                    } else if (r.glamping) {
                        reservedItems.push(...r.glamping);
                    }
                }
            });
            
            // Create grid items
            items.forEach(item => {
                const isReserved = reservedItems.includes(item.kode);
                const gridItem = document.createElement('div');
                gridItem.className = `grid-item ${isReserved ? 'lapak-terpakai' : 'lapak-tersedia'}`;
                gridItem.textContent = item.kode;
                container.appendChild(gridItem);
            });
        }

        function updateReservationList(date) {
            const tbody = document.getElementById('lapak-reservasi-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Filter active reservations for the date
            const activeReservations = appData.reservasi.filter(r => 
                r.tanggalCheckin <= date && r.tanggalCheckout > date && 
                (r.status === 'aktif' || r.status === 'dibayar')
            );
            
            // Add to table
            activeReservations.forEach(reservasi => {
                const row = document.createElement('tr');
                
                let statusBadge = '';
                if (reservasi.status === 'aktif') {
                    statusBadge = '<span class="badge badge-success">Aktif</span>';
                } else if (reservasi.status === 'dibayar') {
                    statusBadge = '<span class="badge badge-primary">Dibayar</span>';
                }
                
                row.innerHTML = `
                    <td>${reservasi.invoice}</td>
                    <td>${reservasi.jenis}</td>
                    <td>${formatDateID(reservasi.tanggalCheckin)}</td>
                    <td>${formatDateID(reservasi.tanggalCheckout)}</td>
                    <td>${reservasi.nama}</td>
                    <td>${statusBadge}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function changeVisualizationTab(tabElement, target) {
            // Update tabs
            document.querySelectorAll('#lapak-section .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('#lapak-section .tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            tabElement.classList.add('active');
            document.getElementById(target).classList.add('active');
        }

        // ===============================
        // LAPORAN FUNCTIONS
        // ===============================
        function toggleTanggalKustom() {
            const periode = document.getElementById('periode-laporan').value;
            const customInputs = document.getElementById('periode-kustom-inputs');
            
            if (periode === 'kustom') {
                customInputs.classList.remove('hidden');
            } else {
                customInputs.classList.add('hidden');
                filterLaporan();
            }
        }

        function filterLaporan() {
            const periode = document.getElementById('periode-laporan').value;
            let startDate, endDate;
            
            const today = new Date();
            
            switch(periode) {
                case 'hari_ini':
                    startDate = formatDate(today);
                    endDate = formatDate(today);
                    break;
                case 'bulan_ini':
                    startDate = formatDate(new Date(today.getFullYear(), today.getMonth(), 1));
                    endDate = formatDate(today);
                    break;
                case 'bulan_lalu':
                    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    startDate = formatDate(lastMonth);
                    endDate = formatDate(new Date(today.getFullYear(), today.getMonth(), 0));
                    break;
                case 'tahun_ini':
                    startDate = formatDate(new Date(today.getFullYear(), 0, 1));
                    endDate = formatDate(today);
                    break;
                case 'kustom':
                    startDate = document.getElementById('tanggal-mulai').value;
                    endDate = document.getElementById('tanggal-selesai').value;
                    if (!startDate || !endDate) {
                        showNotification('Harap isi tanggal mulai dan selesai', 'warning');
                        return;
                    }
                    break;
                default:
                    return;
            }
            
            // Filter invoices by date
            const filteredInvoices = appData.invoice.filter(inv => {
                const invDate = new Date(inv.tanggalReservasi + 'T00:00:00');
                const start = new Date(startDate + 'T00:00:00');
                const end = new Date(endDate + 'T00:00:00');
                return invDate >= start && invDate <= end && inv.status !== 'dibatalkan';
            });
            
            // Calculate statistics
            let totalReservasi = filteredInvoices.length;
            let totalLapak = 0;
            let totalGlamping = 0;
            let totalPengunjung = 0;
            let totalOmzet = 0;
            
            filteredInvoices.forEach(inv => {
                const reservasi = appData.reservasi.find(r => r.invoice === inv.invoice);
                if (reservasi) {
                    if (reservasi.jenis === 'tenda' && reservasi.lapak) {
                        totalLapak += reservasi.lapak.length;
                    } else if (reservasi.glamping) {
                        totalGlamping += reservasi.glamping.length;
                    }
                    totalPengunjung += reservasi.jumlahOrang || 0;
                }
                totalOmzet += inv.totalBiaya || 0;
            });
            
            // Update statistics cards
            document.getElementById('laporan-total-reservasi').textContent = totalReservasi;
            document.getElementById('laporan-lapak-terjual').textContent = totalLapak;
            document.getElementById('laporan-glamping-terjual').textContent = totalGlamping;
            document.getElementById('laporan-total-pengunjung').textContent = totalPengunjung;
            document.getElementById('laporan-total-omzet').textContent = formatRupiah(totalOmzet);
            
            // Update detail table
            updateLaporanDetailTable(filteredInvoices);
        }

        function updateLaporanDetailTable(invoices) {
            const tbody = document.getElementById('laporan-detail');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            invoices.forEach(invoice => {
                const reservasi = appData.reservasi.find(r => r.invoice === invoice.invoice);
                
                let statusBadge = '';
                if (invoice.status === 'pending') {
                    statusBadge = '<span class="badge badge-warning">Pending</span>';
                } else if (invoice.status === 'dibayar') {
                    statusBadge = '<span class="badge badge-primary">Dibayar</span>';
                } else if (invoice.status === 'aktif') {
                    statusBadge = '<span class="badge badge-success">Aktif</span>';
                } else if (invoice.status === 'selesai') {
                    statusBadge = '<span class="badge badge-secondary">Selesai</span>';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${invoice.invoice}</td>
                    <td>${formatDateID(invoice.tanggalReservasi)}</td>
                    <td>${formatDateID(invoice.tanggalCheckin)}</td>
                    <td>${formatDateID(invoice.tanggalCheckout)}</td>
                    <td>${invoice.nama}</td>
                    <td>${invoice.jenis}</td>
                    <td>${formatRupiah(invoice.totalBiaya)}</td>
                    <td>${statusBadge}</td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function generateLaporanPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.text('Laporan Transaksi', 20, 20);
            
            // Add period info
            const periode = document.getElementById('periode-laporan').value;
            const periodeText = document.querySelector(`#periode-laporan option[value="${periode}"]`).textContent;
            doc.setFontSize(12);
            doc.text(`Periode: ${periodeText}`, 20, 30);
            doc.text(`Tanggal cetak: ${formatDateID(formatDate(new Date()))}`, 20, 40);
            
            // Add statistics
            doc.setFontSize(14);
            doc.text('Statistik:', 20, 55);
            
            const stats = [
                `Total Reservasi: ${document.getElementById('laporan-total-reservasi').textContent}`,
                `Total Lapak Terjual: ${document.getElementById('laporan-lapak-terjual').textContent}`,
                `Total Glamping Terjual: ${document.getElementById('laporan-glamping-terjual').textContent}`,
                `Total Pengunjung: ${document.getElementById('laporan-total-pengunjung').textContent}`,
                `Total Omzet: ${document.getElementById('laporan-total-omzet').textContent}`
            ];
            
            stats.forEach((stat, index) => {
                doc.setFontSize(12);
                doc.text(stat, 20, 70 + (index * 10));
            });
            
            // Save PDF
            doc.save(`laporan-${periodeText.toLowerCase().replace(/\s+/g, '-')}.pdf`);
            
            showNotification('Laporan berhasil diunduh sebagai PDF', 'success');
        }

        // ===============================
        // PENGATURAN FUNCTIONS
        // ===============================
        async function simpanPengaturan() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat mengubah pengaturan', 'warning');
                return;
            }
            
            try {
                showLoading('Menyimpan pengaturan...');
                
                const updatedPengaturan = {
                    perusahaan: {
                        nama: appData.pengaturan.perusahaan?.nama || 'Bukit Sampalan Asri',
                        alamat: appData.pengaturan.perusahaan?.alamat || '',
                        hargaTiket: parseInt(document.getElementById('harga-tiket').value) || 15000,
                        namaBank: document.getElementById('nama-bank').value || '',
                        norek: document.getElementById('nomor-rekening').value || '',
                        anRekening: document.getElementById('an-rekening').value || '',
                        noLayanan: appData.pengaturan.perusahaan?.noLayanan || ''
                    },
                    dpPercentage: parseInt(document.getElementById('dp-percentage').value) || 50,
                    jamCheckin: appData.pengaturan.jamCheckin || '14:00',
                    jamCheckout: appData.pengaturan.jamCheckout || '12:00',
                    minReservasiHari: appData.pengaturan.minReservasiHari || 1,
                    maxReservasiHari: appData.pengaturan.maxReservasiHari || 7
                };
                
                await database.ref('pengaturan').set(updatedPengaturan);
                
                showNotification('Pengaturan berhasil disimpan', 'success');
                hideLoading();
                
            } catch (error) {
                console.error('Error saving settings:', error);
                showNotification('Gagal menyimpan pengaturan', 'error');
                hideLoading();
            }
        }

        // ===============================
        // USER MANAGEMENT FUNCTIONS
        // ===============================
        function generateUsersList() {
            const tbody = document.getElementById('users-list');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            appData.users.forEach(user => {
                const row = document.createElement('tr');
                
                const roleBadge = user.role === 'admin' 
                    ? '<span class="badge badge-danger">Admin</span>' 
                    : '<span class="badge badge-primary">Staff</span>';
                
                row.innerHTML = `
                    <td>${user.nama}</td>
                    <td>${user.username}</td>
                    <td>${roleBadge}</td>
                    <td>Aktif</td>
                    <td>
                        ${user.id !== currentUser.id ? `
                            <button class="btn btn-danger btn-sm" onclick="hapusUser(${user.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : 'Pengguna aktif'}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        document.getElementById('tambah-user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat menambah pengguna', 'warning');
                return;
            }
            
            const nama = document.getElementById('new-nama').value.trim();
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            
            if (!nama || !username || !password) {
                showNotification('Harap lengkapi semua field', 'warning');
                return;
            }
            
            // Check if username exists
            if (appData.users.some(u => u.username === username)) {
                showNotification('Username sudah terdaftar', 'warning');
                return;
            }
            
            try {
                showLoading('Menambah pengguna...');
                
                // Create new user
                const newUserId = appData.users.length > 0 
                    ? Math.max(...appData.users.map(u => u.id)) + 1 
                    : 1;
                
                const newUser = {
                    id: newUserId,
                    nama: nama,
                    username: username,
                    password: password,
                    role: role,
                    createdAt: new Date().toISOString()
                };
                
                // Save to Firebase
                await database.ref(`users/${newUserId}`).set(newUser);
                
                // Reset form
                this.reset();
                
                showNotification('Pengguna berhasil ditambahkan', 'success');
                hideLoading();
                
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Gagal menambah pengguna', 'error');
                hideLoading();
            }
        });

        async function hapusUser(userId) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Hanya admin yang dapat menghapus pengguna', 'warning');
                return;
            }
            
            if (userId === currentUser.id) {
                showNotification('Tidak dapat menghapus akun sendiri', 'warning');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus pengguna ini?')) {
                try {
                    showLoading('Menghapus pengguna...');
                    
                    await database.ref(`users/${userId}`).remove();
                    
                    showNotification('Pengguna berhasil dihapus', 'success');
                    hideLoading();
                    
                } catch (error) {
                    console.error('Error deleting user:', error);
                    showNotification('Gagal menghapus pengguna', 'error');
                    hideLoading();
                }
            }
        }

        // ===============================
        // INITIALIZATION
        // ===============================
        async function init() {
            try {
                showLoading('Memulai sistem...');
                
                // Load data from Firebase
                const success = await loadData();
                
                if (success) {
                    // Check if user was previously logged in
                    const savedUser = localStorage.getItem('currentUser');
                    if (savedUser) {
                        currentUser = JSON.parse(savedUser);
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'block';
                        initializeApp();
                        setupRealtimeListeners();
                    } else {
                        document.getElementById('login-screen').style.display = 'block';
                    }
                } else {
                    document.getElementById('login-screen').style.display = 'block';
                    showNotification('Gagal memuat data, coba refresh halaman', 'error');
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('Initialization error:', error);
                showNotification('Terjadi kesalahan saat memulai sistem', 'error');
                hideLoading();
                document.getElementById('login-screen').style.display = 'block';
            }
        }

        // Start the application
        init();

        // ===============================
        // EVENT LISTENERS
        // ===============================
        document.addEventListener('DOMContentLoaded', function() {
            // Scroll to top button
            window.addEventListener('scroll', function() {
                const scrollTopBtn = document.querySelector('.scroll-top');
                if (window.scrollY > 300) {
                    scrollTopBtn.style.display = 'flex';
                } else {
                    scrollTopBtn.style.display = 'none';
                }
            });
        });

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>