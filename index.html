<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reservasi Kemah Keluarga - Bukit Sampalan Asri</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --accent-color: #ff9800;
            --light-color: #f1f8e9;
            --dark-color: #1b5e20;
            --danger-color: #f44336;
            --warning-color: #ffc107;
            --success-color: #4caf50;
            --gray-color: #757575;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Header Styles - Mobile Friendly */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            font-size: 1.8rem;
            margin-right: 10px;
        }
        
        .header-content h1 {
            font-size: 1.3rem;
            margin-bottom: 3px;
            line-height: 1.2;
        }
        
        .header-content p {
            opacity: 0.9;
            font-size: 0.75rem;
            display: none;
        }
        
        .auth-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
        }
        
        .auth-container span {
            margin-right: 8px;
            font-size: 0.85rem;
        }
        
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 36px;
            min-width: 36px;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.3rem;
            cursor: pointer;
            padding: 8px;
            margin-left: 10px;
            min-height: 36px;
            min-width: 36px;
        }
        
        nav {
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        nav ul {
            display: flex;
            list-style: none;
            flex-wrap: wrap;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        nav a {
            color: white;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.3s;
            font-weight: 500;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        
        nav a:hover, nav a.active {
            background-color: var(--dark-color);
        }
        
        /* Main Content */
        .main-content {
            display: flex;
            flex-wrap: wrap;
            margin: 15px 0;
            gap: 15px;
        }
        
        .content-section {
            flex: 1;
            min-width: 280px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .section-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
        }
        
        .section-title i {
            margin-right: 8px;
        }
        
        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .card {
            background-color: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-3px);
        }
        
        .card-icon {
            font-size: 1.8rem;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        .card-value {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 3px;
        }
        
        .card-label {
            color: var(--gray-color);
            font-size: 0.8rem;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px !important; /* Prevents zoom on iOS */
            transition: border 0.3s;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        
        .form-row .form-group {
            flex: 1;
            min-width: 150px;
        }
        
        /* Button Styles */
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 5px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: 44px;
            min-width: 44px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--dark-color);
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--primary-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .btn-sm {
            padding: 6px 10px;
            font-size: 0.8rem;
            min-height: 36px;
        }
        
        /* Table Styles - IMPROVED FOR MOBILE */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
            margin-bottom: 1rem;
            scrollbar-width: thin;
        }
        
        .table-responsive::-webkit-scrollbar {
            height: 6px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 3px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            min-width: 600px;
        }
        
        .table th, .table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
            vertical-align: middle;
        }
        
        .table th {
            background-color: var(--light-color);
            color: var(--dark-color);
            font-weight: 600;
            white-space: nowrap;
        }
        
        .table tr:hover {
            background-color: #f9f9f9;
        }
        
        /* Lapak Visualization */
        .lapak-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            gap: 6px;
            margin-top: 15px;
        }
        
        .lapak-item {
            height: 55px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            font-size: 0.85rem;
            min-height: 44px;
            min-width: 44px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .lapak-item:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        .lapak-item .lapak-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            white-space: nowrap;
            display: none;
            z-index: 10;
        }
        
        .lapak-item:hover .lapak-tooltip {
            display: block;
        }
        
        .lapak-tersedia {
            background-color: var(--success-color);
        }
        
        .lapak-terpakai {
            background-color: var(--danger-color);
        }
        
        .lapak-dipilih {
            background-color: var(--warning-color);
            transform: scale(1.03);
            box-shadow: 0 0 8px rgba(0,0,0,0.2);
        }
        
        .lapak-item:hover {
            transform: scale(1.03);
        }
        
        /* Invoice Styles */
        .invoice {
            border: 2px solid var(--light-color);
            border-radius: 8px;
            padding: 15px;
            background-color: white;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 12px;
        }
        
        .invoice-details {
            margin-bottom: 15px;
        }
        
        .invoice-items {
            margin-bottom: 15px;
        }
        
        .invoice-total {
            text-align: right;
            font-size: 1rem;
            font-weight: bold;
            border-top: 2px solid var(--light-color);
            padding-top: 12px;
        }
        
        /* Footer */
        footer {
            background-color: var(--dark-color);
            color: white;
            padding: 15px 0;
            margin-top: 25px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .footer-section {
            margin-bottom: 15px;
        }
        
        .footer-section h3 {
            margin-bottom: 10px;
            font-size: 1rem;
        }
        
        .copyright {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: 15px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* Tabs Styles - IMPROVED FOR MOBILE */
        .tabs-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--light-color);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .tabs::-webkit-scrollbar {
            display: none;
        }
        
        .tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 500;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 0.85rem;
            flex-shrink: 0;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .tab:hover {
            background-color: rgba(0,0,0,0.05);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Visualisasi Grid */
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin-top: 15px;
        }
        
        .grid-item {
            height: 40px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.7rem;
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            .dashboard-cards {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
            
            .visualization-grid {
                grid-template-columns: repeat(8, 1fr);
            }
            
            .footer-content {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .menu-toggle {
                display: flex;
            }
            
            .header-content p {
                display: block;
            }
            
            nav ul {
                flex-direction: column;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
                gap: 3px;
                margin-top: 8px;
            }
            
            nav ul.active {
                max-height: 500px;
            }
            
            nav a {
                padding: 10px 12px;
                font-size: 0.9rem;
            }
            
            .main-content {
                flex-direction: column;
                gap: 12px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .form-row .form-group {
                min-width: 100%;
            }
            
            .dashboard-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .lapak-container {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            }
            
            .lapak-item {
                height: 50px;
                font-size: 0.8rem;
            }
            
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .visualization-grid {
                grid-template-columns: repeat(6, 1fr);
            }
            
            .grid-item {
                height: 35px;
                font-size: 0.65rem;
            }
            
            .footer-content {
                grid-template-columns: 1fr;
            }
            
            /* Improved mobile table scrolling */
            .table {
                min-width: 650px;
            }
            
            .table th, .table td {
                padding: 8px 6px;
                font-size: 0.82rem;
            }
            
            .content-section {
                padding: 12px;
            }
            
            .btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }
        }
        
        @media (max-width: 576px) {
            .header-top {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .logo-container {
                width: 100%;
                justify-content: space-between;
                margin-bottom: 10px;
            }
            
            .menu-toggle {
                display: flex;
                order: 1;
            }
            
            .header-content h1 {
                font-size: 1.1rem;
            }
            
            .logo {
                font-size: 1.4rem;
            }
            
            .auth-container {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            
            .logout-btn {
                padding: 5px 8px;
                font-size: 0.8rem;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .card {
                padding: 10px;
            }
            
            .card-value {
                font-size: 1.2rem;
            }
            
            .lapak-container {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            }
            
            .lapak-item {
                height: 45px;
                font-size: 0.75rem;
            }
            
            .tab {
                padding: 8px 10px;
                font-size: 0.8rem;
            }
            
            .visualization-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .grid-item {
                height: 30px;
                font-size: 0.6rem;
            }
            
            .table th, .table td {
                padding: 6px 4px;
                font-size: 0.78rem;
            }
            
            .section-title {
                font-size: 1rem;
                flex-wrap: wrap;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.82rem;
            }
            
            .form-control {
                padding: 8px 10px;
            }
        }
        
        @media (max-width: 360px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .lapak-container {
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            }
            
            .lapak-item {
                height: 40px;
                font-size: 0.7rem;
            }
            
            .tab {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
            
            .visualization-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .grid-item {
                height: 25px;
                font-size: 0.55rem;
            }
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .text-right {
            text-align: right;
        }
        
        .mb-2 {
            margin-bottom: 10px;
        }
        
        .mb-3 {
            margin-bottom: 15px;
        }
        
        .mb-4 {
            margin-bottom: 20px;
        }
        
        .mt-2 {
            margin-top: 10px;
        }
        
        .mt-3 {
            margin-top: 15px;
        }
        
        .mt-4 {
            margin-top: 20px;
        }
        
        .ml-2 {
            margin-left: 10px;
        }
        
        .ml-3 {
            margin-left: 15px;
        }
        
        .alert {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 12px;
            font-size: 0.85rem;
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .badge-warning {
            background-color: var(--warning-color);
            color: #333;
        }
        
        .badge-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .badge-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .badge-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-tersedia {
            background-color: var(--success-color);
        }
        
        .status-terpakai {
            background-color: var(--danger-color);
        }
        
        .status-dipilih {
            background-color: var(--warning-color);
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: flex-start;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: var(--gray-color);
            padding: 5px;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary-color);
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin: 15px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Login Styles */
        .login-container {
            max-width: 350px;
            margin: 60px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .login-logo i {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .login-logo h2 {
            color: var(--primary-color);
            font-size: 1.3rem;
        }
        
        /* Glamping Selection */
        .glamping-option {
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .glamping-option:hover {
            border-color: var(--primary-color);
        }
        
        .glamping-option.selected {
            border-color: var(--primary-color);
            background-color: var(--light-color);
        }
        
        .glamping-option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Checkbox Selection */
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .checkbox-container input {
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }
        
        /* Payment Method Styles */
        .payment-option {
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .payment-option:hover {
            border-color: var(--primary-color);
        }
        
        .payment-option.selected {
            border-color: var(--primary-color);
            background-color: var(--light-color);
        }
        
        .payment-icon {
            font-size: 1.1rem;
            margin-right: 6px;
            color: var(--primary-color);
        }
        
        /* User Role Badges */
        .badge-admin {
            background-color: #9c27b0;
            color: white;
        }
        
        .badge-manager {
            background-color: #2196f3;
            color: white;
        }
        
        .badge-staff {
            background-color: #ff9800;
            color: white;
        }
        
        /* Access Control */
        .access-control {
            margin-bottom: 12px;
            padding: 8px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        
        .access-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #ddd;
        }
        
        .access-item:last-child {
            border-bottom: none;
        }
        
        /* Bank Info Styles */
        .bank-info {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 12px;
            border-radius: 5px;
            margin: 12px 0;
        }
        
        .bank-info h5 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        /* Touch Friendly */
        button, 
        input[type="button"], 
        input[type="submit"], 
        .btn,
        .tab,
        .lapak-item {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Prevent text selection on interactive elements */
        .btn, .tab, .lapak-item {
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Mobile optimization for forms */
        input, select, textarea {
            font-size: 16px !important; /* Prevents zoom on iOS */
        }
        
        /* Better touch feedback */
        .btn:active, .tab:active, .lapak-item:active {
            opacity: 0.8;
            transform: scale(0.98);
        }
        
        /* Akomodasi Lainnya Styles */
        .akomodasi-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .akomodasi-item {
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            background-color: white;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .akomodasi-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .akomodasi-item.selected {
            border-color: var(--primary-color);
            background-color: var(--light-color);
        }
        
        .akomodasi-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .akomodasi-item h5 {
            margin-bottom: 6px;
            color: var(--dark-color);
            font-size: 0.9rem;
        }
        
        .akomodasi-price {
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 5px;
            font-size: 0.9rem;
        }
        
        /* Akomodasi Checkbox */
        .akomodasi-checkbox {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .akomodasi-checkbox input {
            margin-right: 6px;
        }
        
        /* Style untuk form edit invoice */
        #invoice-edit-form {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            border-left: 4px solid var(--primary-color);
            margin-top: 15px;
        }

        /* Style untuk preview hapus */
        #preview-hapus-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            background-color: #fff;
            margin-top: 15px;
        }

        #preview-hapus-container table {
            margin-bottom: 0;
        }

        #preview-hapus-container .table th {
            background-color: #f1f8e9;
        }
        
        /* Edit invoice form improvements */
        #edit-diskon-nilai:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        
        .diskon-info-box {
            padding: 8px;
            background-color: #e8f5e9;
            border-radius: 5px;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        /* Mobile optimizations for pengaturan tabs */
        .pengaturan-tab-content {
            padding: 10px 0;
        }
        
        /* Scroll to top button for mobile */
        .scroll-top {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 99;
            display: none;
        }
        
        .scroll-top:hover {
            background-color: var(--dark-color);
        }
        
        /* Input group for mobile */
        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        /* Fix for select dropdown on iOS */
        select.form-control {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 35px;
        }
        
        /* Mobile menu animation */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        nav ul.active {
            animation: slideDown 0.3s ease forwards;
        }
    </style>
</head>
<body>
    <!-- Scroll to top button -->
    <div class="scroll-top" onclick="scrollToTop()">
        <i class="fas fa-chevron-up"></i>
    </div>
    
    <div id="login-screen" class="login-container" style="display: block;">
        <div class="login-logo">
            <i class="fas fa-campground"></i>
            <h2>Bukit Sampalan Asri</h2>
            <p>Sistem Reservasi Kemah Keluarga</p>
        </div>
        
        <form id="login-form">
            <div class="form-group">
                <label for="username"><i class="fas fa-user"></i> Username</label>
                <input type="text" id="username" class="form-control" placeholder="Masukkan username" required>
            </div>
            
            <div class="form-group">
                <label for="password"><i class="fas fa-lock"></i> Password</label>
                <input type="password" id="password" class="form-control" placeholder="Masukkan password" required>
            </div>
            
            <div class="alert alert-danger hidden" id="login-error">
                <i class="fas fa-exclamation-circle"></i> Username atau password salah!
            </div>
            
            <button type="button" class="btn btn-primary btn-block" onclick="login()">
                <i class="fas fa-sign-in-alt"></i> Login
            </button>
        </form>
    </div>

    <div id="main-app" style="display: none;">
        <header>
            <div class="container">
                <div class="header-top">
                    <div class="logo-container">
                        <div class="logo">
                            <i class="fas fa-campground"></i>
                        </div>
                        <div class="header-content">
                            <h1>Bukit Sampalan Asri</h1>
                            <p>Sistem Reservasi Kemah Keluarga</p>
                        </div>
                        <button class="menu-toggle" onclick="toggleMobileMenu()">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                    
                    <div class="auth-container">
                        <div class="user-profile">
                            <div class="user-avatar" id="user-avatar">
                                A
                            </div>
                            <div>
                                <span id="current-user"></span>
                                <div id="user-role" style="font-size: 0.75rem; opacity: 0.9;"></div>
                            </div>
                        </div>
                        <button class="logout-btn" onclick="logout()" title="Logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span class="logout-text">Keluar</span>
                        </button>
                    </div>
                </div>
                
                <nav>
                    <ul id="main-nav">
                        <li><a href="#" class="active" onclick="showSection('dashboard')"><i class="fas fa-home"></i> Dashboard</a></li>
                        <li><a href="#" onclick="showSection('reservasi')"><i class="fas fa-calendar-plus"></i> Reservasi</a></li>
                        <li><a href="#" onclick="showSection('lapak')"><i class="fas fa-map-marked-alt"></i> Status Lapak</a></li>
                        <li><a href="#" onclick="showSection('invoice')"><i class="fas fa-file-invoice-dollar"></i> Invoice</a></li>
                        <li><a href="#" onclick="showSection('laporan')"><i class="fas fa-chart-bar"></i> Laporan</a></li>
                        <li><a href="#" onclick="showSection('pengaturan')" class="admin-only"><i class="fas fa-cog"></i> Pengaturan</a></li>
                        <li><a href="#" onclick="showSection('users')" class="admin-only"><i class="fas fa-users"></i> Pengguna</a></li>
                        <li><a href="#" onclick="showSection('backup')" class="admin-only"><i class="fas fa-database"></i> Backup</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Dashboard Monitoring</h2>
                
                <div class="dashboard-cards">
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-campground"></i>
                        </div>
                        <div class="card-value" id="lapak-tersedia">0</div>
                        <div class="card-label">Lapak Tenda Tersedia</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-campground"></i>
                        </div>
                        <div class="card-value" id="lapak-terpakai">0</div>
                        <div class="card-label">Lapak Tenda Terpakai</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-home"></i>
                        </div>
                        <div class="card-value" id="glamping-terpakai">0</div>
                        <div class="card-label">Glamping Terpakai</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-value" id="pengunjung-hari-ini">0</div>
                        <div class="card-label">Pengunjung Hari Ini</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="card-value" id="omzet-harian">Rp 0</div>
                        <div class="card-label">Omzet Harian (DP/Lunas)</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <div class="card-value" id="reservasi-bulan-ini">0</div>
                        <div class="card-label">Reservasi Bulan Ini</div>
                    </div>
                </div>

                <div class="form-row mb-3">
                    <div class="form-group" style="flex: 1;">
                        <label for="filter-tanggal"><i class="fas fa-calendar-day"></i> Filter Status Tanggal</label>
                        <input type="date" id="filter-tanggal" class="form-control" onchange="updateDashboard()">
                    </div>
                </div>

                <div class="content-section">
                    <h3 class="section-title"><i class="fas fa-campground"></i> Status Lapak Tenda Hari Ini</h3>
                    <div class="lapak-container" id="lapak-status-container">
                        </div>
                    <div class="mt-3">
                        <span class="status-indicator status-tersedia"></span> Tersedia
                        <span class="status-indicator status-terpakai ml-3"></span> Terpakai
                        <span class="status-indicator status-dipilih ml-3"></span> Dipilih
                    </div>
                </div>

                <div class="content-section mt-3">
                    <h3 class="section-title"><i class="fas fa-home"></i> Status Glamping Hari Ini</h3>
                    <div class="lapak-container" id="glamping-status-container" style="grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));">
                        </div>
                </div>
            </section>

            <!-- Reservasi Section -->
            <section id="reservasi-section" class="content-section hidden">
                <h2 class="section-title"><i class="fas fa-calendar-plus"></i> Form Reservasi Baru</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Maksimal <span id="max-lapak-info">30</span> lapak/glamping per reservasi.
                </div>
                
                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="tenda" onclick="changeReservasiTab(this, 'tenda')"><i class="fas fa-campground"></i> Lapak Tenda</div>
                        <div class="tab" data-tab="glamping" onclick="changeReservasiTab(this, 'glamping')"><i class="fas fa-home"></i> Glamping</div>
                    </div>
                </div>

                <div id="tab-tenda" class="tab-content active">
                    <form id="reservasi-tenda-form">
                        <h4 class="section-title"><i class="fas fa-user"></i> Data Pemesan</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nama-tenda">Nama Pemesan</label>
                                <input type="text" id="nama-tenda" class="form-control" placeholder="Nama lengkap" required>
                            </div>
                            <div class="form-group">
                                <label for="telepon-tenda">Nomor Telepon/WA</label>
                                <input type="tel" id="telepon-tenda" class="form-control" placeholder="+62 8xx xxxx xxxx" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="jumlah-orang-tenda">Jumlah Orang/Rombongan</label>
                                <input type="number" id="jumlah-orang-tenda" class="form-control" value="1" min="1" required onchange="hitungTotalBiayaTenda()" onkeyup="hitungTotalBiayaTenda()">
                            </div>
                            <div class="form-group">
                                <label for="email-tenda">Email (Opsional)</label>
                                <input type="email" id="email-tenda" class="form-control" placeholder="alamat@email.com">
                            </div>
                        </div>

                        <h4 class="section-title mt-3"><i class="fas fa-calendar-check"></i> Detail Reservasi</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tanggal-checkin-tenda">Tanggal Check-in</label>
                                <input type="date" id="tanggal-checkin-tenda" class="form-control" required onchange="updateLapakStatus()">
                            </div>
                            <div class="form-group">
                                <label for="tanggal-checkout-tenda">Tanggal Check-out</label>
                                <input type="date" id="tanggal-checkout-tenda" class="form-control" required onchange="hitungJumlahMalam('tenda')">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="jumlah-malam-tenda">Jumlah Malam</label>
                                <input type="number" id="jumlah-malam-tenda" class="form-control" value="1" min="1" required onchange="hitungTotalBiayaTenda()" onkeyup="hitungTotalBiayaTenda()">
                            </div>
                            <div class="form-group">
                                <label for="jumlah-lapak-tenda">Lapak Dipilih</label>
                                <input type="text" id="jumlah-lapak-tenda" class="form-control" value="0 Lapak" disabled>
                            </div>
                        </div>
                        
                        <h4 class="section-title mt-3"><i class="fas fa-map-pin"></i> Pilih Lapak Tenda</h4>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Pastikan tanggal check-in telah diisi untuk melihat status lapak yang akurat.
                        </div>
                        <div class="lapak-container" id="lapak-pilih-container">
                            </div>
                        <small class="text-muted mt-2 d-block">Lapak dipilih: <span id="lapak-dipilih-tenda-count">0</span></small>

                        <!-- TABEL AKOMODASI LAINNYA TAMBAHAN -->
                        <h4 class="section-title mt-3"><i class="fas fa-utensils"></i> Akomodasi Lainnya (Opsional)</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Pilih akomodasi tambahan sesuai kebutuhan.
                        </div>
                        <div class="akomodasi-container" id="akomodasi-tenda-container">
                            <!-- Akomodasi akan di-generate oleh JavaScript -->
                        </div>
                        <small class="text-muted mt-2 d-block">Akomodasi dipilih: <span id="akomodasi-dipilih-tenda-count">0</span></small>

                        <h4 class="section-title mt-3"><i class="fas fa-money-check-alt"></i> Metode Pembayaran</h4>
                        <div class="form-group">
                            <label>Pilih Metode Pembayaran (DP <span id="dp-percentage-info-tenda">50</span>%)</label>
                            <div class="payment-option selected" id="payment-lokasi-tenda" onclick="selectPaymentMethod('lokasi', 'tenda')">
                                <i class="fas fa-money-bill-wave payment-icon"></i> Bayar di Lokasi (Lunas saat Check-in)
                            </div>
                            <div class="payment-option" id="payment-transfer-tenda" onclick="selectPaymentMethod('transfer', 'tenda')">
                                <i class="fas fa-credit-card payment-icon"></i> DP Transfer Bank
                            </div>
                            <div class="payment-option" id="payment-sekarang-tenda" onclick="selectPaymentMethod('sekarang', 'tenda')">
                                <i class="fas fa-wallet payment-icon"></i> Bayar Penuh Sekarang Transfer Bank (Total Biaya)
                            </div>
                        </div>

                        <h4 class="section-title mt-3"><i class="fas fa-calculator"></i> Rincian Biaya</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td>Biaya Lapak (<span id="biaya-lapak-count">0</span> lapak x <span id="biaya-lapak-malam">0</span> malam)</td>
                                        <td class="text-right" id="biaya-lapak-tenda">Rp 0</td>
                                    </tr>
                                    <tr>
                                        <td>Tiket Masuk (<span id="biaya-tiket-orang">0</span> orang x <span id="biaya-tiket-malam">0</span> malam)</td>
                                        <td class="text-right" id="biaya-tiket-tenda">Rp 0</td>
                                    </tr>
                                    <tr id="akomodasi-row-tenda" style="display: none;">
                                        <td>Akomodasi Lainnya</td>
                                        <td class="text-right" id="biaya-akomodasi-tenda">Rp 0</td>
                                    </tr>
                                    <tr>
                                        <td>**TOTAL BIAYA**</td>
                                        <td class="text-right">**<span id="total-biaya-tenda">Rp 0</span>**</td>
                                    </tr>
                                    <tr id="dp-row-tenda">
                                        <td>**DP (<span id="dp-percentage-tenda">50</span>%)**</td>
                                        <td class="text-right">**<span id="dp-tenda">Rp 0</span>**</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3">
                            <button type="button" class="btn btn-primary btn-block" onclick="submitReservasi('tenda')">
                                <i class="fas fa-save"></i> Proses Reservasi
                            </button>
                        </div>
                    </form>
                </div>

                <div id="tab-glamping" class="tab-content">
                    <form id="reservasi-glamping-form">
                        <h4 class="section-title"><i class="fas fa-user"></i> Data Pemesan</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nama-glamping">Nama Pemesan</label>
                                <input type="text" id="nama-glamping" class="form-control" placeholder="Nama lengkap" required>
                            </div>
                            <div class="form-group">
                                <label for="telepon-glamping">Nomor Telepon/WA</label>
                                <input type="tel" id="telepon-glamping" class="form-control" placeholder="+62 8xx xxxx xxxx" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="jumlah-orang-glamping">Jumlah Orang/Rombongan</label>
                                <input type="number" id="jumlah-orang-glamping" class="form-control" value="1" min="1" required onchange="hitungTotalBiayaGlamping()" onkeyup="hitungTotalBiayaGlamping()">
                            </div>
                            <div class="form-group">
                                <label for="email-glamping">Email (Opsional)</label>
                                <input type="email" id="email-glamping" class="form-control" placeholder="alamat@email.com">
                            </div>
                        </div>

                        <h4 class="section-title mt-3"><i class="fas fa-calendar-check"></i> Detail Reservasi</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tanggal-checkin-glamping">Tanggal Check-in</label>
                                <input type="date" id="tanggal-checkin-glamping" class="form-control" required onchange="updateGlampingStatus()">
                            </div>
                            <div class="form-group">
                                <label for="tanggal-checkout-glamping">Tanggal Check-out</label>
                                <input type="date" id="tanggal-checkout-glamping" class="form-control" required onchange="hitungJumlahMalam('glamping')">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="jumlah-malam-glamping">Jumlah Malam</label>
                                <input type="number" id="jumlah-malam-glamping" class="form-control" value="1" min="1" required onchange="hitungTotalBiayaGlamping()" onkeyup="hitungTotalBiayaGlamping()">
                            </div>
                            <div class="form-group">
                                <label for="jumlah-glamping">Glamping Dipilih</label>
                                <input type="text" id="jumlah-glamping" class="form-control" value="0 Unit" disabled>
                            </div>
                        </div>

                        <h4 class="section-title mt-3"><i class="fas fa-map-pin"></i> Pilih Glamping</h4>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Pastikan tanggal check-in telah diisi untuk melihat status glamping yang akurat.
                        </div>
                        <div class="lapak-container" id="glamping-pilih-container" style="grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));">
                            </div>
                        <small class="text-muted mt-2 d-block">Glamping dipilih: <span id="glamping-dipilih-count">0</span></small>

                        <!-- TABEL AKOMODASI LAINNYA TAMBAHAN UNTUK GLAMPING -->
                        <h4 class="section-title mt-3"><i class="fas fa-utensils"></i> Akomodasi Lainnya (Opsional)</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Pilih akomodasi tambahan sesuai kebutuhan.
                        </div>
                        <div class="akomodasi-container" id="akomodasi-glamping-container">
                            <!-- Akomodasi akan di-generate oleh JavaScript -->
                        </div>
                        <small class="text-muted mt-2 d-block">Akomodasi dipilih: <span id="akomodasi-dipilih-glamping-count">0</span></small>

                        <h4 class="section-title mt-3"><i class="fas fa-money-check-alt"></i> Metode Pembayaran</h4>
                        <div class="form-group">
                            <label>Pilih Metode Pembayaran (DP <span id="dp-percentage-info-glamping">50</span>%)</label>
                            <div class="payment-option selected" id="payment-lokasi-glamping" onclick="selectPaymentMethod('lokasi', 'glamping')">
                                <i class="fas fa-money-bill-wave payment-icon"></i> Bayar di Lokasi (Lunas saat Check-in)
                            </div>
                            <div class="payment-option" id="payment-transfer-glamping" onclick="selectPaymentMethod('transfer', 'glamping')">
                                <i class="fas fa-credit-card payment-icon"></i> DP Transfer Bank
                            </div>
                            <div class="payment-option" id="payment-sekarang-glamping" onclick="selectPaymentMethod('sekarang', 'glamping')">
                                <i class="fas fa-wallet payment-icon"></i> Bayar Penuh Sekarang Transfer Bank (Total Biaya)
                            </div>
                        </div>
                        
                        <h4 class="section-title mt-3"><i class="fas fa-calculator"></i> Rincian Biaya</h4>
                        <div class="table-responsive">
                            <table class="table">
                                <tbody>
                                    <tr>
                                        <td>Biaya Glamping (<span id="glamping-dipilih-count-biaya">0</span> unit x <span id="biaya-glamping-malam">0</span> malam)</td>
                                        <td class="text-right" id="biaya-glamping">Rp 0</td>
                                    </tr>
                                    <tr>
                                        <td>Tiket Masuk (<span id="biaya-tiket-orang-glamping">0</span> orang x <span id="biaya-tiket-malam-glamping">0</span> malam)</td>
                                        <td class="text-right" id="biaya-tiket-glamping">Rp 0</td>
                                    </tr>
                                    <tr id="akomodasi-row-glamping" style="display: none;">
                                        <td>Akomodasi Lainnya</td>
                                        <td class="text-right" id="biaya-akomodasi-glamping">Rp 0</td>
                                    </tr>
                                    <tr>
                                        <td>**TOTAL BIAYA**</td>
                                        <td class="text-right">**<span id="total-biaya-glamping">Rp 0</span>**</td>
                                    </tr>
                                    <tr id="dp-row-glamping">
                                        <td>**DP (<span id="dp-percentage-glamping">50</span>%)**</td>
                                        <td class="text-right">**<span id="dp-glamping">Rp 0</span>**</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-primary btn-block" onclick="submitReservasi('glamping')">
                                <i class="fas fa-save"></i> Proses Reservasi
                            </button>
                        </div>
                    </form>
                </div>
            </section>

            <!-- Lapak Section -->
            <section id="lapak-section" class="content-section hidden">
                <h2 class="section-title"><i class="fas fa-map-marked-alt"></i> Visualisasi Status Lapak/Glamping</h2>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="tanggal-visualisasi"><i class="fas fa-calendar-day"></i> Filter Tanggal</label>
                        <input type="date" id="tanggal-visualisasi" class="form-control" onchange="updateLapakVisualization()">
                    </div>
                </div>

                <div class="tabs-container mt-3">
                    <div class="tabs">
                        <div class="tab active" data-tab="lapak-tenda-vis" onclick="changeVisualizationTab(this, 'lapak-tenda-vis')"><i class="fas fa-campground"></i> Lapak Tenda</div>
                        <div class="tab" data-tab="glamping-vis" onclick="changeVisualizationTab(this, 'glamping-vis')"><i class="fas fa-home"></i> Glamping</div>
                    </div>
                </div>

                <div id="lapak-tenda-vis" class="tab-content active">
                    <div class="visualization-grid" id="visualization-lapak">
                        </div>
                </div>

                <div id="glamping-vis" class="tab-content">
                    <div class="visualization-grid" id="visualization-glamping" style="grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));">
                        </div>
                </div>

                <div class="mt-3">
                    <span class="status-indicator status-tersedia"></span> Tersedia
                    <span class="status-indicator status-terpakai ml-3"></span> Terpakai
                    <span class="status-indicator status-dipilih ml-3"></span> Dipilih (untuk hari ini)
                </div>

                <h3 class="section-title mt-3"><i class="fas fa-list-alt"></i> Detail Reservasi Aktif</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Jenis</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Nama Pemesan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="lapak-reservasi-list">
                            </tbody>
                    </table>
                </div>
            </section>

            <!-- Invoice Section -->
            <section id="invoice-section" class="content-section hidden">
                <h2 class="section-title"><i class="fas fa-file-invoice-dollar"></i> Daftar Invoice Reservasi</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cari-invoice">Cari Invoice/Nama/Telepon</label>
                        <input type="text" id="cari-invoice" class="form-control" placeholder="Masukkan kata kunci..." onkeyup="cariInvoice()">
                    </div>
                    <div class="form-group">
                        <label for="filter-status">Filter Status</label>
                        <select id="filter-status" class="form-control" onchange="cariInvoice()">
                            <option value="">Semua Status</option>
                            <option value="pending">Pending</option>
                            <option value="dibayar">Dibayar (DP/Lunas)</option>
                            <option value="selesai">Selesai</option>
                            <option value="dibatalkan">Dibatalkan</option>
                            <option value="aktif">Aktif (Check-in)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-jenis">Filter Jenis</label>
                        <select id="filter-jenis" class="form-control" onchange="cariInvoice()">
                            <option value="">Semua Jenis</option>
                            <option value="tenda">Lapak Tenda</option>
                            <option value="glamping">Glamping</option>
                        </select>
                    </div>
                </div>
                
                <div class="table-responsive mt-3">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Nama Pemesan</th>
                                <th>Jenis</th>
                                <th>Total Biaya</th>
                                <th>Status</th>
                                <th>Tgl Reservasi</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-list">
                            </tbody>
                    </table>
                </div>
                
                <h3 class="section-title mt-3"><i class="fas fa-cart-plus"></i> Tambah Sewa Barang Manual</h3>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Tambah sewa barang untuk invoice yang aktif/dibayar.
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="invoice-sewa-barang">Pilih Invoice (Aktif/Dibayar)</label>
                        <select id="invoice-sewa-barang" class="form-control" onchange="loadSewaBarangForm()">
                            <option value="">-- Pilih Invoice --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="jumlah-hari-sewa">Jumlah Hari Sewa</label>
                        <input type="number" id="jumlah-hari-sewa" class="form-control" min="1" onchange="hitungTotalSewaBarang()" onkeyup="hitungTotalSewaBarang()">
                    </div>
                    <div class="form-group">
                        <label for="nama-pemandu-manual">Nama Pemandu/Petugas</label>
                        <input type="text" id="nama-pemandu-manual" class="form-control" placeholder="Nama pemandu">
                    </div>
                </div>
                
                <div id="sewa-barang-form-container" class="hidden">
                    <div class="table-responsive">
                        <table class="table mt-3">
                            <thead>
                                <tr>
                                    <th style="width: 30%">Nama Barang</th>
                                    <th style="width: 20%">Harga/Hari</th>
                                    <th style="width: 15%">Satuan</th>
                                    <th style="width: 15%">Jumlah</th>
                                    <th style="width: 20%" class="text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="sewa-barang-list-manual">
                                </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" class="text-right">**TOTAL SEWA BARANG**</td>
                                    <td class="text-right">**<span id="total-sewa-barang">Rp 0</span>**</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <button class="btn btn-primary btn-block mt-3" onclick="simpanSewaBarang()">
                        <i class="fas fa-save"></i> Simpan Sewa Barang ke Invoice
                    </button>
                </div>
            </section>

            <!-- Laporan Section -->
            <section id="laporan-section" class="content-section hidden">
                <h2 class="section-title"><i class="fas fa-chart-bar"></i> Laporan dan Statistik</h2>
                
                <div class="form-group">
                    <label for="periode-laporan">Periode Laporan</label>
                    <select id="periode-laporan" class="form-control" onchange="toggleTanggalKustom()">
                        <option value="hari_ini">Hari Ini</option>
                        <option value="bulan_ini" selected>Bulan Ini</option>
                        <option value="bulan_lalu">Bulan Lalu</option>
                        <option value="tahun_ini">Tahun Ini</option>
                        <option value="kustom">Kustom</option>
                    </select>
                </div>

                <div class="form-row hidden" id="periode-kustom-inputs">
                    <div class="form-group">
                        <label for="tanggal-mulai">Tanggal Mulai</label>
                        <input type="date" id="tanggal-mulai" class="form-control" onchange="filterLaporan()">
                    </div>
                    <div class="form-group">
                        <label for="tanggal-selesai">Tanggal Selesai</label>
                        <input type="date" id="tanggal-selesai" class="form-control" onchange="filterLaporan()">
                    </div>
                </div>

                <div class="dashboard-cards mt-3">
                    <div class="card" style="background-color: #e3f2fd;">
                        <div class="card-icon" style="color: #1e88e5;"><i class="fas fa-file-invoice"></i></div>
                        <div class="card-value" id="laporan-total-reservasi">0</div>
                        <div class="card-label">Total Reservasi</div>
                    </div>
                    <div class="card" style="background-color: #e8f5e9;">
                        <div class="card-icon" style="color: #43a047;"><i class="fas fa-campground"></i></div>
                        <div class="card-value" id="laporan-lapak-terjual">0</div>
                        <div class="card-label">Total Lapak Terjual</div>
                    </div>
                    <div class="card" style="background-color: #fff3e0;">
                        <div class="card-icon" style="color: #fb8c00;"><i class="fas fa-home"></i></div>
                        <div class="card-value" id="laporan-glamping-terjual">0</div>
                        <div class="card-label">Total Glamping Terjual</div>
                    </div>
                    <div class="card" style="background-color: #fce4ec;">
                        <div class="card-icon" style="color: #d81b60;"><i class="fas fa-users"></i></div>
                        <div class="card-value" id="laporan-total-pengunjung">0</div>
                        <div class="card-label">Total Pengunjung</div>
                    </div>
                    <div class="card" style="background-color: #e1f5fe;">
                        <div class="card-icon" style="color: #039be5;"><i class="fas fa-ticket-alt"></i></div>
                        <div class="card-value" id="laporan-total-tiket">Rp 0</div>
                        <div class="card-label">Total Biaya Tiket</div>
                    </div>
                    <div class="card" style="background-color: #e0f7fa;">
                        <div class="card-icon" style="color: #00bcd4;"><i class="fas fa-dollar-sign"></i></div>
                        <div class="card-value" id="laporan-total-omzet">Rp 0</div>
                        <div class="card-label">Total Omzet (DP/Lunas)</div>
                    </div>
                </div>

                <h3 class="section-title mt-3"><i class="fas fa-list-alt"></i> Detail Transaksi</h3>
                <div class="text-right mb-3">
                    <button class="btn btn-primary" onclick="generateLaporanPDF()">
                        <i class="fas fa-file-pdf"></i> Download Laporan PDF
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Invoice</th>
                                <th>Tgl Reservasi</th>
                                <th>Check-in</th>
                                <th>Check-out</th>
                                <th>Nama Pemesan</th>
                                <th>Jenis</th>
                                <th>Total Biaya</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="laporan-detail">
                            </tbody>
                    </table>
                </div>
            </section>

            <!-- Pengaturan Section - IMPROVED FOR MOBILE -->
            <section id="pengaturan-section" class="content-section hidden admin-only">
                <h2 class="section-title"><i class="fas fa-cog"></i> Pengaturan Sistem</h2>
                <div class="alert alert-warning admin-only">
                    <i class="fas fa-exclamation-triangle"></i> Halaman ini hanya dapat diakses oleh Admin.
                </div>

                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="tab-lapak-glamping" onclick="changePengaturanTab(this, 'lapak-glamping')"><i class="fas fa-campground"></i> Lapak & Glamping</div>
                        <div class="tab" data-tab="tab-biaya-umum" onclick="changePengaturanTab(this, 'biaya-umum')"><i class="fas fa-dollar-sign"></i> Biaya & Lainnya</div>
                        <div class="tab" data-tab="tab-barang-sewa" onclick="changePengaturanTab(this, 'barang-sewa')"><i class="fas fa-toolbox"></i> Barang Sewa</div>
                        <div class="tab" data-tab="tab-akomodasi" onclick="changePengaturanTab(this, 'akomodasi')"><i class="fas fa-utensils"></i> Akomodasi Lainnya</div>
                        <div class="tab" data-tab="tab-tools" onclick="changePengaturanTab(this, 'tools')"><i class="fas fa-screwdriver-wrench"></i> Tools Admin</div>
                    </div>
                </div>

                <div id="tab-lapak-glamping" class="tab-content active pengaturan-tab-content">
                    <h3 class="section-title"><i class="fas fa-campground"></i> Pengaturan Lapak Tenda</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 20%">Kode Lapak</th>
                                    <th style="width: 25%">Harga/Malam</th>
                                    <th style="width: 25%">Kapasitas (Orang)</th>
                                    <th style="width: 30%">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pengaturan-lapak">
                                </tbody>
                        </table>
                    </div>
                    <button class="btn btn-secondary btn-sm mt-3" onclick="tambahLapak()">
                        <i class="fas fa-plus"></i> Tambah Lapak
                    </button>

                    <h3 class="section-title mt-3"><i class="fas fa-home"></i> Pengaturan Glamping</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 20%">Kode</th>
                                    <th style="width: 30%">Nama Glamping</th>
                                    <th style="width: 20%">Harga/Malam</th>
                                    <th style="width: 15%">Kapasitas (Orang)</th>
                                    <th style="width: 15%">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pengaturan-glamping">
                                </tbody>
                        </table>
                    </div>
                    <button class="btn btn-secondary btn-sm mt-3" onclick="tambahGlamping()">
                        <i class="fas fa-plus"></i> Tambah Glamping
                    </button>
                </div>

                <div id="tab-biaya-umum" class="tab-content pengaturan-tab-content" style="display: none;">
                    <h3 class="section-title"><i class="fas fa-dollar-sign"></i> Biaya Umum</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="harga-tiket">Harga Tiket Masuk/Orang/Malam (Rp)</label>
                            <input type="number" id="harga-tiket" class="form-control" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="dp-percentage">Persentase DP (%)</label>
                            <input type="number" id="dp-percentage" class="form-control" min="0" max="100" required>
                        </div>
                    </div>

                    <h3 class="section-title mt-3"><i class="fas fa-clock"></i> Pengaturan Waktu</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="jam-checkin">Jam Check-in (HH:MM)</label>
                            <input type="time" id="jam-checkin" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="jam-checkout">Jam Check-out (HH:MM)</label>
                            <input type="time" id="jam-checkout" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="min-reservasi-hari">Min. Hari Reservasi (Hari)</label>
                            <input type="number" id="min-reservasi-hari" class="form-control" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="max-reservasi-hari">Maks. Hari Reservasi (Hari)</label>
                            <input type="number" id="max-reservasi-hari" class="form-control" min="1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max-lapak-per-reservasi">Maks. Lapak/Glamping per Reservasi</label>
                            <input type="number" id="max-lapak-per-reservasi" class="form-control" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="denda-keterlambatan">Denda Keterlambatan Check-out/Jam (Rp)</label>
                            <input type="number" id="denda-keterlambatan" class="form-control" min="0" required>
                        </div>
                    </div>
                    
                    <h3 class="section-title mt-3"><i class="fas fa-university"></i> Informasi Bank Transfer</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nama-bank">Nama Bank</label>
                            <input type="text" id="nama-bank" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="nomor-rekening">Nomor Rekening</label>
                            <input type="text" id="nomor-rekening" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="an-rekening">Atas Nama Rekening</label>
                            <input type="text" id="an-rekening" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="no-layanan">Nomor Layanan (WA/Telepon)</label>
                            <input type="tel" id="no-layanan" class="form-control" placeholder="+62 8xx xxxx xxxx" required>
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block mt-3" onclick="simpanPengaturanUmum()">
                        <i class="fas fa-save"></i> Simpan Pengaturan Umum
                    </button>
                </div>

                <div id="tab-barang-sewa" class="tab-content pengaturan-tab-content" style="display: none;">
                    <h3 class="section-title"><i class="fas fa-toolbox"></i> Daftar Barang Sewa</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 35%">Nama Barang</th>
                                    <th style="width: 25%">Harga Sewa/Hari (Rp)</th>
                                    <th style="width: 15%">Satuan</th>
                                    <th style="width: 15%">Stok</th>
                                    <th style="width: 10%">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pengaturan-barang">
                                </tbody>
                        </table>
                    </div>
                    <button class="btn btn-secondary btn-sm mt-3" onclick="tambahBarang()">
                        <i class="fas fa-plus"></i> Tambah Barang
                    </button>
                </div>

                <div id="tab-akomodasi" class="tab-content pengaturan-tab-content" style="display: none;">
                    <h3 class="section-title"><i class="fas fa-utensils"></i> Pengaturan Akomodasi Lainnya</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th style="width: 35%">Nama Akomodasi</th>
                                    <th style="width: 25%">Harga (Rp)</th>
                                    <th style="width: 15%">Satuan</th>
                                    <th style="width: 15%">Stok</th>
                                    <th style="width: 10%">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="pengaturan-akomodasi">
                                </tbody>
                        </table>
                    </div>
                    <button class="btn btn-secondary btn-sm mt-3" onclick="tambahAkomodasi()">
                        <i class="fas fa-plus"></i> Tambah Akomodasi
                    </button>
                </div>

                <div id="tab-tools" class="tab-content pengaturan-tab-content" style="display: none;">
                    <h3 class="section-title"><i class="fas fa-tools"></i> Tools Admin</h3>
                    <div class="alert alert-danger mb-3">
                        <i class="fas fa-exclamation-triangle"></i> **PERINGATAN!** Tindakan ini tidak dapat dibatalkan.
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Hapus Invoice Bulan Lalu</label>
                            <p class="text-muted" style="font-size: 0.85rem;">Menghapus semua invoice dan data reservasi yang tanggal reservasi-nya jatuh pada bulan lalu.</p>
                        </div>
                        <div class="form-group" style="flex: 0 0 120px;">
                            <button class="btn btn-danger btn-block mt-2" onclick="hapusInvoiceBulanLalu()">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Reset Lapak/Glamping Checkout Hari Ini</label>
                            <p class="text-muted" style="font-size: 0.85rem;">Mengubah status lapak/glamping menjadi 'tersedia' untuk semua reservasi yang Check-out hari ini dan statusnya 'aktif' atau 'dibayar'.</p>
                        </div>
                        <div class="form-group" style="flex: 0 0 120px;">
                            <button class="btn btn-secondary btn-block mt-2" onclick="resetLapakHariIni()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </div>
                    
                    <!-- FITUR BARU: HAPUS INVOICE TERPILIH -->
                    <hr>
                    
                    <div class="form-row mt-3">
                        <div class="form-group" style="flex: 1;">
                            <label>Hapus Invoice Berdasarkan Filter</label>
                            <p class="text-muted" style="font-size: 0.85rem;">Hapus invoice berdasarkan filter tanggal, jenis, atau status. Kosongkan filter untuk semua data.</p>
                            
                            <div class="form-row mt-2">
                                <div class="form-group">
                                    <label for="hapus-filter-tanggal-mulai" style="font-size: 0.85rem;">Tanggal Mulai</label>
                                    <input type="date" id="hapus-filter-tanggal-mulai" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="hapus-filter-tanggal-selesai" style="font-size: 0.85rem;">Tanggal Selesai</label>
                                    <input type="date" id="hapus-filter-tanggal-selesai" class="form-control">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="hapus-filter-jenis" style="font-size: 0.85rem;">Jenis</label>
                                    <select id="hapus-filter-jenis" class="form-control">
                                        <option value="">Semua Jenis</option>
                                        <option value="tenda">Lapak Tenda</option>
                                        <option value="glamping">Glamping</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="hapus-filter-status" style="font-size: 0.85rem;">Status</label>
                                    <select id="hapus-filter-status" class="form-control">
                                        <option value="">Semua Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="dibayar">Dibayar</option>
                                        <option value="aktif">Aktif</option>
                                        <option value="selesai">Selesai</option>
                                        <option value="dibatalkan">Dibatalkan</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="hapus-konfirmasi" style="font-size: 0.85rem;">Ketik "HAPUS" untuk konfirmasi</label>
                                    <input type="text" id="hapus-konfirmasi" class="form-control" placeholder="Ketik HAPUS di sini">
                                </div>
                            </div>
                        </div>
                        <div class="form-group" style="flex: 0 0 120px; display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn btn-danger btn-block" onclick="hapusInvoiceTerpilih()" id="btn-hapus-terpilih">
                                <i class="fas fa-trash"></i> Hapus Terpilih
                            </button>
                            <button class="btn btn-secondary btn-block" onclick="previewInvoiceTerpilih()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                        </div>
                    </div>

                    <div id="preview-hapus-container" class="hidden mt-3">
                        <h5 class="section-title"><i class="fas fa-list"></i> Invoice yang akan dihapus</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Invoice</th>
                                        <th>Nama Pemesan</th>
                                        <th>Jenis</th>
                                        <th>Total Biaya</th>
                                        <th>Status</th>
                                        <th>Tgl Reservasi</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-hapus-list">
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-warning mt-2">
                            <i class="fas fa-exclamation-triangle"></i> Total invoice yang akan dihapus: <span id="preview-hapus-count">0</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users-section" class="content-section hidden admin-only">
                <h2 class="section-title"><i class="fas fa-users"></i> Manajemen Pengguna</h2>
                <div class="alert alert-warning admin-only">
                    <i class="fas fa-exclamation-triangle"></i> Halaman ini hanya dapat diakses oleh Admin.
                </div>
                
                <h3 class="section-title"><i class="fas fa-user-plus"></i> Tambah Pengguna Baru</h3>
                <form id="tambah-user-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-nama">Nama Lengkap</label>
                            <input type="text" id="new-nama" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-username">Username</label>
                            <input type="text" id="new-username" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="new-password">Password</label>
                            <input type="password" id="new-password" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-role">Role</label>
                            <select id="new-role" class="form-control" required>
                                <option value="staff">Staff</option>
                                <option value="manager">Manager</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-secondary mt-2">
                        <i class="fas fa-user-plus"></i> Tambah Pengguna
                    </button>
                </form>

                <h3 class="section-title mt-3"><i class="fas fa-users-cog"></i> Daftar Pengguna</h3>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="users-list">
                            </tbody>
                    </table>
                </div>
            </section>

            <!-- Backup Section -->
            <section id="backup-section" class="content-section hidden admin-only">
                <h2 class="section-title"><i class="fas fa-database"></i> Backup & Restore Data</h2>
                <div class="alert alert-warning admin-only">
                    <i class="fas fa-exclamation-triangle"></i> Halaman ini hanya dapat diakses oleh Admin.
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Backup data secara berkala untuk mencegah kehilangan data.
                </div>

                <div class="tabs-container">
                    <div class="tabs">
                        <div class="tab active" data-tab="backup-tab" onclick="changeBackupTab(this, 'backup')"><i class="fas fa-download"></i> Backup Data</div>
                        <div class="tab" data-tab="restore-tab" onclick="changeBackupTab(this, 'restore')"><i class="fas fa-upload"></i> Restore Data</div>
                        <div class="tab" data-tab="reset-tab" onclick="changeBackupTab(this, 'reset')"><i class="fas fa-redo"></i> Reset Data</div>
                    </div>
                </div>

                <div id="backup-tab" class="tab-content active pengaturan-tab-content">
                    <h3 class="section-title"><i class="fas fa-download"></i> Backup Data Sistem</h3>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Data yang akan dibackup:</label>
                            <div class="access-control">
                                <div class="access-item">
                                    <span>Data Reservasi & Invoice</span>
                                    <span id="count-reservasi">0</span>
                                </div>
                                <div class="access-item">
                                    <span>Lapak Tenda</span>
                                    <span id="count-lapak">0</span>
                                </div>
                                <div class="access-item">
                                    <span>Glamping</span>
                                    <span id="count-glamping">0</span>
                                </div>
                                <div class="access-item">
                                    <span>Barang Sewa</span>
                                    <span id="count-barang">0</span>
                                </div>
                                <div class="access-item">
                                    <span>Akomodasi Lainnya</span>
                                    <span id="count-akomodasi">0</span>
                                </div>
                                <div class="access-item">
                                    <span>Pengaturan</span>
                                    <span>1</span>
                                </div>
                                <div class="access-item">
                                    <span>Pengguna</span>
                                    <span id="count-users">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row mt-3">
                        <div class="form-group" style="flex: 1;">
                            <label for="backup-password">Password Backup (Opsional)</label>
                            <input type="text" id="backup-password" class="form-control" placeholder="Kosongkan jika tidak ingin menggunakan password">
                            <small class="text-muted">Password akan digunakan untuk mengenkripsi data backup.</small>
                        </div>
                    </div>
                    
                    <div class="form-row mt-3">
                        <div class="form-group" style="flex: 1;">
                            <button class="btn btn-primary btn-block" onclick="backupData()">
                                <i class="fas fa-download"></i> Download Backup File
                            </button>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <button class="btn btn-secondary btn-block" onclick="copyBackupToClipboard()">
                                <i class="fas fa-copy"></i> Copy Backup ke Clipboard
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-success mt-3 hidden" id="backup-success">
                        <i class="fas fa-check-circle"></i> Backup berhasil dibuat!
                    </div>
                    
                    <div class="alert alert-danger mt-3 hidden" id="backup-error">
                        <i class="fas fa-exclamation-circle"></i> Terjadi kesalahan saat membuat backup!
                    </div>
                </div>

                <div id="restore-tab" class="tab-content pengaturan-tab-content" style="display: none;">
                    <h3 class="section-title"><i class="fas fa-upload"></i> Restore Data dari Backup</h3>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> <strong>PERINGATAN:</strong> Restore data akan menggantikan semua data yang ada. Pastikan Anda memiliki backup terbaru sebelum melakukan restore.
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="restore-method">Metode Restore</label>
                            <select id="restore-method" class="form-control" onchange="toggleRestoreMethod()">
                                <option value="file">Upload File Backup</option>
                                <option value="text">Paste Data Backup</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="restore-file-container">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="backup-file">Pilih File Backup (.json atau .txt)</label>
                                <input type="file" id="backup-file" class="form-control" accept=".json,.txt">
                            </div>
                        </div>
                    </div>
                    
                    <div id="restore-text-container" class="hidden">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="backup-text">Paste Data Backup</label>
                                <textarea id="backup-text" class="form-control" rows="6" placeholder="Paste data backup di sini..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="restore-password">Password Backup (jika ada)</label>
                            <input type="text" id="restore-password" class="form-control" placeholder="Masukkan password jika backup dienkripsi">
                        </div>
                    </div>
                    
                    <div class="form-row mt-3">
                        <div class="form-group" style="flex: 1;">
                            <button class="btn btn-primary btn-block" onclick="restoreData()">
                                <i class="fas fa-upload"></i> Restore Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-success mt-3 hidden" id="restore-success">
                        <i class="fas fa-check-circle"></i> Data berhasil direstore!
                    </div>
                    
                    <div class="alert alert-danger mt-3 hidden" id="restore-error">
                        <i class="fas fa-exclamation-circle"></i> <span id="restore-error-message">Terjadi kesalahan saat restore data!</span>
                    </div>
                </div>

                <div id="reset-tab" class="tab-content pengaturan-tab-content" style="display: none;">
                    <h3 class="section-title"><i class="fas fa-redo"></i> Reset Data Sistem</h3>
                    
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle"></i> <strong>PERINGATAN KRITIS:</strong> Tindakan ini akan menghapus semua data dan mengembalikan sistem ke kondisi awal. Pastikan Anda telah membuat backup sebelum melakukan reset!
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="reset-type">Jenis Reset</label>
                            <select id="reset-type" class="form-control">
                                <option value="all">Reset Semua Data (Full Reset)</option>
                                <option value="transactions">Reset Hanya Transaksi (Reservasi & Invoice)</option>
                                <option value="products">Reset Hanya Produk (Lapak, Glamping, Barang)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label for="reset-confirm">Ketik "RESET" untuk konfirmasi</label>
                            <input type="text" id="reset-confirm" class="form-control" placeholder="Ketik RESET di sini">
                        </div>
                    </div>
                    
                    <div class="form-row mt-3">
                        <div class="form-group" style="flex: 1;">
                            <button class="btn btn-danger btn-block" onclick="resetSystemData()" id="btn-reset-system">
                                <i class="fas fa-bomb"></i> Reset Sistem
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle"></i> <strong>Catatan:</strong> Reset akan menghapus data yang dipilih tetapi tetap menyimpan pengguna dan pengaturan dasar.
                    </div>
                </div>
            </section>
        </div>

        <!-- MODAL INVOICE DENGAN FITUR EDIT -->
        <div id="invoice-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-receipt"></i> Detail Invoice <span id="modal-invoice-number"></span></h5>
                    <button class="modal-close" onclick="closeInvoiceModal()">&times;</button>
                </div>
                <div id="invoice-detail-content">
                    <!-- Konten invoice akan diisi oleh JavaScript -->
                </div>
                
                <!-- FORM EDIT INVOICE DENGAN FITUR DISKON DAN PEMANDU -->
                <div id="invoice-edit-form" class="hidden mt-3">
                    <h4 class="section-title"><i class="fas fa-edit"></i> Edit Invoice</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-nama-pemandu">Nama Pemandu/Petugas</label>
                            <input type="text" id="edit-nama-pemandu" class="form-control" placeholder="Masukkan nama pemandu">
                        </div>
                        <div class="form-group">
                            <label for="edit-diskon-tipe">Tipe Diskon</label>
                            <select id="edit-diskon-tipe" class="form-control" onchange="toggleDiskonType()">
                                <option value="none">Tidak Ada Diskon</option>
                                <option value="percentage">Persentase (%)</option>
                                <option value="fixed">Nominal Tetap (Rp)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-diskon-nilai">Nilai Diskon</label>
                            <input type="number" id="edit-diskon-nilai" class="form-control" placeholder="0" min="0" onchange="hitungDiskon()" onkeyup="hitungDiskon()">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="edit-catatan">Catatan Tambahan</label>
                            <textarea id="edit-catatan" class="form-control" rows="2" placeholder="Catatan tambahan untuk invoice..."></textarea>
                        </div>
                    </div>
                    <div id="diskon-info" class="alert alert-info mt-2 hidden">
                        Diskon akan diterapkan pada total biaya sebelum DP.
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary" onclick="simpanEditInvoice()">
                            <i class="fas fa-save"></i> Simpan Perubahan
                        </button>
                        <button class="btn btn-secondary ml-2" onclick="batalEditInvoice()">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
                
                <div class="modal-footer mt-3" style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button class="btn btn-secondary" onclick="printInvoiceToPDF()">
                        <i class="fas fa-print"></i> Cetak PDF
                    </button>
                    <button class="btn btn-danger" id="btn-batalkan-invoice" onclick="batalkanReservasi()">
                        <i class="fas fa-times-circle"></i> Batalkan
                    </button>
                    <button class="btn btn-success" id="btn-checkin-invoice" onclick="checkInReservasi()">
                        <i class="fas fa-sign-in-alt"></i> Check-in
                    </button>
                    <button class="btn btn-primary" id="btn-checkout-invoice" onclick="checkOutReservasi()">
                        <i class="fas fa-sign-out-alt"></i> Check-out
                    </button>
                    <button class="btn btn-warning" id="btn-update-pembayaran" onclick="updatePembayaran()">
                        <i class="fas fa-money-check-alt"></i> Update Pembayaran
                    </button>
                    <button class="btn btn-info" id="btn-edit-invoice" onclick="toggleEditInvoiceForm()">
                        <i class="fas fa-edit"></i> Edit Invoice
                    </button>
                </div>
            </div>
        </div>

        <div id="user-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-edit"></i> Edit Pengguna</h5>
                    <button class="modal-close" onclick="closeUserModal()">&times;</button>
                </div>
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    <div class="form-group">
                        <label for="edit-nama">Nama Lengkap</label>
                        <input type="text" id="edit-nama" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-username">Username</label>
                        <input type="text" id="edit-username" class="form-control" required readonly>
                    </div>
                    <div class="form-group">
                        <label for="edit-password">Password (Kosongkan jika tidak diubah)</label>
                        <input type="password" id="edit-password" class="form-control" placeholder="****">
                    </div>
                    <div class="form-group">
                        <label for="edit-role">Role</label>
                        <select id="edit-role" class="form-control" required>
                            <option value="staff">Staff</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block mt-3">
                        <i class="fas fa-save"></i> Simpan Perubahan
                    </button>
                </form>
            </div>
        </div>

        <div id="loading-modal" class="modal">
            <div class="modal-content" style="max-width: 280px; text-align: center;">
                <div class="spinner"></div>
                <p id="loading-message">Memproses...</p>
            </div>
        </div>
        
        <footer>
            <div class="container">
                <div class="footer-content">
                    <div class="footer-section">
                        <h3>Bukit Sampalan Asri</h3>
                        <p>Sistem Reservasi Kemah Keluarga</p>
                    </div>
                    <div class="footer-section">
                        <h3>Kontak</h3>
                        <p><i class="fas fa-phone"></i> Layanan: <span id="footer-no-layanan">+628xx xxxx xxxx</span></p>
                    </div>
                    <div class="footer-section">
                        <h3>Developer</h3>
                        <p>Powered by AI Assistant</p>
                        <p>Versi: 2025v12 (Backup & Bug Fix)</p>
                    </div>
                </div>
                <div class="copyright">
                    &copy; 2025 Bukit Sampalan Asri. All rights reserved.
                </div>
            </div>
        </footer>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyALzmkMAaJEwZO04OMAZaaWfcLBjYU2GCM",
            authDomain: "reservasi-kemah-bsa.firebaseapp.com",
            databaseURL: "https://reservasi-kemah-bsa-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "reservasi-kemah-bsa",
            storageBucket: "reservasi-kemah-bsa.firebasestorage.app",
            messagingSenderId: "883193001958",
            appId: "1:883193001958:web:9aa40ce72e83e0ac32c827"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Firestore Database Reference
        let firebaseEnabled = false;
        
        // Function to check Firebase connection
        function checkFirebaseConnection() {
            try {
                const connectedRef = database.ref(".info/connected");
                connectedRef.on("value", function(snap) {
                    if (snap.val() === true) {
                        console.log("Firebase Connected");
                        firebaseEnabled = true;
                    } else {
                        console.log("Firebase Disconnected");
                        firebaseEnabled = false;
                    }
                });
                return true;
            } catch (error) {
                console.error("Firebase connection error:", error);
                firebaseEnabled = false;
                return false;
            }
        }
        
        // Function to sync data to Firebase
        function syncToFirebase() {
            if (!firebaseEnabled) return;
            
            try {
                const user = dataApp.user;
                if (!user) return;
                
                const userDataRef = database.ref(`users/${user.username}/data`);
                const dataToSave = {
                    reservasi: dataApp.reservasi,
                    invoice: dataApp.invoice,
                    lapakTenda: dataApp.lapakTenda,
                    glamping: dataApp.glamping,
                    barangSewa: dataApp.barangSewa,
                    akomodasiLainnya: dataApp.akomodasiLainnya,
                    pengaturan: dataApp.pengaturan,
                    users: dataApp.users,
                    lastSync: new Date().toISOString()
                };
                
                userDataRef.set(dataToSave)
                    .then(() => {
                        console.log("Data synced to Firebase");
                    })
                    .catch((error) => {
                        console.error("Firebase sync error:", error);
                    });
            } catch (error) {
                console.error("Error syncing to Firebase:", error);
            }
        }
        
        // Function to load data from Firebase
        function loadFromFirebase() {
            if (!firebaseEnabled) return false;
            
            return new Promise((resolve, reject) => {
                try {
                    const user = dataApp.user;
                    if (!user) {
                        resolve(false);
                        return;
                    }
                    
                    const userDataRef = database.ref(`users/${user.username}/data`);
                    userDataRef.once('value')
                        .then((snapshot) => {
                            const firebaseData = snapshot.val();
                            if (firebaseData) {
                                // Merge data from Firebase
                                dataApp.reservasi = firebaseData.reservasi || dataApp.reservasi;
                                dataApp.invoice = firebaseData.invoice || dataApp.invoice;
                                dataApp.lapakTenda = firebaseData.lapakTenda || dataApp.lapakTenda;
                                dataApp.glamping = firebaseData.glamping || dataApp.glamping;
                                dataApp.barangSewa = firebaseData.barangSewa || dataApp.barangSewa;
                                dataApp.akomodasiLainnya = firebaseData.akomodasiLainnya || dataApp.akomodasiLainnya;
                                dataApp.pengaturan = { ...dataApp.pengaturan, ...firebaseData.pengaturan };
                                if (firebaseData.pengaturan && firebaseData.pengaturan.perusahaan) {
                                    dataApp.pengaturan.perusahaan = { ...dataApp.pengaturan.perusahaan, ...firebaseData.pengaturan.perusahaan };
                                }
                                dataApp.users = firebaseData.users || dataApp.users;
                                
                                console.log("Data loaded from Firebase");
                                resolve(true);
                            } else {
                                console.log("No data found in Firebase");
                                resolve(false);
                            }
                        })
                        .catch((error) => {
                            console.error("Firebase load error:", error);
                            resolve(false);
                        });
                } catch (error) {
                    console.error("Error loading from Firebase:", error);
                    resolve(false);
                }
            });
        }

        // Utility Functions
        function formatRupiah(number) {
            if (isNaN(number)) number = 0;
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '';
            
            let month = '' + (d.getMonth() + 1);
            let day = '' + d.getDate();
            const year = d.getFullYear();

            if (month.length < 2) month = '0' + month;
            if (day.length < 2) day = '0' + day;

            return [year, month, day].join('-');
        }
        
        function formatDateID(dateString) {
            if (!dateString) return '';
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const date = new Date(dateString + 'T00:00:00');
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('id-ID', options);
        }

        function generateInvoiceCode() {
            const now = new Date();
            const datePart = [
                now.getFullYear().toString().slice(-2),
                (now.getMonth() + 1).toString().padStart(2, '0'),
                now.getDate().toString().padStart(2, '0')
            ].join('');
            const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase();
            return `INV-${datePart}-${randomPart}`;
        }
        
        function showLoadingModal(message = 'Memproses...') {
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-modal').style.display = 'flex';
        }

        function hideLoadingModal() {
            document.getElementById('loading-modal').style.display = 'none';
        }
        
        // Scroll to top function
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Show scroll to top button on scroll
        window.addEventListener('scroll', function() {
            const scrollTopBtn = document.querySelector('.scroll-top');
            if (window.scrollY > 300) {
                scrollTopBtn.style.display = 'flex';
            } else {
                scrollTopBtn.style.display = 'none';
            }
        });

        // --- Data Handling ---
        
        // Initial Data
        let dataApp = {
            reservasi: [],
            invoice: [],
            lapakTenda: [
                { kode: 'D01', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D02', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D03', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D04', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D05', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D06', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D07', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D08', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D09', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D10', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D11', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D12', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D13', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D14', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D15', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D16', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D17', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D18', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D19', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D20', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D21', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D22', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D23', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D24', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D25', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D26', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D27', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D28', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D29', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'D30', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'T01', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'T02', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'T03', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'T04', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'T05', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'T06', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'T07', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'T08', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'T09', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'T10', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B01', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B02', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B03', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B04', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B05', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B06', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B07', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B08', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B09', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B10', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B11', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B12', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B13', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B14', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B15', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B16', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B17', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B18', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B19', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B20', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B21', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B22', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B23', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B24', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B25', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B26', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B27', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B28', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'B29', harga: 0, kapasitas: 4, status: 'tersedia' }, { kode: 'B30', harga: 0, kapasitas: 4, status: 'tersedia' }
            ],
            glamping: [
                { kode: 'G01', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G02', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G03', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G04', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G05', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G06', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G07', nama: 'Glamping Tipe A (4pax)', harga: 100000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G08', nama: 'Glamping Tipe A (4pax)', harga: 100000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G09', nama: 'Glamping Tipe B (2pax)', harga: 120000, kapasitas: 2, status: 'tersedia' },
                { kode: 'G10', nama: 'Glamping Tipe B (2pax)', harga: 120000, kapasitas: 2, status: 'tersedia' }
            ],
            barangSewa: [
                { id: 1, nama: "Tenda Dome Kapasitas 4", harga: 70000, satuan: "hari", stok: 15 },
                { id: 2, nama: "Sleeping Bag", harga: 10000, satuan: "hari", stok: 30 },
                { id: 3, nama: "Matras", harga: 5000, satuan: "hari", stok: 30 },
                { id: 4, nama: "Kompor Portable", harga: 15000, satuan: "hari", stok: 10 },
            ],
            akomodasiLainnya: [
                { id: 1, nama: "Tenda Dome 3 Orang", harga: 60000, satuan: "unit", stok: 15, status: 'tersedia', jumlah: 0 },
                { id: 2, nama: "Kayu Bakar (1 pack)", harga: 10000, satuan: "pack", stok: 50, status: 'tersedia', jumlah: 0 },
                { id: 3, nama: "Kasur Lipat", harga: 15000, satuan: "unit", stok: 20, status: 'tersedia', jumlah: 0 },
                { id: 4, nama: "Nasi Liwet Porsi Keluarga", harga: 20000, satuan: "porsi", stok: 30, status: 'tersedia', jumlah: 0 },
                { id: 5, nama: "Gas Elpiji 3kg", harga: 25000, satuan: "tabung", stok: 10, status: 'tersedia', jumlah: 0 },
                { id: 6, nama: "Tikar", harga: 5000, satuan: "buah", stok: 40, status: 'tersedia', jumlah: 0 },
                { id: 7, nama: "Lampu Camping", harga: 10000, satuan: "unit", stok: 15, status: 'tersedia', jumlah: 0 },
                { id: 8, nama: "Kursi Lipat", harga: 8000, satuan: "buah", stok: 25, status: 'tersedia', jumlah: 0 },
            ],
            pengaturan: {
                perusahaan: {
                    nama: "Bukit Sampalan Asri",
                    alamat: "Sukamaju, Cihaurbeuti, Ciamis",
                    hargaTiket: 15000,
                    namaBank: "Bank BRI",
                    norek: "4045-0100-1680-532",
                    anRekening: "SUNARYA",
                    noLayanan: "+62812-9639-2270",
                },
                maxLapakPerReservasi: 30,
                minReservasiHari: 1,
                maxReservasiHari: 7,
                dpPercentage: 50,
                jamCheckin: "14:00",
                jamCheckout: "12:00",
                dendaKeterlambatan: 50000,
            },
            users: [
                { id: 1, nama: 'Admin Utama', username: 'admin', password: 'admin123', role: 'admin' },
                { id: 2, nama: 'Staff Reservasi', username: 'staff', password: 'staff123', role: 'staff' },
                { id: 3, nama: 'Manager Operasional', username: 'manager', password: 'manager123', role: 'manager' },
            ],
            user: null,
        };

        // Load data dari localStorage
        function loadFromLocalStorage() {
            try {
                const storedData = localStorage.getItem('reservasiDataBSA');
                if (storedData) {
                    const loadedData = JSON.parse(storedData);
                    
                    // Merge data dengan hati-hati
                    dataApp.reservasi = loadedData.reservasi || [];
                    dataApp.invoice = loadedData.invoice || [];
                    dataApp.lapakTenda = loadedData.lapakTenda || dataApp.lapakTenda;
                    dataApp.glamping = loadedData.glamping || dataApp.glamping;
                    dataApp.barangSewa = loadedData.barangSewa || dataApp.barangSewa;
                    dataApp.akomodasiLainnya = loadedData.akomodasiLainnya || dataApp.akomodasiLainnya;
                    dataApp.users = loadedData.users || dataApp.users;
                    
                    // Pastikan pengaturan ada
                    if (loadedData.pengaturan) {
                        dataApp.pengaturan = { ...dataApp.pengaturan, ...loadedData.pengaturan };
                        if (loadedData.pengaturan.perusahaan) {
                            dataApp.pengaturan.perusahaan = { ...dataApp.pengaturan.perusahaan, ...loadedData.pengaturan.perusahaan };
                        }
                    }
                    
                    // Validasi data penting
                    if (!dataApp.lapakTenda || dataApp.lapakTenda.length === 0) {
                        // Reset ke data default jika data lapak kosong
                        dataApp.lapakTenda = [
                            { kode: 'D01', harga: 0, kapasitas: 4, status: 'tersedia' },
                            { kode: 'D02', harga: 0, kapasitas: 4, status: 'tersedia' },
                            { kode: 'D03', harga: 0, kapasitas: 4, status: 'tersedia' },
                        ];
                    }
                    
                    if (!dataApp.glamping || dataApp.glamping.length === 0) {
                        dataApp.glamping = [
                            { kode: 'G01', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                            { kode: 'G02', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                        ];
                    }
                }
            } catch (e) {
                console.error('Error loading from localStorage:', e);
                // Tetap gunakan data default jika error
            }
        }

        // Save data ke localStorage dan Firebase
        function saveToLocalStorage() {
            try {
                const dataToSave = {
                    reservasi: dataApp.reservasi,
                    invoice: dataApp.invoice,
                    lapakTenda: dataApp.lapakTenda,
                    glamping: dataApp.glamping,
                    barangSewa: dataApp.barangSewa,
                    akomodasiLainnya: dataApp.akomodasiLainnya,
                    pengaturan: dataApp.pengaturan,
                    users: dataApp.users,
                    lastBackup: new Date().toISOString()
                };
                localStorage.setItem('reservasiDataBSA', JSON.stringify(dataToSave));
                
                // Sync to Firebase if enabled
                syncToFirebase();
            } catch (e) {
                console.error('Error saving to localStorage:', e);
                alert('Gagal menyimpan data ke localStorage. Kemungkinan storage penuh.');
            }
        }

        // --- Authentication ---

        function login() {
            const usernameInput = document.getElementById('username').value.trim();
            const passwordInput = document.getElementById('password').value;
            const errorElement = document.getElementById('login-error');

            if (!usernameInput || !passwordInput) {
                errorElement.textContent = 'Harap isi username dan password!';
                errorElement.classList.remove('hidden');
                return;
            }

            const user = dataApp.users.find(u => u.username === usernameInput && u.password === passwordInput);

            if (user) {
                dataApp.user = user;
                errorElement.classList.add('hidden');
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                
                // Check Firebase connection
                checkFirebaseConnection();
                
                // Load data from Firebase if available
                showLoadingModal('Memuat data...');
                loadFromFirebase().then((firebaseLoaded) => {
                    if (firebaseLoaded) {
                        console.log("Data loaded from Firebase successfully");
                    } else {
                        console.log("Using local data");
                    }
                    initializeApp();
                    hideLoadingModal();
                }).catch(() => {
                    initializeApp();
                    hideLoadingModal();
                });
            } else {
                errorElement.textContent = 'Username atau password salah!';
                errorElement.classList.remove('hidden');
            }
        }

        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                dataApp.user = null;
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('login-form').reset();
                document.getElementById('login-error').classList.add('hidden');
                
                // Close mobile menu if open
                document.getElementById('main-nav').classList.remove('active');
            }
        }

        // --- Initialization ---

        function initializeApp() {
            const user = dataApp.user;
            if (!user) return;

            document.getElementById('current-user').textContent = user.nama;
            let roleText = '';
            if (user.role === 'admin') roleText = 'Admin';
            else if (user.role === 'manager') roleText = 'Manager';
            else roleText = 'Staff';
            document.getElementById('user-role').textContent = roleText;
            document.getElementById('user-avatar').textContent = user.nama.charAt(0).toUpperCase();
            
            const avatar = document.getElementById('user-avatar');
            if (user.role === 'admin') {
                avatar.style.backgroundColor = '#9c27b0';
            } else if (user.role === 'manager') {
                avatar.style.backgroundColor = '#2196f3';
            } else {
                avatar.style.backgroundColor = '#ff9800';
            }

            document.querySelectorAll('.admin-only').forEach(el => {
                if (user.role !== 'admin') {
                    el.classList.add('hidden');
                } else {
                    el.classList.remove('hidden');
                }
            });

            // Set today's date for filters
            const today = formatDate(new Date());
            document.getElementById('filter-tanggal').value = today;
            document.getElementById('tanggal-visualisasi').value = today;

            showSection('dashboard');

            // Update all displays
            updateDashboard();
            updateLapakStatus();
            updateGlampingStatus();
            updateLapakVisualization();
            generateInvoiceList();
            filterLaporan();
            generatePengaturanLapak();
            generatePengaturanGlamping();
            generatePengaturanBarang();
            generatePengaturanAkomodasi();
            generateUsersList();
            loadInvoiceOptions();
            loadPengaturanData();
            
            // Initialize akomodasi selection
            generateAkomodasiOptions('tenda');
            generateAkomodasiOptions('glamping');
            
            // Update footer info
            document.getElementById('footer-no-layanan').textContent = dataApp.pengaturan.perusahaan.noLayanan;
            
            // Hide mobile menu on initialization
            document.getElementById('main-nav').classList.remove('active');
            
            // Update backup counts
            updateBackupCounts();
            
            // Show Firebase status
            if (firebaseEnabled) {
                console.log("Firebase sync enabled");
            } else {
                console.log("Firebase sync disabled - using local storage only");
            }
        }

        function showSection(sectionId) {
            const nav = document.getElementById('main-nav');
            nav.classList.remove('active');

            const user = dataApp.user;
            if (!user) return;

            if ((sectionId === 'pengaturan' || sectionId === 'users' || sectionId === 'backup') && user.role !== 'admin') {
                alert('Hanya Admin yang dapat mengakses halaman ini!');
                return;
            }

            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            document.getElementById(sectionId + '-section').classList.remove('hidden');

            document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
            const activeNav = document.querySelector(`nav a[onclick="showSection('${sectionId}')"]`);
            if (activeNav) {
                activeNav.classList.add('active');
            }

            if (sectionId === 'reservasi') {
                const today = formatDate(new Date());
                const nextDay = formatDate(new Date(new Date().getTime() + 24 * 60 * 60 * 1000));
                
                document.getElementById('tanggal-checkin-tenda').value = today;
                document.getElementById('tanggal-checkout-tenda').value = nextDay;
                document.getElementById('tanggal-checkin-glamping').value = today;
                document.getElementById('tanggal-checkout-glamping').value = nextDay;

                document.getElementById('max-lapak-info').textContent = dataApp.pengaturan.maxLapakPerReservasi;
                document.getElementById('dp-percentage-info-tenda').textContent = dataApp.pengaturan.dpPercentage;
                document.getElementById('dp-percentage-info-glamping').textContent = dataApp.pengaturan.dpPercentage;

                hitungJumlahMalam('tenda');
                hitungJumlahMalam('glamping');
                updateLapakStatus();
                updateGlampingStatus();
                
                // Reset akomodasi selection
                dataApp.akomodasiLainnya.forEach(akomodasi => {
                    akomodasi.status = 'tersedia';
                    akomodasi.jumlah = 0;
                });
                generateAkomodasiOptions('tenda');
                generateAkomodasiOptions('glamping');
            } else if (sectionId === 'lapak') {
                document.getElementById('tanggal-visualisasi').value = formatDate(new Date());
                updateLapakVisualization();
            } else if (sectionId === 'invoice') {
                generateInvoiceList();
                loadInvoiceOptions();
            } else if (sectionId === 'laporan') {
                filterLaporan();
            } else if (sectionId === 'pengaturan') {
                loadPengaturanData();
                generatePengaturanLapak();
                generatePengaturanGlamping();
                generatePengaturanBarang();
                generatePengaturanAkomodasi();
            } else if (sectionId === 'users') {
                generateUsersList();
            } else if (sectionId === 'backup') {
                updateBackupCounts();
            }
            
            // Scroll to top when changing sections
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function toggleMobileMenu() {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('active');
            
            // Toggle icon
            const menuIcon = document.querySelector('.menu-toggle i');
            if (nav.classList.contains('active')) {
                menuIcon.classList.remove('fa-bars');
                menuIcon.classList.add('fa-times');
            } else {
                menuIcon.classList.remove('fa-times');
                menuIcon.classList.add('fa-bars');
            }
        }

        // --- Dashboard & Status ---

        function getReservedCodes(jenis, tanggal) {
            const reserved = [];
            if (!tanggal) return reserved;

            dataApp.reservasi.forEach(r => {
                if (r.jenis === jenis && (r.status === 'dibayar' || r.status === 'aktif' || r.status === 'pending')) {
                    const checkin = r.tanggalCheckin;
                    const checkout = r.tanggalCheckout;
                    
                    if (tanggal >= checkin && tanggal < checkout) {
                        if (jenis === 'tenda') {
                            if (Array.isArray(r.lapak)) {
                                reserved.push(...r.lapak);
                            }
                        } else {
                            if (Array.isArray(r.glamping)) {
                                reserved.push(...r.glamping);
                            }
                        }
                    }
                }
            });
            return [...new Set(reserved)];
        }

        function updateDashboard() {
            const today = formatDate(new Date());
            const filterDate = document.getElementById('filter-tanggal').value || today;

            let lapakTerpakai = 0;
            let glampingTerpakai = 0;
            let pengunjungHariIni = 0;
            let omzetHarian = 0;

            const reservedLapak = getReservedCodes('tenda', filterDate);
            const reservedGlamping = getReservedCodes('glamping', filterDate);

            lapakTerpakai = reservedLapak.length;
            glampingTerpakai = reservedGlamping.length;

            dataApp.reservasi.forEach(r => {
                if (r.status === 'aktif' || r.status === 'dibayar' || r.status === 'pending') {
                    const checkin = r.tanggalCheckin;
                    const checkout = r.tanggalCheckout;
                    if (filterDate >= checkin && filterDate < checkout) {
                        pengunjungHariIni += parseInt(r.jumlahOrang) || 0;
                    }
                }
            });

            const hariIniFormatted = formatDate(new Date());
            dataApp.invoice.forEach(inv => {
                if (inv.status === 'selesai' && inv.tanggalSelesai === hariIniFormatted) {
                    omzetHarian += parseInt(inv.totalBiaya) || 0;
                }
                if ((inv.status === 'pending' || inv.status === 'dibayar') && inv.tanggalReservasi === hariIniFormatted) {
                    if (inv.paymentMethod === 'transfer' || inv.paymentMethod === 'sekarang') {
                        omzetHarian += parseInt(inv.dp) || 0; 
                    }
                }
                if (inv.status === 'dibayar' && inv.tanggalReservasi === hariIniFormatted && (inv.paymentMethod === 'lokasi')) {
                    omzetHarian += parseInt(inv.totalBiaya) || 0;
                }
            });

            const startOfMonth = formatDate(new Date(new Date().getFullYear(), new Date().getMonth(), 1));
            const reservasiBulanIni = dataApp.reservasi.filter(r => r.tanggalReservasi >= startOfMonth).length;

            const totalLapak = dataApp.lapakTenda.length;
            const totalGlamping = dataApp.glamping.length;

            const lapakTersediaHariIni = totalLapak - lapakTerpakai;
            const glampingTersediaHariIni = totalGlamping - glampingTerpakai;

            document.getElementById('lapak-tersedia').textContent = lapakTersediaHariIni;
            document.getElementById('lapak-terpakai').textContent = lapakTerpakai;
            document.getElementById('glamping-terpakai').textContent = glampingTerpakai;
            document.getElementById('pengunjung-hari-ini').textContent = pengunjungHariIni;
            document.getElementById('omzet-harian').textContent = formatRupiah(omzetHarian);
            document.getElementById('reservasi-bulan-ini').textContent = reservasiBulanIni;

            const lapakContainer = document.getElementById('lapak-status-container');
            const glampingContainer = document.getElementById('glamping-status-container');
            
            lapakContainer.innerHTML = '';
            dataApp.lapakTenda.forEach(lapak => {
                const isReserved = reservedLapak.includes(lapak.kode);
                const item = document.createElement('div');
                item.classList.add('lapak-item', isReserved ? 'lapak-terpakai' : 'lapak-tersedia');
                item.textContent = lapak.kode;
                
                const tooltip = document.createElement('span');
                tooltip.classList.add('lapak-tooltip');
                tooltip.textContent = isReserved ? 'Terpakai' : `Tersedia. Harga: ${formatRupiah(lapak.harga)}/malam`;
                item.appendChild(tooltip);
                
                lapakContainer.appendChild(item);
            });
            
            glampingContainer.innerHTML = '';
            dataApp.glamping.forEach(glamping => {
                const isReserved = reservedGlamping.includes(glamping.kode);
                const item = document.createElement('div');
                item.classList.add('lapak-item', isReserved ? 'lapak-terpakai' : 'lapak-tersedia');
                item.textContent = glamping.kode;
                
                const tooltip = document.createElement('span');
                tooltip.classList.add('lapak-tooltip');
                tooltip.textContent = isReserved ? 'Terpakai' : `Tersedia. ${glamping.nama} (${glamping.kapasitas} pax). Harga: ${formatRupiah(glamping.harga)}/malam`;
                item.appendChild(tooltip);
                
                glampingContainer.appendChild(item);
            });
        }

        // --- Reservasi Form ---

        function hitungJumlahMalam(jenis) {
            const checkinInput = document.getElementById(`tanggal-checkin-${jenis}`);
            const checkoutInput = document.getElementById(`tanggal-checkout-${jenis}`);
            const malamInput = document.getElementById(`jumlah-malam-${jenis}`);
            
            if (!checkinInput.value || !checkoutInput.value) {
                malamInput.value = dataApp.pengaturan.minReservasiHari;
                return;
            }
            
            const checkin = new Date(checkinInput.value + 'T' + dataApp.pengaturan.jamCheckin);
            const checkout = new Date(checkoutInput.value + 'T' + dataApp.pengaturan.jamCheckout);

            const minReservasi = dataApp.pengaturan.minReservasiHari;
            const maxReservasi = dataApp.pengaturan.maxReservasiHari;

            if (checkout <= checkin) {
                alert('Tanggal Check-out harus setelah tanggal Check-in.');
                malamInput.value = minReservasi;
                const newCheckout = new Date(checkin.getTime() + minReservasi * 24 * 60 * 60 * 1000);
                checkoutInput.value = formatDate(newCheckout);
            } else {
                const diffTime = Math.abs(checkout - checkin);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < minReservasi) {
                    alert(`Minimal reservasi adalah ${minReservasi} malam.`);
                    malamInput.value = minReservasi;
                    const newCheckout = new Date(checkin.getTime() + minReservasi * 24 * 60 * 60 * 1000);
                    checkoutInput.value = formatDate(newCheckout);
                } else if (diffDays > maxReservasi) {
                    alert(`Maksimal reservasi adalah ${maxReservasi} malam.`);
                    malamInput.value = maxReservasi;
                    const newCheckout = new Date(checkin.getTime() + maxReservasi * 24 * 60 * 60 * 1000);
                    checkoutInput.value = formatDate(newCheckout);
                } else {
                    malamInput.value = diffDays;
                }
            }

            if (jenis === 'tenda') {
                updateLapakStatus();
                hitungTotalBiayaTenda();
            } else {
                updateGlampingStatus();
                hitungTotalBiayaGlamping();
            }
        }

        function updateLapakStatus() {
            const tanggalCheckin = document.getElementById('tanggal-checkin-tenda').value;
            const lapakContainer = document.getElementById('lapak-pilih-container');
            lapakContainer.innerHTML = '';

            // Reset status dipilih
            dataApp.lapakTenda.forEach(lapak => {
                if (lapak.status === 'dipilih') {
                    lapak.status = 'tersedia';
                }
            });

            const lapakTerpakai = getReservedCodes('tenda', tanggalCheckin);

            dataApp.lapakTenda.forEach(lapak => {
                const isTerpakai = lapakTerpakai.includes(lapak.kode);
                const lapakItem = document.createElement('div');
                lapakItem.id = `lapak-${lapak.kode}`;
                lapakItem.classList.add('lapak-item', isTerpakai ? 'lapak-terpakai' : 'lapak-tersedia');
                lapakItem.textContent = lapak.kode;
                lapakItem.dataset.kode = lapak.kode;
                lapakItem.dataset.isTerpakai = isTerpakai;

                if (!isTerpakai) {
                    lapakItem.onclick = () => toggleLapakSelection(lapak.kode);
                } else {
                    lapakItem.classList.add('disabled');
                }
                
                const tooltip = document.createElement('span');
                tooltip.classList.add('lapak-tooltip');
                tooltip.textContent = isTerpakai ? 'Sudah Terpakai' : `Tersedia. Harga: ${formatRupiah(lapak.harga)}/malam`;
                lapakItem.appendChild(tooltip);

                lapakContainer.appendChild(lapakItem);
            });
            hitungTotalBiayaTenda();
        }

        function updateGlampingStatus() {
            const tanggalCheckin = document.getElementById('tanggal-checkin-glamping').value;
            const glampingContainer = document.getElementById('glamping-pilih-container');
            glampingContainer.innerHTML = '';

            // Reset status dipilih
            dataApp.glamping.forEach(glamping => {
                if (glamping.status === 'dipilih') {
                    glamping.status = 'tersedia';
                }
            });

            const glampingTerpakai = getReservedCodes('glamping', tanggalCheckin);

            dataApp.glamping.forEach(glamping => {
                const isTerpakai = glampingTerpakai.includes(glamping.kode);
                const isSelected = glamping.status === 'dipilih';
                
                const optionDiv = document.createElement('div');
                optionDiv.id = `glamping-${glamping.kode}-option`;
                optionDiv.classList.add('glamping-option', 'text-center');
                if (isTerpakai) {
                    optionDiv.classList.add('disabled');
                    optionDiv.style.backgroundColor = 'var(--danger-color)';
                    optionDiv.style.color = 'white';
                } else if (isSelected) {
                    optionDiv.classList.add('selected');
                }
                optionDiv.dataset.kode = glamping.kode;

                if (!isTerpakai) {
                    optionDiv.onclick = () => toggleGlampingSelection(glamping.kode);
                    if (!isSelected) {
                        optionDiv.style.backgroundColor = 'white';
                    }
                }

                optionDiv.innerHTML = `
                    <div style="font-size: 1rem; font-weight: bold; margin-bottom: 4px;">${glamping.kode}</div>
                    <div style="font-size: 0.75rem; margin-bottom: 4px;">${glamping.nama}</div>
                    <div style="font-size: 0.85rem; font-weight: 500;">${formatRupiah(glamping.harga)}/malam</div>
                    <div style="font-size: 0.7rem; color: ${isTerpakai ? 'white' : 'var(--gray-color)'};">Kapasitas: ${glamping.kapasitas} orang</div>
                    <div style="font-size: 0.65rem; margin-top: 4px;">${isTerpakai ? '<span class="badge badge-danger">TERPAKAI</span>' : '<span class="badge badge-success">TERSEDIA</span>'}</div>
                `;
                
                glampingContainer.appendChild(optionDiv);
            });
            hitungTotalBiayaGlamping();
        }

        function toggleLapakSelection(kode) {
            const lapak = dataApp.lapakTenda.find(l => l.kode === kode);
            const element = document.getElementById(`lapak-${kode}`);
            const maxLapak = dataApp.pengaturan.maxLapakPerReservasi;
            
            if (!lapak || !element) return;
            
            if (lapak.status === 'tersedia') {
                const selectedCount = dataApp.lapakTenda.filter(l => l.status === 'dipilih').length;
                if (selectedCount >= maxLapak) {
                    alert(`Maksimal lapak yang dapat dipilih adalah ${maxLapak}.`);
                    return;
                }
                lapak.status = 'dipilih';
                element.classList.remove('lapak-tersedia');
                element.classList.add('lapak-dipilih');
            } else if (lapak.status === 'dipilih') {
                lapak.status = 'tersedia';
                element.classList.remove('lapak-dipilih');
                element.classList.add('lapak-tersedia');
            }
            hitungTotalBiayaTenda();
        }

        function toggleGlampingSelection(kode) {
            const glamping = dataApp.glamping.find(g => g.kode === kode);
            const element = document.getElementById(`glamping-${kode}-option`);
            const maxLapak = dataApp.pengaturan.maxLapakPerReservasi;

            if (!glamping || !element) return;

            if (glamping.status === 'tersedia') {
                const selectedCount = dataApp.glamping.filter(g => g.status === 'dipilih').length;
                if (selectedCount >= maxLapak) {
                    alert(`Maksimal glamping yang dapat dipilih adalah ${maxLapak}.`);
                    return;
                }
                glamping.status = 'dipilih';
                element.classList.add('selected');
            } else if (glamping.status === 'dipilih') {
                glamping.status = 'tersedia';
                element.classList.remove('selected');
            }
            hitungTotalBiayaGlamping();
        }

        // Akomodasi Lainnya Functions
        function generateAkomodasiOptions(jenis) {
            const container = document.getElementById(`akomodasi-${jenis}-container`);
            if (!container) return;
            
            container.innerHTML = '';
            
            dataApp.akomodasiLainnya.forEach((akomodasi, index) => {
                const item = document.createElement('div');
                item.className = 'akomodasi-item';
                item.dataset.id = akomodasi.id;
                
                const checkboxId = `akomodasi-${jenis}-${akomodasi.id}`;
                const isSelected = akomodasi.status === 'dipilih';
                
                item.innerHTML = `
                    <div class="akomodasi-checkbox">
                        <input type="checkbox" id="${checkboxId}" data-id="${akomodasi.id}" 
                            ${isSelected ? 'checked' : ''}
                            onchange="toggleAkomodasiSelection(${akomodasi.id}, '${jenis}')">
                        <label for="${checkboxId}" style="font-weight: bold; cursor: pointer; font-size: 0.9rem;">${akomodasi.nama}</label>
                    </div>
                    <div style="font-size: 0.8rem; color: var(--gray-color); margin: 4px 0;">
                        Satuan: ${akomodasi.satuan} | Stok: ${akomodasi.stok}
                    </div>
                    <div class="akomodasi-price">${formatRupiah(akomodasi.harga)}</div>
                    <div id="jumlah-akomodasi-${jenis}-${akomodasi.id}" style="display: ${isSelected ? 'block' : 'none'}; margin-top: 5px;">
                        <label for="qty-${checkboxId}" style="font-size: 0.8rem;">Jumlah:</label>
                        <input type="number" id="qty-${checkboxId}" class="form-control" 
                            style="padding: 4px; font-size: 0.85rem;" 
                            min="1" max="${akomodasi.stok}" value="${akomodasi.jumlah || 1}"
                            onchange="updateAkomodasiJumlah(${akomodasi.id}, '${jenis}')"
                            onkeyup="updateAkomodasiJumlah(${akomodasi.id}, '${jenis}')">
                    </div>
                `;
                
                if (isSelected) {
                    item.classList.add('selected');
                }
                
                container.appendChild(item);
            });
        }
        
        function toggleAkomodasiSelection(id, jenis) {
            const akomodasi = dataApp.akomodasiLainnya.find(a => a.id === id);
            if (!akomodasi) return;
            
            const checkbox = document.querySelector(`#akomodasi-${jenis}-container input[data-id="${id}"]`);
            const jumlahDiv = document.getElementById(`jumlah-akomodasi-${jenis}-${id}`);
            const itemDiv = checkbox.closest('.akomodasi-item');
            
            if (checkbox.checked) {
                akomodasi.status = 'dipilih';
                akomodasi.jumlah = akomodasi.jumlah || 1;
                jumlahDiv.style.display = 'block';
                itemDiv.classList.add('selected');
            } else {
                akomodasi.status = 'tersedia';
                akomodasi.jumlah = 0;
                jumlahDiv.style.display = 'none';
                itemDiv.classList.remove('selected');
            }
            
            if (jenis === 'tenda') {
                hitungTotalBiayaTenda();
            } else {
                hitungTotalBiayaGlamping();
            }
        }
        
        function updateAkomodasiJumlah(id, jenis) {
            const akomodasi = dataApp.akomodasiLainnya.find(a => a.id === id);
            if (!akomodasi) return;
            
            const input = document.querySelector(`#akomodasi-${jenis}-container input#qty-akomodasi-${jenis}-${id}`);
            if (!input) return;
            
            const jumlah = parseInt(input.value) || 1;
            if (jumlah < 1) {
                input.value = 1;
                akomodasi.jumlah = 1;
            } else if (jumlah > akomodasi.stok) {
                input.value = akomodasi.stok;
                akomodasi.jumlah = akomodasi.stok;
                alert(`Jumlah melebihi stok yang tersedia. Maksimal: ${akomodasi.stok}`);
            } else {
                akomodasi.jumlah = jumlah;
            }
            
            if (jenis === 'tenda') {
                hitungTotalBiayaTenda();
            } else {
                hitungTotalBiayaGlamping();
            }
        }

        function changeReservasiTab(tabElement, target) {
            document.querySelectorAll('#reservasi-section .tabs .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#reservasi-section .tab-content').forEach(content => content.classList.remove('active'));
            tabElement.classList.add('active');
            document.getElementById(`tab-${target}`).classList.add('active');

            if (target === 'tenda') {
                updateLapakStatus();
                hitungTotalBiayaTenda();
            } else if (target === 'glamping') {
                updateGlampingStatus();
                hitungTotalBiayaGlamping();
            }
        }
        
        function selectPaymentMethod(method, jenis) {
            document.querySelectorAll(`#reservasi-${jenis}-form .payment-option`).forEach(opt => opt.classList.remove('selected'));
            document.getElementById(`payment-${method}-${jenis}`).classList.add('selected');

            const dpRow = document.getElementById(`dp-row-${jenis}`);
            if (method === 'transfer') {
                dpRow.style.display = 'table-row';
            } else {
                dpRow.style.display = 'none';
            }
        }

        function hitungTotalBiayaTenda() {
            const lapakTerpilih = dataApp.lapakTenda.filter(lapak => lapak.status === 'dipilih');
            const jumlahMalam = parseInt(document.getElementById('jumlah-malam-tenda').value) || 0;
            const jumlahOrang = parseInt(document.getElementById('jumlah-orang-tenda').value) || 0;
            const hargaTiket = dataApp.pengaturan.perusahaan.hargaTiket;
            const dpPercentage = dataApp.pengaturan.dpPercentage;

            let totalBiayaLapak = 0;
            lapakTerpilih.forEach(lapak => {
                totalBiayaLapak += (lapak.harga || 0) * jumlahMalam;
            });

            const totalBiayaTiket = jumlahOrang * jumlahMalam * hargaTiket;
            
            // Hitung biaya akomodasi lainnya
            let totalBiayaAkomodasi = 0;
            const akomodasiTerpilih = dataApp.akomodasiLainnya.filter(a => a.status === 'dipilih' && a.jumlah > 0);
            akomodasiTerpilih.forEach(akomodasi => {
                totalBiayaAkomodasi += (akomodasi.harga || 0) * (akomodasi.jumlah || 0);
            });
            
            const totalBiaya = totalBiayaLapak + totalBiayaTiket + totalBiayaAkomodasi;
            const dp = totalBiaya * (dpPercentage / 100);

            document.getElementById('lapak-dipilih-tenda-count').textContent = lapakTerpilih.length;
            document.getElementById('jumlah-lapak-tenda').value = `${lapakTerpilih.length} Lapak`;
            
            document.getElementById('biaya-lapak-count').textContent = lapakTerpilih.length;
            document.getElementById('biaya-lapak-malam').textContent = jumlahMalam;
            document.getElementById('biaya-lapak-tenda').textContent = formatRupiah(totalBiayaLapak);
            
            document.getElementById('biaya-tiket-orang').textContent = jumlahOrang;
            document.getElementById('biaya-tiket-malam').textContent = jumlahMalam;
            document.getElementById('biaya-tiket-tenda').textContent = formatRupiah(totalBiayaTiket);
            
            // Update akomodasi display
            const akomodasiRow = document.getElementById('akomodasi-row-tenda');
            const akomodasiCount = akomodasiTerpilih.length;
            document.getElementById('akomodasi-dipilih-tenda-count').textContent = akomodasiCount;
            
            if (akomodasiCount > 0) {
                akomodasiRow.style.display = 'table-row';
                document.getElementById('biaya-akomodasi-tenda').textContent = formatRupiah(totalBiayaAkomodasi);
            } else {
                akomodasiRow.style.display = 'none';
            }
            
            document.getElementById('total-biaya-tenda').textContent = formatRupiah(totalBiaya);
            document.getElementById('dp-percentage-tenda').textContent = dpPercentage;
            document.getElementById('dp-tenda').textContent = formatRupiah(dp);
        }

        function hitungTotalBiayaGlamping() {
            const glampingTerpilih = dataApp.glamping.filter(glamping => glamping.status === 'dipilih');
            const jumlahMalam = parseInt(document.getElementById('jumlah-malam-glamping').value) || 0;
            const jumlahOrang = parseInt(document.getElementById('jumlah-orang-glamping').value) || 0;
            const hargaTiket = dataApp.pengaturan.perusahaan.hargaTiket;
            const dpPercentage = dataApp.pengaturan.dpPercentage;

            let totalBiayaGlamping = 0;
            glampingTerpilih.forEach(glamping => {
                totalBiayaGlamping += (glamping.harga || 0) * jumlahMalam;
            });

            const totalBiayaTiket = jumlahOrang * jumlahMalam * hargaTiket;
            
            // Hitung biaya akomodasi lainnya
            let totalBiayaAkomodasi = 0;
            const akomodasiTerpilih = dataApp.akomodasiLainnya.filter(a => a.status === 'dipilih' && a.jumlah > 0);
            akomodasiTerpilih.forEach(akomodasi => {
                totalBiayaAkomodasi += (akomodasi.harga || 0) * (akomodasi.jumlah || 0);
            });
            
            const totalBiaya = totalBiayaGlamping + totalBiayaTiket + totalBiayaAkomodasi;
            const dp = totalBiaya * (dpPercentage / 100);

            document.getElementById('glamping-dipilih-count').textContent = glampingTerpilih.length;
            document.getElementById('jumlah-glamping').value = `${glampingTerpilih.length} Unit`;

            document.getElementById('glamping-dipilih-count-biaya').textContent = glampingTerpilih.length;
            document.getElementById('biaya-glamping-malam').textContent = jumlahMalam;
            document.getElementById('biaya-glamping').textContent = formatRupiah(totalBiayaGlamping);
            
            document.getElementById('biaya-tiket-orang-glamping').textContent = jumlahOrang;
            document.getElementById('biaya-tiket-malam-glamping').textContent = jumlahMalam;
            document.getElementById('biaya-tiket-glamping').textContent = formatRupiah(totalBiayaTiket);
            
            // Update akomodasi display
            const akomodasiRow = document.getElementById('akomodasi-row-glamping');
            const akomodasiCount = akomodasiTerpilih.length;
            document.getElementById('akomodasi-dipilih-glamping-count').textContent = akomodasiCount;
            
            if (akomodasiCount > 0) {
                akomodasiRow.style.display = 'table-row';
                document.getElementById('biaya-akomodasi-glamping').textContent = formatRupiah(totalBiayaAkomodasi);
            } else {
                akomodasiRow.style.display = 'none';
            }
            
            document.getElementById('total-biaya-glamping').textContent = formatRupiah(totalBiaya);
            document.getElementById('dp-percentage-glamping').textContent = dpPercentage;
            document.getElementById('dp-glamping').textContent = formatRupiah(dp);
        }

        function submitReservasi(jenis) {
            const form = document.getElementById(`reservasi-${jenis}-form`);
            if (!form.checkValidity()) {
                alert('Harap lengkapi semua field yang wajib diisi.');
                form.reportValidity();
                return;
            }

            const isTenda = jenis === 'tenda';
            const selectedItems = isTenda ? dataApp.lapakTenda.filter(l => l.status === 'dipilih') : dataApp.glamping.filter(g => g.status === 'dipilih');

            if (selectedItems.length === 0) {
                alert(`Harap pilih minimal 1 ${jenis === 'tenda' ? 'lapak' : 'glamping'} untuk reservasi.`);
                return;
            }

            const nama = document.getElementById(`nama-${jenis}`).value.trim();
            const telepon = document.getElementById(`telepon-${jenis}`).value.trim();
            const email = document.getElementById(`email-${jenis}`).value.trim();
            const tanggalCheckin = document.getElementById(`tanggal-checkin-${jenis}`).value;
            const tanggalCheckout = document.getElementById(`tanggal-checkout-${jenis}`).value;
            const jumlahMalam = parseInt(document.getElementById(`jumlah-malam-${jenis}`).value) || 1;
            const jumlahOrang = parseInt(document.getElementById(`jumlah-orang-${jenis}`).value) || 1;
            
            const totalBiayaElement = document.getElementById(`total-biaya-${jenis}`).textContent;
            const totalBiaya = parseInt(totalBiayaElement.replace(/[^0-9]/g, '')) || 0;
            const dpElement = document.getElementById(`dp-${jenis}`).textContent;
            let dp = parseInt(dpElement.replace(/[^0-9]/g, '')) || 0;
            
            const paymentMethodElement = document.querySelector(`#reservasi-${jenis}-form .payment-option.selected`);
            const paymentMethod = paymentMethodElement ? paymentMethodElement.id.replace(`payment-`, '').replace(`-${jenis}`, '') : 'lokasi';

            let status = 'pending';
            if (paymentMethod === 'sekarang') {
                status = 'dibayar';
            } else if (paymentMethod === 'lokasi') {
                dp = 0;
                status = 'aktif';
            }

            // Get selected akomodasi
            const akomodasiTerpilih = dataApp.akomodasiLainnya
                .filter(a => a.status === 'dipilih' && a.jumlah > 0)
                .map(a => ({
                    id: a.id,
                    nama: a.nama,
                    harga: a.harga,
                    satuan: a.satuan,
                    jumlah: a.jumlah,
                    totalBiaya: (a.harga || 0) * (a.jumlah || 0)
                }));

            const newInvoice = {
                invoice: generateInvoiceCode(),
                tanggalReservasi: formatDate(new Date()),
                jenis: jenis,
                nama: nama,
                telepon: telepon,
                email: email || '',
                tanggalCheckin: tanggalCheckin,
                tanggalCheckout: tanggalCheckout,
                jumlahMalam: jumlahMalam,
                jumlahOrang: jumlahOrang,
                lapak: isTenda ? selectedItems.map(item => item.kode) : [],
                glamping: isTenda ? [] : selectedItems.map(item => item.kode),
                lapakDetail: isTenda ? selectedItems.map(item => ({ kode: item.kode, harga: item.harga })) : [],
                glampingDetail: isTenda ? [] : selectedItems.map(item => ({ kode: item.kode, nama: item.nama, harga: item.harga, kapasitas: item.kapasitas })),
                akomodasiLainnya: akomodasiTerpilih,
                totalBiaya: totalBiaya,
                dp: dp,
                sisaPembayaran: totalBiaya - dp,
                status: status,
                paymentMethod: paymentMethod,
                barangSewa: [],
                tanggalSelesai: null,
                namaPemandu: '',
                diskonTipe: 'none',
                diskonNilai: 0,
                diskonAmount: 0,
                catatan: ''
            };
            
            const newReservasi = {
                invoice: newInvoice.invoice,
                jenis: jenis,
                tanggalReservasi: newInvoice.tanggalReservasi,
                tanggalCheckin: tanggalCheckin,
                tanggalCheckout: tanggalCheckout,
                jumlahOrang: jumlahOrang,
                lapak: newInvoice.lapak,
                glamping: newInvoice.glamping,
                status: status,
            };

            // Reset selected items status
            selectedItems.forEach(item => {
                item.status = 'tersedia';
            });
            
            // Reset akomodasi selection
            dataApp.akomodasiLainnya.forEach(akomodasi => {
                akomodasi.status = 'tersedia';
                akomodasi.jumlah = 0;
            });
            
            dataApp.reservasi.push(newReservasi);
            dataApp.invoice.push(newInvoice);
            saveToLocalStorage();

            form.reset();
            
            // Reset to default dates
            const today = formatDate(new Date());
            const nextDay = formatDate(new Date(new Date().getTime() + 24 * 60 * 60 * 1000));
            
            document.getElementById(`tanggal-checkin-${jenis}`).value = today;
            document.getElementById(`tanggal-checkout-${jenis}`).value = nextDay;
            document.getElementById(`jumlah-malam-${jenis}`).value = dataApp.pengaturan.minReservasiHari;
            
            if (isTenda) {
                updateLapakStatus();
                generateAkomodasiOptions('tenda');
            } else {
                updateGlampingStatus();
                generateAkomodasiOptions('glamping');
            }
            
            updateDashboard();
            generateInvoiceList();

            alert(`Reservasi ${newInvoice.invoice} berhasil dibuat! Status: ${newInvoice.status.toUpperCase()}. Total Biaya: ${formatRupiah(totalBiaya)}.`);
            
            showInvoiceModal(newInvoice.invoice);
        }

        // --- Invoice Section ---
        
        function generateInvoiceList() {
            const tbody = document.getElementById('invoice-list');
            tbody.innerHTML = '';
            
            const filterKeyword = document.getElementById('cari-invoice').value.toLowerCase();
            const filterStatus = document.getElementById('filter-status').value;
            const filterJenis = document.getElementById('filter-jenis').value;

            const filteredInvoices = dataApp.invoice.filter(invoice => {
                const keywordMatch = invoice.invoice.toLowerCase().includes(filterKeyword) ||
                                     (invoice.nama && invoice.nama.toLowerCase().includes(filterKeyword)) ||
                                     (invoice.telepon && invoice.telepon.includes(filterKeyword));
                
                const statusMatch = filterStatus === '' || invoice.status === filterStatus;
                
                const jenisMatch = filterJenis === '' || invoice.jenis === filterJenis;

                return keywordMatch && statusMatch && jenisMatch;
            });

            filteredInvoices.sort((a, b) => new Date(b.tanggalReservasi) - new Date(a.tanggalReservasi));

            filteredInvoices.forEach(invoice => {
                let statusBadge;
                if (invoice.status === 'pending') statusBadge = '<span class="badge badge-warning">Pending (DP)</span>';
                else if (invoice.status === 'dibayar') statusBadge = '<span class="badge badge-primary">Dibayar (DP/Lunas)</span>';
                else if (invoice.status === 'aktif') statusBadge = '<span class="badge badge-success">Aktif (Check-in)</span>';
                else if (invoice.status === 'selesai') statusBadge = '<span class="badge badge-secondary">Selesai (Check-out)</span>';
                else statusBadge = '<span class="badge badge-danger">Dibatalkan</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${invoice.invoice}</td>
                    <td>${invoice.nama || ''}</td>
                    <td>${invoice.jenis ? invoice.jenis.charAt(0).toUpperCase() + invoice.jenis.slice(1) : ''}</td>
                    <td>${formatRupiah(invoice.totalBiaya || 0)}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDateID(invoice.tanggalReservasi)}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="showInvoiceModal('${invoice.invoice}')">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function cariInvoice() {
            generateInvoiceList();
        }
        
        function showInvoiceModal(invoiceNumber) {
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            if (!invoice) return;

            document.getElementById('modal-invoice-number').textContent = invoiceNumber;
            const content = document.getElementById('invoice-detail-content');
            content.innerHTML = generateInvoiceHTML(invoice);
            
            // Show/hide buttons based on invoice status
            document.getElementById('btn-batalkan-invoice').style.display = (invoice.status === 'pending' || invoice.status === 'dibayar') ? 'inline-flex' : 'none';
            document.getElementById('btn-checkin-invoice').style.display = (invoice.status === 'dibayar' || invoice.status === 'pending') ? 'inline-flex' : 'none';
            document.getElementById('btn-checkout-invoice').style.display = (invoice.status === 'aktif') ? 'inline-flex' : 'none';
            document.getElementById('btn-update-pembayaran').style.display = (invoice.status === 'pending' || invoice.status === 'dibayar') ? 'inline-flex' : 'none';

            // Reset edit form
            document.getElementById('invoice-edit-form').classList.add('hidden');
            document.getElementById('btn-edit-invoice').innerHTML = '<i class="fas fa-edit"></i> Edit Invoice';

            document.getElementById('invoice-modal').style.display = 'flex';
        }

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
            generateInvoiceList();
        }

        // FITUR BARU: EDIT INVOICE DENGAN DISKON DAN PEMANDU
        function toggleEditInvoiceForm() {
            const editForm = document.getElementById('invoice-edit-form');
            const invoiceNumber = document.getElementById('modal-invoice-number').textContent;
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            
            if (!invoice) return;
            
            if (editForm.classList.contains('hidden')) {
                // Show edit form
                document.getElementById('edit-nama-pemandu').value = invoice.namaPemandu || '';
                document.getElementById('edit-diskon-tipe').value = invoice.diskonTipe || 'none';
                document.getElementById('edit-diskon-nilai').value = invoice.diskonNilai || 0;
                document.getElementById('edit-catatan').value = invoice.catatan || '';
                
                toggleDiskonType();
                editForm.classList.remove('hidden');
                document.getElementById('btn-edit-invoice').innerHTML = '<i class="fas fa-times"></i> Tutup Edit';
            } else {
                // Hide edit form
                editForm.classList.add('hidden');
                document.getElementById('btn-edit-invoice').innerHTML = '<i class="fas fa-edit"></i> Edit Invoice';
            }
        }

        function toggleDiskonType() {
            const diskonTipe = document.getElementById('edit-diskon-tipe').value;
            const diskonInfo = document.getElementById('diskon-info');
            
            if (diskonTipe === 'none') {
                diskonInfo.classList.add('hidden');
                document.getElementById('edit-diskon-nilai').value = 0;
                document.getElementById('edit-diskon-nilai').disabled = true;
            } else {
                diskonInfo.classList.remove('hidden');
                document.getElementById('edit-diskon-nilai').disabled = false;
                
                if (diskonTipe === 'percentage') {
                    diskonInfo.innerHTML = '<i class="fas fa-percentage"></i> Diskon persentase akan diterapkan pada total biaya sebelum DP. Maksimal 100%.';
                    document.getElementById('edit-diskon-nilai').max = 100;
                } else {
                    diskonInfo.innerHTML = '<i class="fas fa-money-bill-wave"></i> Diskon nominal tetap akan dikurangkan dari total biaya sebelum DP.';
                    document.getElementById('edit-diskon-nilai').max = '';
                }
            }
        }

        function hitungDiskon() {
            // Akan dihitung saat simpan
        }

        function simpanEditInvoice() {
            const invoiceNumber = document.getElementById('modal-invoice-number').textContent;
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            
            if (!invoice) return;
            
            // Get values from form
            invoice.namaPemandu = document.getElementById('edit-nama-pemandu').value;
            invoice.diskonTipe = document.getElementById('edit-diskon-tipe').value;
            invoice.diskonNilai = parseFloat(document.getElementById('edit-diskon-nilai').value) || 0;
            invoice.catatan = document.getElementById('edit-catatan').value;
            
            // Calculate discount
            let diskonAmount = 0;
            let totalBiayaSebelumDiskon = invoice.totalBiaya || 0;
            
            // Kurangi biaya sewa barang untuk perhitungan diskon (jika ada)
            let totalBiayaSewaBarang = 0;
            if (invoice.barangSewa && invoice.barangSewa.length > 0) {
                invoice.barangSewa.forEach(sewa => {
                    totalBiayaSewaBarang += sewa.totalBiaya || 0;
                });
            }
            
            totalBiayaSebelumDiskon -= totalBiayaSewaBarang;
            
            if (invoice.diskonTipe === 'percentage' && invoice.diskonNilai > 0) {
                diskonAmount = totalBiayaSebelumDiskon * (invoice.diskonNilai / 100);
            } else if (invoice.diskonTipe === 'fixed' && invoice.diskonNilai > 0) {
                diskonAmount = invoice.diskonNilai;
            }
            
            // Ensure discount doesn't exceed total
            if (diskonAmount > totalBiayaSebelumDiskon) {
                diskonAmount = totalBiayaSebelumDiskon;
            }
            
            invoice.diskonAmount = diskonAmount;
            
            // Recalculate total with discount
            invoice.totalBiaya = totalBiayaSebelumDiskon - diskonAmount + totalBiayaSewaBarang;
            
            // Recalculate DP if payment method is transfer
            if (invoice.paymentMethod === 'transfer') {
                const dpPercentage = dataApp.pengaturan.dpPercentage;
                invoice.dp = invoice.totalBiaya * (dpPercentage / 100);
                invoice.sisaPembayaran = invoice.totalBiaya - invoice.dp;
            } else if (invoice.paymentMethod === 'sekarang') {
                invoice.dp = invoice.totalBiaya;
                invoice.sisaPembayaran = 0;
            } else if (invoice.paymentMethod === 'lokasi') {
                invoice.dp = 0;
                invoice.sisaPembayaran = invoice.totalBiaya;
            }
            
            saveToLocalStorage();
            
            // Update invoice display
            const content = document.getElementById('invoice-detail-content');
            content.innerHTML = generateInvoiceHTML(invoice);
            
            // Hide edit form
            document.getElementById('invoice-edit-form').classList.add('hidden');
            document.getElementById('btn-edit-invoice').innerHTML = '<i class="fas fa-edit"></i> Edit Invoice';
            
            alert('Perubahan invoice berhasil disimpan!');
        }

        function batalEditInvoice() {
            document.getElementById('invoice-edit-form').classList.add('hidden');
            document.getElementById('btn-edit-invoice').innerHTML = '<i class="fas fa-edit"></i> Edit Invoice';
        }

        function generateInvoiceHTML(invoice) {
            const perusahaan = dataApp.pengaturan.perusahaan;
            
            let statusBadge;
            if (invoice.status === 'pending') statusBadge = '<span class="badge badge-warning">Pending (DP)</span>';
            else if (invoice.status === 'dibayar') statusBadge = '<span class="badge badge-primary">Dibayar (DP/Lunas)</span>';
            else if (invoice.status === 'aktif') statusBadge = '<span class="badge badge-success">Aktif (Check-in)</span>';
            else if (invoice.status === 'selesai') statusBadge = '<span class="badge badge-secondary">Selesai (Check-out)</span>';
            else statusBadge = '<span class="badge badge-danger">Dibatalkan</span>';

            const paymentMethodText = invoice.paymentMethod === 'transfer' ? 'Transfer Bank' : invoice.paymentMethod === 'lokasi' ? 'Bayar di Lokasi (Check-in)' : 'Bayar Penuh Sekarang (Transfer)';

            let itemsHTML = '';
            let totalBiayaSebelumDiskon = 0;
            let totalBiayaSewaBarang = 0;
            
            if (invoice.jenis === 'tenda') {
                const lapakCodes = invoice.lapak || [];
                const lapakPrice = invoice.lapakDetail && invoice.lapakDetail[0] ? invoice.lapakDetail[0].harga : (dataApp.lapakTenda.find(l => l.kode === (lapakCodes[0] || ''))?.harga || 0);
                const totalBiayaLapak = lapakCodes.length * lapakPrice * (invoice.jumlahMalam || 0);
                itemsHTML += `
                    <tr>
                        <td>Lapak Tenda (${lapakCodes.join(', ')})</td>
                        <td>${invoice.jumlahMalam || 0} malam</td>
                        <td>${formatRupiah(lapakPrice)}/lapak/malam</td>
                        <td>${formatRupiah(totalBiayaLapak)}</td>
                    </tr>
                `;
                totalBiayaSebelumDiskon += totalBiayaLapak;
            } else {
                const glampingDetails = invoice.glampingDetail || [];
                glampingDetails.forEach(glamping => {
                    const totalBiayaGlamping = (glamping.harga || 0) * (invoice.jumlahMalam || 0);
                    itemsHTML += `
                        <tr>
                            <td>Glamping ${glamping.kode || ''} (${glamping.nama || ''})</td>
                            <td>${invoice.jumlahMalam || 0} malam</td>
                            <td>${formatRupiah(glamping.harga || 0)}/unit/malam</td>
                            <td>${formatRupiah(totalBiayaGlamping)}</td>
                        </tr>
                    `;
                    totalBiayaSebelumDiskon += totalBiayaGlamping;
                });
            }
            
            const totalBiayaTiket = (invoice.jumlahOrang || 0) * (invoice.jumlahMalam || 0) * perusahaan.hargaTiket;
            itemsHTML += `
                <tr>
                    <td>Tiket Masuk (${invoice.jumlahOrang || 0} orang)</td>
                    <td>${invoice.jumlahMalam || 0} malam</td>
                    <td>${formatRupiah(perusahaan.hargaTiket)}/orang/malam</td>
                    <td>${formatRupiah(totalBiayaTiket)}</td>
                </tr>
            `;
            totalBiayaSebelumDiskon += totalBiayaTiket;

            // Add akomodasi lainnya
            if (invoice.akomodasiLainnya && invoice.akomodasiLainnya.length > 0) {
                invoice.akomodasiLainnya.forEach(akomodasi => {
                    itemsHTML += `
                        <tr>
                            <td>${akomodasi.nama || ''}</td>
                            <td>${akomodasi.jumlah || 0} ${akomodasi.satuan || ''}</td>
                            <td>${formatRupiah(akomodasi.harga || 0)}/${akomodasi.satuan || ''}</td>
                            <td>${formatRupiah(akomodasi.totalBiaya || 0)}</td>
                        </tr>
                    `;
                    totalBiayaSebelumDiskon += akomodasi.totalBiaya || 0;
                });
            }

            if (invoice.barangSewa && invoice.barangSewa.length > 0) {
                invoice.barangSewa.forEach(sewa => {
                    itemsHTML += `
                        <tr>
                            <td>Sewa ${sewa.nama || ''}</td>
                            <td>${sewa.jumlah || 0} ${sewa.satuan || ''} x ${sewa.jumlahHari || 0} hari</td>
                            <td>${formatRupiah(sewa.harga || 0)}/${sewa.satuan || ''}/hari</td>
                            <td>${formatRupiah(sewa.totalBiaya || 0)}</td>
                        </tr>
                    `;
                    totalBiayaSewaBarang += sewa.totalBiaya || 0;
                });
            }

            const bankInfoHTML = invoice.paymentMethod === 'transfer' || invoice.paymentMethod === 'sekarang' ? `
                <div class="bank-info mt-3">
                    <h5>Informasi Pembayaran Transfer Bank</h5>
                    <p><strong>Bank:</strong> ${perusahaan.namaBank}</p>
                    <p><strong>No. Rek:</strong> ${perusahaan.norek}</p>
                    <p><strong>A/N:</strong> ${perusahaan.anRekening}</p>
                </div>
            ` : '';

            const sisaPembayaran = (invoice.totalBiaya || 0) - (invoice.paymentMethod === 'transfer' ? (invoice.dp || 0) : (invoice.paymentMethod === 'lokasi' ? 0 : (invoice.totalBiaya || 0)));

            // Diskon HTML
            let diskonHTML = '';
            if (invoice.diskonTipe && invoice.diskonTipe !== 'none' && invoice.diskonAmount > 0) {
                const diskonLabel = invoice.diskonTipe === 'percentage' ? 
                    `Diskon (${invoice.diskonNilai}%)` : `Diskon (Rp)`;
                    
                diskonHTML = `
                    <tr style="background-color: #e8f5e9;">
                        <td colspan="3" class="text-right">**${diskonLabel}**</td>
                        <td class="text-right">**-${formatRupiah(invoice.diskonAmount)}**</td>
                    </tr>
                `;
            }

            const sisaBayarRow = sisaPembayaran > 0 ? `
                <tr style="background-color: #ffe0b2;">
                    <td colspan="3" class="text-right">**Sisa Pembayaran (Wajib Lunas saat Check-in)**</td>
                    <td class="text-right">**<span id="modal-sisa-bayar">${formatRupiah(sisaPembayaran)}</span>**</td>
                </tr>
            ` : '';
            
            const dpRow = invoice.paymentMethod === 'transfer' ? `
                <tr style="background-color: #e0f7fa;">
                    <td colspan="3" class="text-right">**Uang Muka (DP ${dataApp.pengaturan.dpPercentage}%)**</td>
                    <td class="text-right">**${formatRupiah(invoice.dp || 0)}**</td>
                </tr>
            ` : '';

            let extraInfoHTML = '';
            
            // Add nama pemandu jika ada
            if (invoice.namaPemandu) {
                extraInfoHTML += `
                    <div class="alert alert-secondary mt-2">
                        <strong><i class="fas fa-user-tie"></i> Pemandu:</strong> ${invoice.namaPemandu}
                    </div>
                `;
            }
            
            // Add catatan jika ada
            if (invoice.catatan) {
                extraInfoHTML += `
                    <div class="alert alert-info mt-3">
                        <strong><i class="fas fa-sticky-note"></i> Catatan:</strong><br>
                        ${invoice.catatan}
                    </div>
                `;
            }

            return `
                <div class="invoice">
                    <div class="invoice-header">
                        <h2 style="color: var(--primary-color); font-size: 1.2rem;">${perusahaan.nama}</h2>
                        <p style="font-size: 0.85rem;">Sistem Reservasi Kemah Keluarga</p>
                    </div>
                    
                    <div class="invoice-details mb-3">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <p><strong>Tgl. Reservasi:</strong> ${formatDateID(invoice.tanggalReservasi)}</p>
                                <p><strong>Check-in:</strong> ${formatDateID(invoice.tanggalCheckin)} (${dataApp.pengaturan.jamCheckin})</p>
                                <p><strong>Check-out:</strong> ${formatDateID(invoice.tanggalCheckout)} (${dataApp.pengaturan.jamCheckout})</p>
                                <p><strong>Jumlah Malam:</strong> ${invoice.jumlahMalam || 0} malam</p>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <p><strong>Nama Pemesan:</strong> ${invoice.nama || ''}</p>
                                <p><strong>Telepon:</strong> ${invoice.telepon || ''}</p>
                                <p><strong>Email:</strong> ${invoice.email || '-'}</p>
                                <p><strong>Jenis:</strong> ${invoice.jenis ? invoice.jenis.charAt(0).toUpperCase() + invoice.jenis.slice(1) : ''}</p>
                            </div>
                        </div>
                        <p><strong>Status:</strong> ${statusBadge}</p>
                        <p><strong>Metode Bayar:</strong> ${paymentMethodText}</p>
                    </div>

                    <div class="table-responsive invoice-items">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Deskripsi</th>
                                    <th>Durasi/Unit</th>
                                    <th>Harga Satuan</th>
                                    <th class="text-right">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${itemsHTML}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-right">**TOTAL BIAYA AKOMODASI & TIKET**</td>
                                    <td class="text-right">**${formatRupiah(totalBiayaSebelumDiskon)}**</td>
                                </tr>
                                ${diskonHTML}
                                ${dpRow}
                                ${sisaBayarRow}
                            </tfoot>
                        </table>
                    </div>
                    
                    ${extraInfoHTML}
                    
                    ${bankInfoHTML}

                    <div class="text-center mt-3" style="font-size: 0.8rem; color: var(--gray-color);">
                        <p>Terima kasih atas reservasi Anda.</p>
                        <p>Hubungi ${perusahaan.noLayanan} untuk bantuan.</p>
                    </div>
                </div>
            `;
        }
        
        function updatePembayaran() {
            const invoiceNumber = document.getElementById('modal-invoice-number').textContent;
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            const reservasi = dataApp.reservasi.find(r => r.invoice === invoiceNumber);
            
            if (!invoice || !reservasi) return;

            const newStatus = invoice.totalBiaya === 0 || invoice.paymentMethod === 'sekarang' ? 'dibayar' : (invoice.paymentMethod === 'transfer' ? 'dibayar' : 'aktif');
            const paymentType = newStatus === 'dibayar' ? 'DP/Lunas' : 'Bayar di Lokasi';

            if (confirm(`Update status pembayaran Invoice ${invoiceNumber} menjadi DIBAYAR (${paymentType})?`)) {
                invoice.status = 'dibayar';
                reservasi.status = 'dibayar';
                
                if (invoice.sisaPembayaran <= 0) {
                    invoice.sisaPembayaran = 0;
                    invoice.dp = invoice.totalBiaya;
                    
                    if (invoice.paymentMethod === 'lokasi') {
                        invoice.status = 'aktif';
                        reservasi.status = 'aktif';
                        invoice.tanggalSelesai = formatDate(new Date());
                    } else if (invoice.paymentMethod === 'sekarang') {
                        invoice.tanggalSelesai = formatDate(new Date());
                    }
                }

                saveToLocalStorage();
                showInvoiceModal(invoiceNumber);
                generateInvoiceList();
                updateLapakVisualization();
                updateDashboard();
                alert(`Pembayaran Invoice ${invoiceNumber} berhasil di-update. Status: ${invoice.status.toUpperCase()}`);
            }
        }

        function batalkanReservasi() {
            const invoiceNumber = document.getElementById('modal-invoice-number').textContent;
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            const reservasi = dataApp.reservasi.find(r => r.invoice === invoiceNumber);
            
            if (!invoice || !reservasi) return;

            if (confirm(`Apakah Anda yakin ingin MEMBATALKAN reservasi ${invoiceNumber}? Tindakan ini akan membatalkan lapak/glamping.`)) {
                invoice.status = 'dibatalkan';
                reservasi.status = 'dibatalkan';
                
                const allCodes = [...(invoice.lapak || []), ...(invoice.glamping || [])];
                allCodes.forEach(code => {
                    let item = dataApp.lapakTenda.find(l => l.kode === code);
                    if (!item) item = dataApp.glamping.find(g => g.kode === code);
                    
                    if (item) {
                        item.status = 'tersedia';
                    }
                });

                saveToLocalStorage();
                closeInvoiceModal();
                updateLapakVisualization();
                updateDashboard();
                alert(`Reservasi ${invoiceNumber} berhasil DIBATALKAN.`);
            }
        }
        
        function checkInReservasi() {
            const invoiceNumber = document.getElementById('modal-invoice-number').textContent;
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            const reservasi = dataApp.reservasi.find(r => r.invoice === invoiceNumber);
            
            if (!invoice || !reservasi) return;
            
            if (invoice.sisaPembayaran > 0) {
                alert(`Sisa pembayaran sebesar ${formatRupiah(invoice.sisaPembayaran)} harus dilunasi sebelum Check-in.`);
                return;
            }
            
            if (confirm(`Konfirmasi Check-in untuk reservasi ${invoiceNumber} pada tanggal ${formatDateID(invoice.tanggalCheckin)}?`)) {
                invoice.status = 'aktif';
                reservasi.status = 'aktif';

                saveToLocalStorage();
                closeInvoiceModal();
                updateLapakVisualization();
                updateDashboard();
                alert(`Reservasi ${invoiceNumber} berhasil Check-in. Selamat Menikmati!`);
            }
        }

        function checkOutReservasi() {
            const invoiceNumber = document.getElementById('modal-invoice-number').textContent;
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            const reservasi = dataApp.reservasi.find(r => r.invoice === invoiceNumber);
            
            if (!invoice || !reservasi) return;
            
            const checkoutTime = new Date(invoice.tanggalCheckout + 'T' + dataApp.pengaturan.jamCheckout);
            const now = new Date();
            let denda = 0;
            
            if (now > checkoutTime) {
                const diffTime = Math.abs(now - checkoutTime);
                const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));
                denda = diffHours * dataApp.pengaturan.dendaKeterlambatan;
            }

            if (confirm(`Konfirmasi Check-out untuk reservasi ${invoiceNumber}? Denda keterlambatan: ${formatRupiah(denda)}.`)) {
                invoice.status = 'selesai';
                reservasi.status = 'selesai';
                invoice.tanggalSelesai = formatDate(new Date());

                if (denda > 0) {
                    alert(`Total denda keterlambatan: ${formatRupiah(denda)}`);
                }

                const allCodes = [...(invoice.lapak || []), ...(invoice.glamping || [])];
                allCodes.forEach(code => {
                    let item = dataApp.lapakTenda.find(l => l.kode === code);
                    if (!item) item = dataApp.glamping.find(g => g.kode === code);
                    
                    if (item) {
                        item.status = 'tersedia';
                    }
                });

                saveToLocalStorage();
                closeInvoiceModal();
                updateLapakVisualization();
                updateDashboard();
                alert(`Reservasi ${invoiceNumber} berhasil Check-out dan Selesai.`);
            }
        }

        function printInvoiceToPDF() {
            const invoiceNumber = document.getElementById('modal-invoice-number').textContent;
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            if (!invoice) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const perusahaan = dataApp.pengaturan.perusahaan;

            let finalY = 0;

            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text(`INVOICE: ${invoiceNumber}`, 10, 10);
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(perusahaan.nama, 10, 16);
            doc.text(perusahaan.alamat, 10, 21);

            doc.setFontSize(10);
            doc.text(`Tgl. Reservasi: ${formatDateID(invoice.tanggalReservasi)}`, 100, 30);
            doc.text(`Nama Pemesan: ${invoice.nama || ''}`, 10, 30);
            doc.text(`Telepon: ${invoice.telepon || ''}`, 10, 36);
            doc.text(`Jenis: ${invoice.jenis ? invoice.jenis.charAt(0).toUpperCase() + invoice.jenis.slice(1) : ''}`, 10, 42);
            doc.text(`Status: ${invoice.status ? invoice.status.toUpperCase() : ''}`, 10, 48);

            doc.text(`Check-in: ${formatDateID(invoice.tanggalCheckin)}`, 100, 36);
            doc.text(`Check-out: ${formatDateID(invoice.tanggalCheckout)}`, 100, 42);
            doc.text(`Jumlah Malam: ${invoice.jumlahMalam || 0} malam`, 100, 48);
            doc.text(`Jumlah Orang: ${invoice.jumlahOrang || 0} orang`, 100, 54);

            const tableData = [];
            let totalAkomodasiTiket = 0;
            let totalBiayaSewaBarang = 0;

            if (invoice.jenis === 'tenda') {
                const lapakCodes = invoice.lapak || [];
                const lapakPrice = invoice.lapakDetail && invoice.lapakDetail[0] ? invoice.lapakDetail[0].harga : dataApp.lapakTenda.find(l => l.kode === (lapakCodes[0] || ''))?.harga || 0;
                const totalBiayaLapak = lapakCodes.length * lapakPrice * (invoice.jumlahMalam || 0);
                
                tableData.push([
                    `Lapak Tenda (${lapakCodes.join(', ')})`,
                    `${invoice.jumlahMalam || 0} malam`,
                    `${formatRupiah(lapakPrice)}/lapak/malam`,
                    formatRupiah(totalBiayaLapak)
                ]);
                totalAkomodasiTiket += totalBiayaLapak;
            } else {
                const glampingCodes = Array.isArray(invoice.glamping) ? invoice.glamping : [invoice.glamping];
                glampingCodes.forEach(kodeGlamping => {
                    const glamping = invoice.glampingDetail ? invoice.glampingDetail.find(g => g.kode === kodeGlamping) : dataApp.glamping.find(g => g.kode === kodeGlamping);
                    if (glamping) {
                        const totalGlamping = (glamping.harga || 0) * (invoice.jumlahMalam || 0);
                        tableData.push([
                            `Glamping ${glamping.kode || ''} (${glamping.nama || ''})`,
                            `${invoice.jumlahMalam || 0} malam`,
                            `${formatRupiah(glamping.harga || 0)}/unit/malam`,
                            formatRupiah(totalGlamping)
                        ]);
                        totalAkomodasiTiket += totalGlamping;
                    }
                });
            }
            
            tableData.push([
                `Tiket Masuk (${invoice.jumlahOrang || 0} orang)`,
                `${invoice.jumlahMalam || 0} malam`,
                `${formatRupiah(perusahaan.hargaTiket)}/orang/malam`,
                formatRupiah((invoice.jumlahOrang || 0) * (invoice.jumlahMalam || 0) * perusahaan.hargaTiket)
            ]);
            totalAkomodasiTiket += (invoice.jumlahOrang || 0) * (invoice.jumlahMalam || 0) * perusahaan.hargaTiket;

            // Add akomodasi lainnya
            if (invoice.akomodasiLainnya && invoice.akomodasiLainnya.length > 0) {
                invoice.akomodasiLainnya.forEach(akomodasi => {
                    tableData.push([
                        `${akomodasi.nama || ''}`,
                        `${akomodasi.jumlah || 0} ${akomodasi.satuan || ''}`,
                        `${formatRupiah(akomodasi.harga || 0)}/${akomodasi.satuan || ''}`,
                        formatRupiah(akomodasi.totalBiaya || 0)
                    ]);
                    totalAkomodasiTiket += akomodasi.totalBiaya || 0;
                });
            }

            if (invoice.barangSewa && invoice.barangSewa.length > 0) {
                invoice.barangSewa.forEach(sewa => {
                    tableData.push([
                        `Sewa ${sewa.nama || ''}`,
                        `${sewa.jumlah || 0} ${sewa.satuan || ''} x ${sewa.jumlahHari || 0} hari`,
                        `${formatRupiah(sewa.harga || 0)}/${sewa.satuan || ''}/hari`,
                        formatRupiah(sewa.totalBiaya || 0)
                    ]);
                    totalBiayaSewaBarang += sewa.totalBiaya || 0;
                });
            }

            const finalTableData = [
                ...tableData,
                [{ content: "TOTAL BIAYA AKOMODASI & TIKET", colSpan: 3, styles: { halign: 'right', fontStyle: 'bold' } }, { content: formatRupiah(totalAkomodasiTiket), styles: { fontStyle: 'bold' } }],
            ];
            
            // Add discount if exists
            if (invoice.diskonTipe && invoice.diskonTipe !== 'none' && invoice.diskonAmount > 0) {
                const diskonLabel = invoice.diskonTipe === 'percentage' ? 
                    `Diskon (${invoice.diskonNilai}%)` : `Diskon`;
                    
                finalTableData.push(
                    [{ content: diskonLabel, colSpan: 3, styles: { halign: 'right', fontStyle: 'bold', fillColor: [232, 245, 233] } }, 
                     { content: `-${formatRupiah(invoice.diskonAmount)}`, styles: { fontStyle: 'bold', fillColor: [232, 245, 233] } }],
                );
            }
            
            if (totalBiayaSewaBarang > 0) {
                finalTableData.push(
                    [{ content: "TOTAL SEWA BARANG", colSpan: 3, styles: { halign: 'right', fontStyle: 'bold' } }, { content: formatRupiah(totalBiayaSewaBarang), styles: { fontStyle: 'bold' } }],
                );
            }
            
            finalTableData.push(
                [{ content: "TOTAL KESELURUHAN", colSpan: 3, styles: { halign: 'right', fontStyle: 'bold', fillColor: [224, 242, 241] } }, { content: formatRupiah(invoice.totalBiaya || 0), styles: { fontStyle: 'bold', fillColor: [224, 242, 241] } }],
            );

            if (invoice.paymentMethod === 'transfer') {
                finalTableData.push(
                    [{ content: `DP (${dataApp.pengaturan.dpPercentage}%)`, colSpan: 3, styles: { halign: 'right', fontStyle: 'bold', fillColor: [232, 245, 233] } }, { content: formatRupiah(invoice.dp || 0), styles: { fontStyle: 'bold', fillColor: [232, 245, 233] } }],
                );
                finalTableData.push(
                    [{ content: "SISA PEMBAYARAN", colSpan: 3, styles: { halign: 'right', fontStyle: 'bold', fillColor: [255, 243, 224] } }, { content: formatRupiah(invoice.sisaPembayaran || 0), styles: { fontStyle: 'bold', fillColor: [255, 243, 224] } }],
                );
            }

            doc.autoTable({
                startY: 60,
                head: [['Deskripsi', 'Durasi/Unit', 'Harga Satuan', 'Subtotal']],
                body: finalTableData,
                theme: 'striped',
                headStyles: { fillColor: [46, 125, 50], textColor: [255, 255, 255] },
                didDrawPage: function (data) {
                    finalY = data.cursor.y;
                }
            });

            // Add guide name if exists
            if (invoice.namaPemandu) {
                let guideY = finalY + 10;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text("PEMANDU/PETUGAS:", 10, guideY);
                doc.setFont('helvetica', 'normal');
                doc.text(invoice.namaPemandu, 50, guideY);
                finalY = guideY;
            }

            if (invoice.paymentMethod === 'transfer' || invoice.paymentMethod === 'sekarang') {
                let paymentY = finalY + 10;
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.text("INFORMASI PEMBAYARAN TRANSFER BANK", 10, paymentY);
                paymentY += 5;
                doc.setFont('helvetica', 'normal');
                doc.text(`Bank: ${perusahaan.namaBank}`, 10, paymentY);
                paymentY += 5;
                doc.text(`No. Rek: ${perusahaan.norek}`, 10, paymentY);
                paymentY += 5;
                doc.text(`A/N: ${perusahaan.anRekening}`, 10, paymentY);
                finalY = paymentY;
            }

            // Add notes if exists
            if (invoice.catatan) {
                let notesY = finalY + 10;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                doc.text("CATATAN:", 10, notesY);
                doc.setFont('helvetica', 'normal');
                const splitNotes = doc.splitTextToSize(invoice.catatan, 180);
                doc.text(splitNotes, 10, notesY + 5);
                finalY = notesY + 5 + (splitNotes.length * 5);
            }

            let catatanY = finalY + 10;
            doc.setFontSize(9);
            doc.setFont('helvetica', 'normal');
            doc.text("Catatan:", 10, catatanY);
            catatanY += 5;
            doc.text(`1. Check-in: ${dataApp.pengaturan.jamCheckin} | Check-out: ${dataApp.pengaturan.jamCheckout}`, 10, catatanY);
            catatanY += 5;
            doc.text(`2. Denda keterlambatan check-out: ${formatRupiah(dataApp.pengaturan.dendaKeterlambatan)}/jam.`, 10, catatanY);
            catatanY += 5;
            doc.text(`3. Hubungi ${perusahaan.noLayanan} untuk bantuan.`, 10, catatanY);

            let penutupY = catatanY + 10;
            doc.setFontSize(10);
            doc.setFont('helvetica', 'italic');
            doc.text("Terima kasih atas reservasi Anda.", 105, penutupY, null, null, 'center');

            doc.save(`Invoice-${invoiceNumber}.pdf`);
        }

        // --- Lapak Visualisasi Section ---

        function updateLapakVisualization() {
            const tanggalVis = document.getElementById('tanggal-visualisasi').value || formatDate(new Date());
            const containerLapak = document.getElementById('visualization-lapak');
            const containerGlamping = document.getElementById('visualization-glamping');
            containerLapak.innerHTML = '';
            containerGlamping.innerHTML = '';

            const reservedLapak = getReservedCodes('tenda', tanggalVis);
            const reservedGlamping = getReservedCodes('glamping', tanggalVis);

            dataApp.lapakTenda.forEach(lapak => {
                const isReserved = reservedLapak.includes(lapak.kode);
                const item = document.createElement('div');
                item.classList.add('grid-item', isReserved ? 'lapak-terpakai' : 'lapak-tersedia');
                item.textContent = lapak.kode.replace('L', '');
                containerLapak.appendChild(item);
            });

            dataApp.glamping.forEach(glamping => {
                const isReserved = reservedGlamping.includes(glamping.kode);
                const item = document.createElement('div');
                item.classList.add('grid-item', isReserved ? 'lapak-terpakai' : 'lapak-tersedia');
                item.textContent = glamping.kode;
                containerGlamping.appendChild(item);
            });
            
            const reservasiList = document.getElementById('lapak-reservasi-list');
            reservasiList.innerHTML = '';
            
            dataApp.reservasi.filter(r => r.status === 'aktif' || r.status === 'dibayar').forEach(r => {
                const invoice = dataApp.invoice.find(inv => inv.invoice === r.invoice);
                if (!invoice) return;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${r.invoice}</td>
                    <td>${r.jenis.charAt(0).toUpperCase() + r.jenis.slice(1)}</td>
                    <td>${formatDateID(r.tanggalCheckin)}</td>
                    <td>${formatDateID(r.tanggalCheckout)}</td>
                    <td>${invoice.nama || ''}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="showInvoiceModal('${r.invoice}')">
                            <i class="fas fa-eye"></i> Detail
                        </button>
                    </td>
                `;
                reservasiList.appendChild(row);
            });
        }

        function changeVisualizationTab(tabElement, target) {
            document.querySelectorAll('#lapak-section .tabs .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#lapak-section .tab-content').forEach(content => content.classList.remove('active'));
            tabElement.classList.add('active');
            document.getElementById(target).classList.add('active');
        }

        // --- Sewa Barang Manual di Invoice Section ---
        
        function loadInvoiceOptions() {
            const select = document.getElementById('invoice-sewa-barang');
            select.innerHTML = '<option value="">-- Pilih Invoice --</option>';
            
            dataApp.invoice.filter(inv => inv.status === 'pending' || inv.status === 'dibayar' || inv.status === 'aktif')
                .forEach(inv => {
                    const option = document.createElement('option');
                    option.value = inv.invoice;
                    option.textContent = `${inv.invoice} - ${inv.nama || ''} (${inv.jenis ? inv.jenis.toUpperCase() : ''})`;
                    select.appendChild(option);
                });
            
            document.getElementById('sewa-barang-form-container').classList.add('hidden');
        }

        function loadSewaBarangForm() {
            const invoiceNumber = document.getElementById('invoice-sewa-barang').value;
            const container = document.getElementById('sewa-barang-form-container');
            const tbody = document.getElementById('sewa-barang-list-manual');
            
            if (!invoiceNumber) {
                container.classList.add('hidden');
                return;
            }

            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            
            if (!invoice) {
                container.classList.add('hidden');
                return;
            }

            document.getElementById('jumlah-hari-sewa').value = invoice.jumlahMalam || 1;
            
            tbody.innerHTML = '';
            dataApp.barangSewa.forEach((barang, index) => {
                const existingItem = (invoice.barangSewa || []).find(b => b.id === barang.id);
                const currentJumlah = existingItem ? existingItem.jumlah : 0;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${barang.nama}</td>
                    <td>${formatRupiah(barang.harga)}</td>
                    <td>${barang.satuan}</td>
                    <td>
                        <input type="number" class="form-control" id="jumlah-barang-invoice-${index}" 
                            value="${currentJumlah}" min="0" max="${barang.stok}" 
                            onchange="hitungTotalSewaBarang()" onkeyup="hitungTotalSewaBarang()">
                    </td>
                    <td class="text-right"><span id="subtotal-barang-invoice-${index}">${formatRupiah(currentJumlah * (barang.harga || 0) * (invoice.jumlahMalam || 1))}</span></td>
                `;
                tbody.appendChild(row);
            });

            container.classList.remove('hidden');
            hitungTotalSewaBarang();
        }

        function hitungTotalSewaBarang() {
            const invoiceNumber = document.getElementById('invoice-sewa-barang').value;
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            if (!invoice) return;

            const jumlahHari = parseInt(document.getElementById('jumlah-hari-sewa').value) || (invoice.jumlahMalam || 1);
            let total = 0;

            dataApp.barangSewa.forEach((barang, index) => {
                const jumlah = parseInt(document.getElementById(`jumlah-barang-invoice-${index}`).value) || 0;
                const subtotal = jumlah * (barang.harga || 0) * jumlahHari;
                document.getElementById(`subtotal-barang-invoice-${index}`).textContent = formatRupiah(subtotal);
                total += subtotal;
            });

            document.getElementById('total-sewa-barang').textContent = formatRupiah(total);
        }
        
        function simpanSewaBarang() {
            const invoiceNumber = document.getElementById('invoice-sewa-barang').value;
            if (!invoiceNumber) {
                alert('Pilih invoice terlebih dahulu.');
                return;
            }
            
            const invoice = dataApp.invoice.find(inv => inv.invoice === invoiceNumber);
            const reservasi = dataApp.reservasi.find(r => r.invoice === invoiceNumber);
            if (!invoice || !reservasi) return;

            const jumlahHari = parseInt(document.getElementById('jumlah-hari-sewa').value) || (invoice.jumlahMalam || 1);
            const namaPemandu = document.getElementById('nama-pemandu-manual').value || 'Petugas BSA';

            const newBarangSewaList = [];
            let totalBiayaSewaBarang = 0;

            dataApp.barangSewa.forEach((barang, index) => {
                const jumlah = parseInt(document.getElementById(`jumlah-barang-invoice-${index}`).value) || 0;
                if (jumlah > 0) {
                    const totalBiaya = jumlah * (barang.harga || 0) * jumlahHari;
                    totalBiayaSewaBarang += totalBiaya;
                    newBarangSewaList.push({
                        id: barang.id,
                        nama: barang.nama,
                        harga: barang.harga,
                        satuan: barang.satuan,
                        stok: barang.stok,
                        jumlah: jumlah,
                        jumlahHari: jumlahHari,
                        totalBiaya: totalBiaya,
                        petugas: namaPemandu
                    });
                }
            });

            let totalBiayaAkomodasi = 0;
            const perusahaan = dataApp.pengaturan.perusahaan;

            if (invoice.jenis === 'tenda') {
                const lapakCodes = invoice.lapak || [];
                const lapakPrice = invoice.lapakDetail && invoice.lapakDetail[0] ? invoice.lapakDetail[0].harga : dataApp.lapakTenda.find(l => l.kode === (lapakCodes[0] || ''))?.harga || 0;
                const totalBiayaLapak = lapakCodes.length * lapakPrice * (invoice.jumlahMalam || 0);
                totalBiayaAkomodasi += totalBiayaLapak;
            } else {
                const glampingDetails = invoice.glampingDetail || [];
                glampingDetails.forEach(glamping => {
                    totalBiayaAkomodasi += (glamping.harga || 0) * (invoice.jumlahMalam || 0);
                });
            }
            
            const totalBiayaTiket = (invoice.jumlahOrang || 0) * (invoice.jumlahMalam || 0) * perusahaan.hargaTiket;
            totalBiayaAkomodasi += totalBiayaTiket;
            
            // Add akomodasi lainnya biaya
            if (invoice.akomodasiLainnya && invoice.akomodasiLainnya.length > 0) {
                invoice.akomodasiLainnya.forEach(akomodasi => {
                    totalBiayaAkomodasi += akomodasi.totalBiaya || 0;
                });
            }

            invoice.barangSewa = newBarangSewaList;
            invoice.totalBiaya = totalBiayaAkomodasi + totalBiayaSewaBarang;
            
            const dpPercentage = dataApp.pengaturan.dpPercentage;
            if (invoice.paymentMethod === 'transfer') {
                invoice.dp = invoice.totalBiaya * (dpPercentage / 100);
                invoice.sisaPembayaran = invoice.totalBiaya - invoice.dp;
            } else if (invoice.paymentMethod === 'lokasi') {
                invoice.dp = 0;
                invoice.sisaPembayaran = invoice.totalBiaya;
            } else if (invoice.paymentMethod === 'sekarang') {
                invoice.dp = invoice.totalBiaya;
                invoice.sisaPembayaran = 0;
            }
            
            saveToLocalStorage();
            
            document.getElementById('invoice-sewa-barang').value = '';
            document.getElementById('nama-pemandu-manual').value = '';
            document.getElementById('sewa-barang-form-container').classList.add('hidden');
            loadInvoiceOptions();
            
            alert(`Sewa barang berhasil ditambahkan ke Invoice ${invoiceNumber}. Total Biaya baru: ${formatRupiah(invoice.totalBiaya)}`);

            if (document.getElementById('modal-invoice-number').textContent === invoiceNumber) {
                showInvoiceModal(invoiceNumber);
            }
        }

        // --- Laporan Section ---
        
        function toggleTanggalKustom() {
            const periode = document.getElementById('periode-laporan').value;
            const customInputs = document.getElementById('periode-kustom-inputs');
            if (periode === 'kustom') {
                customInputs.classList.remove('hidden');
            } else {
                customInputs.classList.add('hidden');
                filterLaporan();
            }
        }

        function filterLaporan() {
            const periode = document.getElementById('periode-laporan').value;
            let tanggalMulai, tanggalSelesai;
            const today = formatDate(new Date());

            if (periode === 'hari_ini') {
                tanggalMulai = today;
                tanggalSelesai = today;
            } else if (periode === 'bulan_ini') {
                const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                tanggalMulai = formatDate(startOfMonth);
                tanggalSelesai = today;
            } else if (periode === 'bulan_lalu') {
                const startOfLastMonth = new Date(new Date().getFullYear(), new Date().getMonth() - 1, 1);
                const endOfLastMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 0);
                tanggalMulai = formatDate(startOfLastMonth);
                tanggalSelesai = formatDate(endOfLastMonth);
            } else if (periode === 'tahun_ini') {
                const startOfYear = new Date(new Date().getFullYear(), 0, 1);
                tanggalMulai = formatDate(startOfYear);
                tanggalSelesai = today;
            } else if (periode === 'kustom') {
                tanggalMulai = document.getElementById('tanggal-mulai').value;
                tanggalSelesai = document.getElementById('tanggal-selesai').value;
                
                if (!tanggalMulai || !tanggalSelesai) {
                    alert('Harap isi tanggal mulai dan tanggal selesai untuk periode kustom.');
                    return;
                }
            } else {
                return;
            }
            
            const startDate = new Date(tanggalMulai + 'T00:00:00');
            const endDate = new Date(tanggalSelesai + 'T00:00:00');
            
            const laporanData = dataApp.reservasi.filter(reservasi => {
                const reservasiDate = new Date(reservasi.tanggalReservasi + 'T00:00:00');
                return reservasiDate >= startDate && reservasiDate <= endDate;
            });

            let lapakTerjual = 0;
            let glampingTerjual = 0;
            let totalPengunjung = 0;
            let totalOmzet = 0;
            let totalTiket = 0;
            let totalReservasi = 0;

            const laporanDetailBody = document.getElementById('laporan-detail');
            laporanDetailBody.innerHTML = '';
            
            laporanData.sort((a, b) => new Date(b.tanggalReservasi) - new Date(a.tanggalReservasi));
            
            laporanData.forEach(r => {
                const invoice = dataApp.invoice.find(inv => inv.invoice === r.invoice);
                if (invoice) {
                    totalReservasi += 1;
                    totalPengunjung += parseInt(r.jumlahOrang) || 0;

                    if (r.jenis === 'tenda') {
                        lapakTerjual += (r.lapak || []).length;
                    } else {
                        glampingTerjual += (r.glamping || []).length;
                    }

                    if (invoice.status === 'selesai') {
                        totalOmzet += parseInt(invoice.totalBiaya) || 0;
                    } else if (invoice.status === 'dibayar' || invoice.status === 'aktif' || invoice.status === 'pending') {
                        if (invoice.paymentMethod === 'sekarang' || invoice.paymentMethod === 'lokasi') {
                            totalOmzet += parseInt(invoice.totalBiaya) || 0;
                        } else if (invoice.paymentMethod === 'transfer') {
                            totalOmzet += parseInt(invoice.dp) || 0;
                        }
                    }
                    
                    totalTiket += (r.jumlahOrang || 0) * (r.jumlahMalam || 0) * dataApp.pengaturan.perusahaan.hargaTiket;

                    let statusBadge;
                    if (invoice.status === 'pending') statusBadge = '<span class="badge badge-warning">Pending (DP)</span>';
                    else if (invoice.status === 'dibayar') statusBadge = '<span class="badge badge-primary">Dibayar (DP/Lunas)</span>';
                    else if (invoice.status === 'aktif') statusBadge = '<span class="badge badge-success">Aktif (Check-in)</span>';
                    else if (invoice.status === 'selesai') statusBadge = '<span class="badge badge-secondary">Selesai (Check-out)</span>';
                    else statusBadge = '<span class="badge badge-danger">Dibatalkan</span>';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${invoice.invoice}</td>
                        <td>${formatDateID(invoice.tanggalReservasi)}</td>
                        <td>${formatDateID(invoice.tanggalCheckin)}</td>
                        <td>${formatDateID(invoice.tanggalCheckout)}</td>
                        <td>${invoice.nama || ''}</td>
                        <td>${invoice.jenis ? invoice.jenis.charAt(0).toUpperCase() + invoice.jenis.slice(1) : ''}</td>
                        <td>${formatRupiah(invoice.totalBiaya || 0)}</td>
                        <td>${statusBadge}</td>
                    `;
                    laporanDetailBody.appendChild(row);
                }
            });

            document.getElementById('laporan-total-reservasi').textContent = totalReservasi;
            document.getElementById('laporan-lapak-terjual').textContent = lapakTerjual;
            document.getElementById('laporan-glamping-terjual').textContent = glampingTerjual;
            document.getElementById('laporan-total-pengunjung').textContent = totalPengunjung;
            document.getElementById('laporan-total-tiket').textContent = formatRupiah(totalTiket);
            document.getElementById('laporan-total-omzet').textContent = formatRupiah(totalOmzet);
        }
        
        function generateLaporanPDF() {
            const periode = document.getElementById('periode-laporan').value;
            const laporanName = document.querySelector(`#periode-laporan option[value="${periode}"]`).textContent;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            const perusahaan = dataApp.pengaturan.perusahaan;

            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text(`LAPORAN TRANSAKSI - ${perusahaan.nama.toUpperCase()}`, 14, 15);
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Periode: ${laporanName}`, 14, 22);
            doc.text(`Tanggal Cetak: ${formatDateID(formatDate(new Date()))}`, 14, 28);
            
            const totalOmzet = document.getElementById('laporan-total-omzet').textContent;
            doc.text(`Total Omzet: ${totalOmzet}`, 14, 34);

            const tableColumn = ["Invoice", "Tgl Reservasi", "Check-in", "Check-out", "Nama Pemesan", "Jenis", "Total Biaya", "Status"];
            const tableRows = [];

            const tableBody = document.getElementById('laporan-detail');
            Array.from(tableBody.rows).forEach(row => {
                const rowData = [];
                Array.from(row.cells).forEach(cell => {
                    if (cell.children.length > 0 && cell.children[0].tagName === 'SPAN') {
                        rowData.push(cell.children[0].textContent);
                    } else {
                        rowData.push(cell.textContent);
                    }
                });
                rowData.pop();
                tableRows.push(rowData);
            });

            doc.autoTable(tableColumn, tableRows, {
                startY: 40,
                headStyles: { fillColor: [46, 125, 50], textColor: [255, 255, 255], fontStyle: 'bold' },
                styles: { fontSize: 8 },
                columnStyles: {
                    6: { halign: 'right' }
                }
            });

            doc.save(`Laporan-Transaksi-${laporanName}.pdf`);
        }

        // --- Pengaturan Section ---

        function loadPengaturanData() {
            const p = dataApp.pengaturan;
            const comp = p.perusahaan;

            document.getElementById('harga-tiket').value = comp.hargaTiket;
            document.getElementById('dp-percentage').value = p.dpPercentage;
            
            document.getElementById('jam-checkin').value = p.jamCheckin;
            document.getElementById('jam-checkout').value = p.jamCheckout;
            document.getElementById('min-reservasi-hari').value = p.minReservasiHari;
            document.getElementById('max-reservasi-hari').value = p.maxReservasiHari;
            document.getElementById('max-lapak-per-reservasi').value = p.maxLapakPerReservasi;
            document.getElementById('denda-keterlambatan').value = p.dendaKeterlambatan;
            
            document.getElementById('nama-bank').value = comp.namaBank;
            document.getElementById('nomor-rekening').value = comp.norek;
            document.getElementById('an-rekening').value = comp.anRekening;
            document.getElementById('no-layanan').value = comp.noLayanan;

            document.getElementById('footer-no-layanan').textContent = comp.noLayanan;
        }

        function simpanPengaturanUmum() {
            try {
                dataApp.pengaturan.perusahaan.hargaTiket = parseInt(document.getElementById('harga-tiket').value) || 0;
                dataApp.pengaturan.perusahaan.namaBank = document.getElementById('nama-bank').value || '';
                dataApp.pengaturan.perusahaan.norek = document.getElementById('nomor-rekening').value || '';
                dataApp.pengaturan.perusahaan.anRekening = document.getElementById('an-rekening').value || '';
                dataApp.pengaturan.perusahaan.noLayanan = document.getElementById('no-layanan').value || '';

                dataApp.pengaturan.dpPercentage = parseInt(document.getElementById('dp-percentage').value) || 50;
                dataApp.pengaturan.jamCheckin = document.getElementById('jam-checkin').value || '14:00';
                dataApp.pengaturan.jamCheckout = document.getElementById('jam-checkout').value || '12:00';
                dataApp.pengaturan.minReservasiHari = parseInt(document.getElementById('min-reservasi-hari').value) || 1;
                dataApp.pengaturan.maxReservasiHari = parseInt(document.getElementById('max-reservasi-hari').value) || 7;
                dataApp.pengaturan.maxLapakPerReservasi = parseInt(document.getElementById('max-lapak-per-reservasi').value) || 30;
                dataApp.pengaturan.dendaKeterlambatan = parseInt(document.getElementById('denda-keterlambatan').value) || 0;

                saveToLocalStorage();
                loadPengaturanData();
                alert('Pengaturan umum berhasil disimpan!');
            } catch (e) {
                alert('Gagal menyimpan pengaturan. Pastikan semua input terisi dengan format yang benar.');
            }
        }

        function changePengaturanTab(tabElement, target) {
            document.querySelectorAll('#pengaturan-section .tabs .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#pengaturan-section .tab-content').forEach(content => content.style.display = 'none');
            tabElement.classList.add('active');
            document.getElementById(`tab-${target}`).style.display = 'block';
            
            // Scroll to top of tab content
            document.getElementById(`tab-${target}`).scrollIntoView({ behavior: 'smooth' });
        }

        // Lapak Tenda Management
        function generatePengaturanLapak() {
            const tbody = document.getElementById('pengaturan-lapak');
            tbody.innerHTML = '';
            
            dataApp.lapakTenda.forEach((lapak, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="form-control" id="kode-lapak-${index}" value="${lapak.kode}" required></td>
                    <td><input type="number" class="form-control" id="harga-lapak-${index}" value="${lapak.harga}" min="0"></td>
                    <td><input type="number" class="form-control" id="kapasitas-lapak-${index}" value="${lapak.kapasitas}" min="1"></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="simpanLapak(${index})">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusLapak(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function simpanLapak(index) {
            const kode = document.getElementById(`kode-lapak-${index}`).value.toUpperCase();
            const harga = parseInt(document.getElementById(`harga-lapak-${index}`).value) || 0;
            const kapasitas = parseInt(document.getElementById(`kapasitas-lapak-${index}`).value) || 4;
            
            if (!kode) {
                alert('Kode Lapak harus diisi!');
                return;
            }
            
            const isDuplicate = dataApp.lapakTenda.some((l, i) => i !== index && l.kode === kode);
            if (isDuplicate) {
                alert('Kode Lapak sudah ada. Harap gunakan kode unik.');
                return;
            }

            dataApp.lapakTenda[index].kode = kode;
            dataApp.lapakTenda[index].harga = harga;
            dataApp.lapakTenda[index].kapasitas = kapasitas;
            
            saveToLocalStorage();
            generatePengaturanLapak();
            alert(`Lapak ${kode} berhasil disimpan!`);
        }

        function hapusLapak(index) {
            if (confirm('Apakah Anda yakin ingin menghapus lapak ini?')) {
                dataApp.lapakTenda.splice(index, 1);
                generatePengaturanLapak(); 
                saveToLocalStorage();
                alert('Lapak berhasil dihapus!');
            }
        }

        function tambahLapak() {
            const newKode = `L${dataApp.lapakTenda.length + 1}`;
            dataApp.lapakTenda.push({
                kode: newKode,
                harga: 0,
                kapasitas: 4,
                status: 'tersedia'
            });
            generatePengaturanLapak(); 
            saveToLocalStorage();
        }

        // Glamping Management
        function generatePengaturanGlamping() {
            const tbody = document.getElementById('pengaturan-glamping');
            tbody.innerHTML = '';
            
            dataApp.glamping.forEach((glamping, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="form-control" id="kode-glamping-${index}" value="${glamping.kode}" required></td>
                    <td><input type="text" class="form-control" id="nama-glamping-cfg-${index}" value="${glamping.nama}" required></td>
                    <td><input type="number" class="form-control" id="harga-glamping-${index}" value="${glamping.harga}" min="0"></td>
                    <td><input type="number" class="form-control" id="kapasitas-glamping-${index}" value="${glamping.kapasitas}" min="1"></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="simpanGlamping(${index})">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusGlamping(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function simpanGlamping(index) {
            const kode = document.getElementById(`kode-glamping-${index}`).value.toUpperCase();
            const nama = document.getElementById(`nama-glamping-cfg-${index}`).value;
            const harga = parseInt(document.getElementById(`harga-glamping-${index}`).value) || 0;
            const kapasitas = parseInt(document.getElementById(`kapasitas-glamping-${index}`).value) || 4;
            
            if (!kode || !nama) {
                alert('Kode dan Nama Glamping harus diisi!');
                return;
            }
            
            const isDuplicate = dataApp.glamping.some((g, i) => i !== index && g.kode === kode);
            if (isDuplicate) {
                alert('Kode Glamping sudah ada. Harap gunakan kode unik.');
                return;
            }

            dataApp.glamping[index].kode = kode;
            dataApp.glamping[index].nama = nama;
            dataApp.glamping[index].harga = harga;
            dataApp.glamping[index].kapasitas = kapasitas;
            
            saveToLocalStorage();
            generatePengaturanGlamping();
            alert(`Glamping ${kode} berhasil disimpan!`);
        }

        function hapusGlamping(index) {
            if (confirm('Apakah Anda yakin ingin menghapus glamping ini?')) {
                dataApp.glamping.splice(index, 1);
                generatePengaturanGlamping();
                saveToLocalStorage();
                alert('Glamping berhasil dihapus!');
            }
        }

        function tambahGlamping() {
            const newKode = `G${dataApp.glamping.length + 1}`;
            dataApp.glamping.push({
                kode: newKode,
                nama: "Glamping Baru",
                harga: 150000,
                kapasitas: 4,
                status: 'tersedia'
            });
            generatePengaturanGlamping();
            saveToLocalStorage();
        }
        
        // Barang Sewa Management
        function generatePengaturanBarang() {
            const tbody = document.getElementById('pengaturan-barang');
            tbody.innerHTML = '';
            
            dataApp.barangSewa.forEach((barang, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="form-control" id="nama-barang-${index}" value="${barang.nama}" required></td>
                    <td><input type="number" class="form-control" id="harga-barang-${index}" value="${barang.harga}" min="0"></td>
                    <td><input type="text" class="form-control" id="satuan-barang-${index}" value="${barang.satuan}"></td>
                    <td><input type="number" class="form-control" id="stok-barang-${index}" value="${barang.stok}" min="0"></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="simpanBarang(${index})">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusBarang(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function simpanBarang(index) {
            const nama = document.getElementById(`nama-barang-${index}`).value;
            const harga = parseInt(document.getElementById(`harga-barang-${index}`).value) || 0;
            const satuan = document.getElementById(`satuan-barang-${index}`).value || 'pcs';
            const stok = parseInt(document.getElementById(`stok-barang-${index}`).value) || 0;

            if (!nama) {
                alert('Nama Barang harus diisi!');
                return;
            }

            dataApp.barangSewa[index].nama = nama;
            dataApp.barangSewa[index].harga = harga;
            dataApp.barangSewa[index].satuan = satuan;
            dataApp.barangSewa[index].stok = stok;
            
            saveToLocalStorage();
            alert(`Barang ${nama} berhasil disimpan!`);
        }

        function hapusBarang(index) {
            if (confirm('Apakah Anda yakin ingin menghapus barang ini?')) {
                dataApp.barangSewa.splice(index, 1);
                generatePengaturanBarang(); 
                saveToLocalStorage();
                alert('Barang berhasil dihapus!');
            }
        }

        function tambahBarang() {
            const newId = dataApp.barangSewa.length > 0 ? Math.max(...dataApp.barangSewa.map(b => b.id)) + 1 : 1;
            dataApp.barangSewa.push({
                id: newId,
                nama: "Barang Baru",
                harga: 0,
                satuan: "pcs",
                stok: 0
            });
            generatePengaturanBarang();
            saveToLocalStorage();
        }
        
        // Akomodasi Lainnya Management
        function generatePengaturanAkomodasi() {
            const tbody = document.getElementById('pengaturan-akomodasi');
            tbody.innerHTML = '';
            
            dataApp.akomodasiLainnya.forEach((akomodasi, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" class="form-control" id="nama-akomodasi-${index}" value="${akomodasi.nama}" required></td>
                    <td><input type="number" class="form-control" id="harga-akomodasi-${index}" value="${akomodasi.harga}" min="0"></td>
                    <td><input type="text" class="form-control" id="satuan-akomodasi-${index}" value="${akomodasi.satuan}"></td>
                    <td><input type="number" class="form-control" id="stok-akomodasi-${index}" value="${akomodasi.stok}" min="0"></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="simpanAkomodasi(${index})">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusAkomodasi(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function simpanAkomodasi(index) {
            const nama = document.getElementById(`nama-akomodasi-${index}`).value;
            const harga = parseInt(document.getElementById(`harga-akomodasi-${index}`).value) || 0;
            const satuan = document.getElementById(`satuan-akomodasi-${index}`).value || 'pcs';
            const stok = parseInt(document.getElementById(`stok-akomodasi-${index}`).value) || 0;

            if (!nama) {
                alert('Nama Akomodasi harus diisi!');
                return;
            }

            dataApp.akomodasiLainnya[index].nama = nama;
            dataApp.akomodasiLainnya[index].harga = harga;
            dataApp.akomodasiLainnya[index].satuan = satuan;
            dataApp.akomodasiLainnya[index].stok = stok;
            
            saveToLocalStorage();
            alert(`Akomodasi ${nama} berhasil disimpan!`);
        }

        function hapusAkomodasi(index) {
            if (confirm('Apakah Anda yakin ingin menghapus akomodasi ini?')) {
                dataApp.akomodasiLainnya.splice(index, 1);
                generatePengaturanAkomodasi(); 
                saveToLocalStorage();
                alert('Akomodasi berhasil dihapus!');
            }
        }

        function tambahAkomodasi() {
            const newId = dataApp.akomodasiLainnya.length > 0 ? Math.max(...dataApp.akomodasiLainnya.map(a => a.id)) + 1 : 1;
            dataApp.akomodasiLainnya.push({
                id: newId,
                nama: "Akomodasi Baru",
                harga: 0,
                satuan: "pcs",
                stok: 0,
                status: 'tersedia',
                jumlah: 0
            });
            generatePengaturanAkomodasi();
            saveToLocalStorage();
        }
        
        // --- Admin Tools ---

        function hapusInvoiceBulanLalu() {
            if (!dataApp.user || dataApp.user.role !== 'admin') return;

            if (!confirm('PERINGATAN! Anda akan menghapus SEMUA data reservasi dan invoice dari bulan lalu. Tindakan ini tidak dapat dibatalkan. Lanjutkan?')) {
                return;
            }

            const today = new Date();
            const startOfThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const endOfLastMonth = new Date(startOfThisMonth.getTime() - 1); 

            const monthToDelete = endOfLastMonth.getMonth();
            const yearToDelete = endOfLastMonth.getFullYear();

            const newInvoiceList = dataApp.invoice.filter(inv => {
                const reservasiDate = new Date(inv.tanggalReservasi + 'T00:00:00');
                
                return reservasiDate.getMonth() !== monthToDelete || reservasiDate.getFullYear() !== yearToDelete;
            });
            
            const newReservasiList = dataApp.reservasi.filter(r => {
                const reservasiDate = new Date(r.tanggalReservasi + 'T00:00:00');
                
                return reservasiDate.getMonth() !== monthToDelete || reservasiDate.getFullYear() !== yearToDelete;
            });
            
            const deletedCount = dataApp.invoice.length - newInvoiceList.length;

            dataApp.invoice = newInvoiceList;
            dataApp.reservasi = newReservasiList;

            saveToLocalStorage();
            generateInvoiceList();
            filterLaporan();
            alert(`${deletedCount} data reservasi dan invoice dari bulan lalu berhasil dihapus.`);
        }

        function resetLapakHariIni() {
            if (!dataApp.user || dataApp.user.role !== 'admin') return;

            if (!confirm('Konfirmasi reset lapak/glamping Check-out hari ini? Status lapak akan diubah menjadi "tersedia" untuk reservasi yang sudah selesai/aktif hari ini.')) {
                return;
            }

            const today = formatDate(new Date());
            let resetCount = 0;

            const reservationsToReset = dataApp.reservasi.filter(r => 
                r.tanggalCheckout === today && (r.status === 'aktif' || r.status === 'dibayar')
            );

            reservationsToReset.forEach(r => {
                const allCodes = [...(r.lapak || []), ...(r.glamping || [])];
                allCodes.forEach(code => {
                    let item = dataApp.lapakTenda.find(l => l.kode === code);
                    if (!item) item = dataApp.glamping.find(g => g.kode === code);
                    
                    if (item && item.status !== 'tersedia') {
                        item.status = 'tersedia';
                        resetCount++;
                    }
                });
                
                const invoice = dataApp.invoice.find(inv => inv.invoice === r.invoice);
                if (invoice) {
                    invoice.status = 'selesai';
                    invoice.tanggalSelesai = today;
                }
                r.status = 'selesai';
            });

            saveToLocalStorage();
            updateDashboard();
            updateLapakVisualization();
            generateInvoiceList();
            alert(`${resetCount} lapak/glamping dari ${reservationsToReset.length} reservasi Check-out hari ini telah di-reset menjadi 'tersedia' dan status reservasi diubah menjadi 'selesai'.`);
        }

        // FITUR BARU: HAPUS INVOICE TERPILIH BERDASARKAN FILTER
        function previewInvoiceTerpilih() {
            const invoices = filterInvoicesForDeletion();
            const container = document.getElementById('preview-hapus-container');
            const tbody = document.getElementById('preview-hapus-list');
            const countElement = document.getElementById('preview-hapus-count');
            
            tbody.innerHTML = '';
            
            if (invoices.length === 0) {
                container.classList.add('hidden');
                alert('Tidak ada invoice yang sesuai dengan filter yang dipilih.');
                return;
            }
            
            invoices.forEach(invoice => {
                let statusBadge;
                if (invoice.status === 'pending') statusBadge = '<span class="badge badge-warning">Pending</span>';
                else if (invoice.status === 'dibayar') statusBadge = '<span class="badge badge-primary">Dibayar</span>';
                else if (invoice.status === 'aktif') statusBadge = '<span class="badge badge-success">Aktif</span>';
                else if (invoice.status === 'selesai') statusBadge = '<span class="badge badge-secondary">Selesai</span>';
                else statusBadge = '<span class="badge badge-danger">Dibatalkan</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${invoice.invoice}</td>
                    <td>${invoice.nama || ''}</td>
                    <td>${invoice.jenis ? invoice.jenis.charAt(0).toUpperCase() + invoice.jenis.slice(1) : ''}</td>
                    <td>${formatRupiah(invoice.totalBiaya || 0)}</td>
                    <td>${statusBadge}</td>
                    <td>${formatDateID(invoice.tanggalReservasi)}</td>
                `;
                tbody.appendChild(row);
            });
            
            countElement.textContent = invoices.length;
            container.classList.remove('hidden');
        }

        function filterInvoicesForDeletion() {
            const tanggalMulai = document.getElementById('hapus-filter-tanggal-mulai').value;
            const tanggalSelesai = document.getElementById('hapus-filter-tanggal-selesai').value;
            const jenis = document.getElementById('hapus-filter-jenis').value;
            const status = document.getElementById('hapus-filter-status').value;
            
            return dataApp.invoice.filter(invoice => {
                // Filter by date range
                if (tanggalMulai && tanggalSelesai) {
                    const invoiceDate = new Date(invoice.tanggalReservasi + 'T00:00:00');
                    const startDate = new Date(tanggalMulai + 'T00:00:00');
                    const endDate = new Date(tanggalSelesai + 'T00:00:00');
                    
                    if (invoiceDate < startDate || invoiceDate > endDate) {
                        return false;
                    }
                }
                
                // Filter by jenis
                if (jenis && invoice.jenis !== jenis) {
                    return false;
                }
                
                // Filter by status
                if (status && invoice.status !== status) {
                    return false;
                }
                
                return true;
            });
        }

        function hapusInvoiceTerpilih() {
            const konfirmasi = document.getElementById('hapus-konfirmasi').value;
            
            if (konfirmasi !== 'HAPUS') {
                alert('Harap ketik "HAPUS" di kolom konfirmasi untuk melanjutkan.');
                return;
            }
            
            const invoicesToDelete = filterInvoicesForDeletion();
            
            if (invoicesToDelete.length === 0) {
                alert('Tidak ada invoice yang sesuai dengan filter yang dipilih.');
                return;
            }
            
            if (!confirm(`PERINGATAN! Anda akan menghapus ${invoicesToDelete.length} invoice. Tindakan ini tidak dapat dibatalkan. Lanjutkan?`)) {
                return;
            }
            
            // Get invoice numbers to delete
            const invoiceNumbersToDelete = invoicesToDelete.map(inv => inv.invoice);
            
            // Delete from invoice array
            dataApp.invoice = dataApp.invoice.filter(inv => !invoiceNumbersToDelete.includes(inv.invoice));
            
            // Delete from reservasi array
            dataApp.reservasi = dataApp.reservasi.filter(res => !invoiceNumbersToDelete.includes(res.invoice));
            
            // Reset form
            document.getElementById('hapus-filter-tanggal-mulai').value = '';
            document.getElementById('hapus-filter-tanggal-selesai').value = '';
            document.getElementById('hapus-filter-jenis').value = '';
            document.getElementById('hapus-filter-status').value = '';
            document.getElementById('hapus-konfirmasi').value = '';
            document.getElementById('preview-hapus-container').classList.add('hidden');
            
            saveToLocalStorage();
            
            // Refresh all related displays
            generateInvoiceList();
            updateDashboard();
            updateLapakVisualization();
            filterLaporan();
            
            alert(`${invoicesToDelete.length} invoice berhasil dihapus.`);
        }

        // --- User Management ---

        function generateUsersList() {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '';
            
            dataApp.users.forEach(user => {
                let roleBadge;
                if (user.role === 'admin') roleBadge = '<span class="badge badge-admin">Admin</span>';
                else if (user.role === 'manager') roleBadge = '<span class="badge badge-manager">Manager</span>';
                else roleBadge = '<span class="badge badge-staff">Staff</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.nama}</td>
                    <td>${user.username}</td>
                    <td>${roleBadge}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="showUserModal(${user.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="hapusUser(${user.id})" ${dataApp.user.id === user.id ? 'disabled' : ''}>
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        document.getElementById('tambah-user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const nama = document.getElementById('new-nama').value.trim();
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value;
            const role = document.getElementById('new-role').value;
            
            if (!nama || !username || !password) {
                alert('Harap lengkapi semua field!');
                return;
            }
            
            if (dataApp.users.some(u => u.username === username)) {
                alert('Username sudah terdaftar. Harap gunakan username lain.');
                return;
            }
            
            const newId = dataApp.users.length > 0 ? Math.max(...dataApp.users.map(u => u.id)) + 1 : 1;
            
            dataApp.users.push({
                id: newId,
                nama: nama,
                username: username,
                password: password,
                role: role
            });

            saveToLocalStorage();
            generateUsersList();
            this.reset();
            alert('Pengguna baru berhasil ditambahkan!');
        });

        function showUserModal(userId) {
            const user = dataApp.users.find(u => u.id === userId);
            if (!user) return;
            
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-nama').value = user.nama;
            document.getElementById('edit-username').value = user.username;
            document.getElementById('edit-role').value = user.role;
            document.getElementById('edit-password').value = '';
            
            document.getElementById('user-modal').style.display = 'flex';
        }

        function closeUserModal() {
            document.getElementById('user-modal').style.display = 'none';
        }

        document.getElementById('edit-user-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const userId = parseInt(document.getElementById('edit-user-id').value);
            const nama = document.getElementById('edit-nama').value.trim();
            const password = document.getElementById('edit-password').value;
            const role = document.getElementById('edit-role').value;
            
            if (!nama) {
                alert('Nama harus diisi!');
                return;
            }
            
            const userIndex = dataApp.users.findIndex(u => u.id === userId);
            if (userIndex === -1) return;
            
            dataApp.users[userIndex].nama = nama;
            dataApp.users[userIndex].role = role;
            if (password) {
                dataApp.users[userIndex].password = password;
            }

            saveToLocalStorage();
            generateUsersList();
            closeUserModal();
            alert('Data pengguna berhasil diubah!');
        });
        
        function hapusUser(userId) {
            if (dataApp.user.id === userId) {
                alert('Anda tidak dapat menghapus akun Anda sendiri!');
                return;
            }
            
            if (confirm('Apakah Anda yakin ingin menghapus pengguna ini?')) {
                dataApp.users = dataApp.users.filter(u => u.id !== userId);
                saveToLocalStorage();
                generateUsersList();
                alert('Pengguna berhasil dihapus!');
            }
        }
        
        // --- Backup & Restore Functions ---
        
        function updateBackupCounts() {
            document.getElementById('count-reservasi').textContent = dataApp.reservasi.length;
            document.getElementById('count-lapak').textContent = dataApp.lapakTenda.length;
            document.getElementById('count-glamping').textContent = dataApp.glamping.length;
            document.getElementById('count-barang').textContent = dataApp.barangSewa.length;
            document.getElementById('count-akomodasi').textContent = dataApp.akomodasiLainnya.length;
            document.getElementById('count-users').textContent = dataApp.users.length;
        }

        function changeBackupTab(tabElement, target) {
            document.querySelectorAll('#backup-section .tabs .tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('#backup-section .tab-content').forEach(content => content.style.display = 'none');
            tabElement.classList.add('active');
            document.getElementById(`${target}-tab`).style.display = 'block';
            
            if (target === 'backup') {
                updateBackupCounts();
            }
        }
        
        function toggleRestoreMethod() {
            const method = document.getElementById('restore-method').value;
            const fileContainer = document.getElementById('restore-file-container');
            const textContainer = document.getElementById('restore-text-container');
            
            if (method === 'file') {
                fileContainer.classList.remove('hidden');
                textContainer.classList.add('hidden');
            } else {
                fileContainer.classList.add('hidden');
                textContainer.classList.remove('hidden');
            }
        }
        
        function backupData() {
            try {
                const backupData = {
                    reservasi: dataApp.reservasi,
                    invoice: dataApp.invoice,
                    lapakTenda: dataApp.lapakTenda,
                    glamping: dataApp.glamping,
                    barangSewa: dataApp.barangSewa,
                    akomodasiLainnya: dataApp.akomodasiLainnya,
                    pengaturan: dataApp.pengaturan,
                    users: dataApp.users,
                    backupDate: new Date().toISOString(),
                    version: '2025v12'
                };
                
                const password = document.getElementById('backup-password').value.trim();
                let backupString = JSON.stringify(backupData, null, 2);
                
                // Simple encryption if password provided
                if (password) {
                    backupString = btoa(backupString + '|' + password);
                }
                
                const blob = new Blob([backupString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
                a.download = `backup-bsa-${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Show success message
                const successMsg = document.getElementById('backup-success');
                const errorMsg = document.getElementById('backup-error');
                successMsg.classList.remove('hidden');
                errorMsg.classList.add('hidden');
                
                // Hide success message after 3 seconds
                setTimeout(() => {
                    successMsg.classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                console.error('Backup error:', error);
                const successMsg = document.getElementById('backup-success');
                const errorMsg = document.getElementById('backup-error');
                successMsg.classList.add('hidden');
                errorMsg.classList.remove('hidden');
            }
        }
        
        function copyBackupToClipboard() {
            try {
                const backupData = {
                    reservasi: dataApp.reservasi,
                    invoice: dataApp.invoice,
                    lapakTenda: dataApp.lapakTenda,
                    glamping: dataApp.glamping,
                    barangSewa: dataApp.barangSewa,
                    akomodasiLainnya: dataApp.akomodasiLainnya,
                    pengaturan: dataApp.pengaturan,
                    users: dataApp.users,
                    backupDate: new Date().toISOString(),
                    version: '2025v12'
                };
                
                const password = document.getElementById('backup-password').value.trim();
                let backupString = JSON.stringify(backupData, null, 2);
                
                // Simple encryption if password provided
                if (password) {
                    backupString = btoa(backupString + '|' + password);
                }
                
                navigator.clipboard.writeText(backupString)
                    .then(() => {
                        alert('Backup data berhasil disalin ke clipboard!');
                    })
                    .catch(err => {
                        console.error('Failed to copy:', err);
                        alert('Gagal menyalin data ke clipboard.');
                    });
                    
            } catch (error) {
                console.error('Backup copy error:', error);
                alert('Terjadi kesalahan saat membuat backup.');
            }
        }
        
        function restoreData() {
            const method = document.getElementById('restore-method').value;
            const password = document.getElementById('restore-password').value.trim();
            
            let backupString = '';
            
            if (method === 'file') {
                const fileInput = document.getElementById('backup-file');
                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('Pilih file backup terlebih dahulu!');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    backupString = e.target.result;
                    processRestore(backupString, password);
                };
                
                reader.onerror = function() {
                    showRestoreError('Gagal membaca file backup.');
                };
                
                reader.readAsText(file);
                
            } else if (method === 'text') {
                backupString = document.getElementById('backup-text').value.trim();
                if (!backupString) {
                    alert('Masukkan data backup terlebih dahulu!');
                    return;
                }
                
                processRestore(backupString, password);
            }
        }
        
        function processRestore(backupString, password) {
            try {
                let parsedData;
                
                // Check if data is encrypted (base64)
                if (backupString.includes('|') && backupString === atob(backupString)) {
                    // Not encrypted, try to parse directly
                    parsedData = JSON.parse(backupString);
                } else {
                    // Try to decode base64
                    try {
                        const decoded = atob(backupString);
                        if (password) {
                            const parts = decoded.split('|');
                            if (parts.length === 2 && parts[1] === password) {
                                parsedData = JSON.parse(parts[0]);
                            } else {
                                showRestoreError('Password backup salah!');
                                return;
                            }
                        } else {
                            // Try to parse without password
                            const parts = decoded.split('|');
                            if (parts.length === 2) {
                                showRestoreError('Backup ini dienkripsi dengan password. Masukkan password yang benar.');
                                return;
                            } else {
                                parsedData = JSON.parse(decoded);
                            }
                        }
                    } catch (e) {
                        // Not base64, try to parse as plain JSON
                        parsedData = JSON.parse(backupString);
                    }
                }
                
                // Validate backup data structure
                if (!parsedData || typeof parsedData !== 'object') {
                    showRestoreError('Format data backup tidak valid!');
                    return;
                }
                
                // Ask for confirmation
                if (!confirm(`PERINGATAN! Restore data akan menggantikan semua data yang ada. 
                
Data yang akan direstore:
- Reservasi: ${parsedData.reservasi ? parsedData.reservasi.length : 0}
- Invoice: ${parsedData.invoice ? parsedData.invoice.length : 0}
- Lapak Tenda: ${parsedData.lapakTenda ? parsedData.lapakTenda.length : 0}
- Glamping: ${parsedData.glamping ? parsedData.glamping.length : 0}

Lanjutkan?`)) {
                    return;
                }
                
                // Restore data
                dataApp.reservasi = parsedData.reservasi || [];
                dataApp.invoice = parsedData.invoice || [];
                dataApp.lapakTenda = parsedData.lapakTenda || dataApp.lapakTenda;
                dataApp.glamping = parsedData.glamping || dataApp.glamping;
                dataApp.barangSewa = parsedData.barangSewa || dataApp.barangSewa;
                dataApp.akomodasiLainnya = parsedData.akomodasiLainnya || dataApp.akomodasiLainnya;
                
                // Preserve current user if not in backup
                const currentUser = dataApp.user;
                dataApp.users = parsedData.users || dataApp.users;
                
                // Don't restore pengaturan if it might break the system
                if (parsedData.pengaturan) {
                    // Merge pengaturan carefully
                    dataApp.pengaturan = { ...dataApp.pengaturan, ...parsedData.pengaturan };
                    if (parsedData.pengaturan.perusahaan) {
                        dataApp.pengaturan.perusahaan = { 
                            ...dataApp.pengaturan.perusahaan, 
                            ...parsedData.pengaturan.perusahaan 
                        };
                    }
                }
                
                // Restore current user
                if (currentUser) {
                    const userExists = dataApp.users.some(u => u.id === currentUser.id);
                    if (!userExists) {
                        dataApp.users.push(currentUser);
                    }
                    dataApp.user = currentUser;
                }
                
                saveToLocalStorage();
                
                // Show success message
                const successMsg = document.getElementById('restore-success');
                const errorMsg = document.getElementById('restore-error');
                successMsg.classList.remove('hidden');
                errorMsg.classList.add('hidden');
                
                // Reset form
                document.getElementById('backup-file').value = '';
                document.getElementById('backup-text').value = '';
                document.getElementById('restore-password').value = '';
                
                // Reload the app
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('Restore error:', error);
                showRestoreError('Format data backup tidak valid atau rusak!');
            }
        }
        
        function showRestoreError(message) {
            const successMsg = document.getElementById('restore-success');
            const errorMsg = document.getElementById('restore-error');
            const errorMessage = document.getElementById('restore-error-message');
            
            successMsg.classList.add('hidden');
            errorMsg.classList.remove('hidden');
            errorMessage.textContent = message;
        }
        
        function resetSystemData() {
            const resetType = document.getElementById('reset-type').value;
            const konfirmasi = document.getElementById('reset-confirm').value;
            
            if (konfirmasi !== 'RESET') {
                alert('Harap ketik "RESET" di kolom konfirmasi untuk melanjutkan.');
                return;
            }
            
            let message = '';
            let resetFunction;
            
            if (resetType === 'all') {
                message = 'PERINGATAN! Anda akan menghapus SEMUA data sistem dan mengembalikan ke kondisi awal. Tindakan ini tidak dapat dibatalkan. Lanjutkan?';
                resetFunction = resetAllData;
            } else if (resetType === 'transactions') {
                message = 'Anda akan menghapus SEMUA data transaksi (reservasi dan invoice). Data master (lapak, glamping, barang) tetap ada. Lanjutkan?';
                resetFunction = resetTransactionData;
            } else if (resetType === 'products') {
                message = 'Anda akan menghapus SEMUA data master (lapak, glamping, barang) dan mengembalikan ke default. Data transaksi tetap ada. Lanjutkan?';
                resetFunction = resetProductData;
            }
            
            if (!confirm(message)) {
                return;
            }
            
            resetFunction();
        }
        
        function resetAllData() {
            // Save current user
            const currentUser = dataApp.user;
            
            // Reset to default data
            dataApp.reservasi = [];
            dataApp.invoice = [];
            dataApp.lapakTenda = [
                { kode: 'D01', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D02', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D03', harga: 0, kapasitas: 4, status: 'tersedia' },
            ];
            dataApp.glamping = [
                { kode: 'G01', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G02', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
            ];
            dataApp.barangSewa = [
                { id: 1, nama: "Tenda Dome Kapasitas 4", harga: 70000, satuan: "hari", stok: 15 },
                { id: 2, nama: "Sleeping Bag", harga: 10000, satuan: "hari", stok: 30 },
            ];
            dataApp.akomodasiLainnya = [
                { id: 1, nama: "Tenda Dome 3 Orang", harga: 60000, satuan: "unit", stok: 15, status: 'tersedia', jumlah: 0 },
                { id: 2, nama: "Kayu Bakar (1 pack)", harga: 10000, satuan: "pack", stok: 50, status: 'tersedia', jumlah: 0 },
            ];
            
            // Preserve current user
            if (currentUser) {
                dataApp.users = [
                    { id: 1, nama: currentUser.nama, username: currentUser.username, password: currentUser.password, role: currentUser.role },
                    { id: 2, nama: 'Staff Reservasi', username: 'staff', password: 'staff123', role: 'staff' },
                ];
                dataApp.user = currentUser;
            } else {
                dataApp.users = [
                    { id: 1, nama: 'Admin Utama', username: 'admin', password: 'admin123', role: 'admin' },
                    { id: 2, nama: 'Staff Reservasi', username: 'staff', password: 'staff123', role: 'staff' },
                ];
            }
            
            // Reset form
            document.getElementById('reset-confirm').value = '';
            
            saveToLocalStorage();
            alert('Sistem berhasil direset ke kondisi awal!');
            
            // Reload the app
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
        
        function resetTransactionData() {
            dataApp.reservasi = [];
            dataApp.invoice = [];
            
            // Reset form
            document.getElementById('reset-confirm').value = '';
            
            saveToLocalStorage();
            alert('Data transaksi berhasil direset!');
            
            // Update displays
            generateInvoiceList();
            updateDashboard();
            filterLaporan();
        }
        
        function resetProductData() {
            // Reset product data to defaults
            dataApp.lapakTenda = [
                { kode: 'D01', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D02', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D03', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D04', harga: 0, kapasitas: 4, status: 'tersedia' },
                { kode: 'D05', harga: 0, kapasitas: 4, status: 'tersedia' },
            ];
            dataApp.glamping = [
                { kode: 'G01', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G02', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
                { kode: 'G03', nama: 'Glamping Tipe A (4pax)', harga: 150000, kapasitas: 4, status: 'tersedia' },
            ];
            dataApp.barangSewa = [
                { id: 1, nama: "Tenda Dome Kapasitas 4", harga: 70000, satuan: "hari", stok: 15 },
                { id: 2, nama: "Sleeping Bag", harga: 10000, satuan: "hari", stok: 30 },
                { id: 3, nama: "Matras", harga: 5000, satuan: "hari", stok: 30 },
                { id: 4, nama: "Kompor Portable", harga: 15000, satuan: "hari", stok: 10 },
            ];
            dataApp.akomodasiLainnya = [
                { id: 1, nama: "Tenda Dome 3 Orang", harga: 60000, satuan: "unit", stok: 15, status: 'tersedia', jumlah: 0 },
                { id: 2, nama: "Kayu Bakar (1 pack)", harga: 10000, satuan: "pack", stok: 50, status: 'tersedia', jumlah: 0 },
                { id: 3, nama: "Kasur Lipat", harga: 15000, satuan: "unit", stok: 20, status: 'tersedia', jumlah: 0 },
                { id: 4, nama: "Nasi Liwet Porsi Keluarga", harga: 20000, satuan: "porsi", stok: 30, status: 'tersedia', jumlah: 0 },
            ];
            
            // Reset form
            document.getElementById('reset-confirm').value = '';
            
            saveToLocalStorage();
            alert('Data master produk berhasil direset ke default!');
            
            // Update displays
            generatePengaturanLapak();
            generatePengaturanGlamping();
            generatePengaturanBarang();
            generatePengaturanAkomodasi();
            updateDashboard();
        }

        // --- Global Event Listeners ---

        document.addEventListener('DOMContentLoaded', (event) => {
            // Load data from localStorage first
            loadFromLocalStorage();
            
            // Check Firebase connection
            checkFirebaseConnection();
            
            // Set today's date for date inputs
            const today = formatDate(new Date());
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });

            // Check if user is logged in
            if (dataApp.user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                initializeApp();
            } else {
                document.getElementById('login-screen').style.display = 'block';
                document.getElementById('main-app').style.display = 'none';
            }
            
            // Close modals when clicking outside
            window.onclick = function(event) {
                const invoiceModal = document.getElementById('invoice-modal');
                if (event.target === invoiceModal) {
                    closeInvoiceModal();
                }
                
                const userModal = document.getElementById('user-modal');
                if (event.target === userModal) {
                    closeUserModal();
                }
                
                const loadingModal = document.getElementById('loading-modal');
                if (event.target === loadingModal) {
                    hideLoadingModal();
                }
            };
            
            // Handle Enter key in forms
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.target.tagName === 'INPUT' && e.target.type !== 'button' && e.target.type !== 'submit') {
                    e.preventDefault();
                    // Don't submit on Enter to prevent accidental form submission
                }
            });
            
            // Close mobile menu when clicking outside
            document.addEventListener('click', function(e) {
                const nav = document.getElementById('main-nav');
                const menuToggle = document.querySelector('.menu-toggle');
                
                if (nav.classList.contains('active') && 
                    !nav.contains(e.target) && 
                    !menuToggle.contains(e.target)) {
                    nav.classList.remove('active');
                    const menuIcon = document.querySelector('.menu-toggle i');
                    menuIcon.classList.remove('fa-times');
                    menuIcon.classList.add('fa-bars');
                }
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                // Close mobile menu on larger screens
                if (window.innerWidth > 768) {
                    document.getElementById('main-nav').classList.remove('active');
                    const menuIcon = document.querySelector('.menu-toggle i');
                    if (menuIcon) {
                        menuIcon.classList.remove('fa-times');
                        menuIcon.classList.add('fa-bars');
                    }
                }
            });
            
            // Initialize event listeners
            document.getElementById('periode-laporan').addEventListener('change', toggleTanggalKustom);
            
            // Fix for mobile viewport height
            function setVH() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setVH();
            window.addEventListener('resize', setVH);
        });
    </script>
</body>
</html>